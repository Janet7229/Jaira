<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Top Students Leaderboard</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: auto; }
        h1, h2 { text-align: center; }
        .login-section { text-align: center; margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .login-section input, .login-section button { margin: 5px; }
        #leaderboard-list {
            list-style: none;
            padding: 0;
        }
        #leaderboard-list li {
            padding: 10px;
            margin-bottom: 5px;
            background: #f4f4f4;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #leaderboard-list li input[type="text"] {
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 3px;
            flex-grow: 1;
            margin-right: 10px;
        }
        #leaderboard-list li button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Top Students Leaderboard</h1>
        <div class="login-section" id="auth-controls">
            <input id="email" type="email" placeholder="Admin Email"/>
            <input id="password" type="password" placeholder="Password"/>
            <button id="login-btn">Login as Admin</button>
            <button id="logout-btn" style="display:none;">Logout</button>
            <p id="login-message"></p>
        </div>
        <div id="leaderboard-container">
            <h2>Loading Leaderboard...</h2>
        </div>
    </div>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
            authDomain: "shamankingdata.firebaseapp.com",
            projectId: "shamankingdata",
            storageBucket: "shamankingdata.appspot.com",
            messagingSenderId: "757444066890",
            appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let isAdmin = false;

        async function fetchAndRenderLeaderboard() {
            const leaderboardContainer = document.getElementById('leaderboard-container');
            leaderboardContainer.innerHTML = '<h2>Loading Leaderboard...</h2>';

            try {
                const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
                if (!answerKeyDoc.exists) {
                    leaderboardContainer.innerHTML = '<h2>No Answer Key Set</h2><p>An admin must set an answer key to display the leaderboard.</p>';
                    return;
                }
                const answerKey = answerKeyDoc.data();
                const numQuestions = Object.keys(answerKey).length;

                const responsesSnapshot = await db.collection('responses').get();
                const scores = [];
                responsesSnapshot.forEach(doc => {
                    const userAnswers = doc.data().answers;
                    let score = 0;
                    for (let i = 1; i <= numQuestions; i++) {
                        const itemKey = 'item' + i;
                        if (userAnswers[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
                            score++;
                        }
                    }
                    scores.push({ name: doc.data().name, score: score, userId: doc.id });
                });

                scores.sort((a, b) => b.score - a.score);
                const topStudents = scores.slice(0, 100); // Display top 100 students

                let html = '<h2>Top 100 Students</h2><ul id="leaderboard-list">';
                topStudents.forEach((student, index) => {
                    if (isAdmin) {
                        html += `<li>Rank #${index + 1}: <input type="text" value="${student.name}" data-userid="${student.userId}"/> Score: ${student.score} <button data-userid="${student.userId}">Save</button></li>`;
                    } else {
                        html += `<li>Rank #${index + 1}: ${student.name} - Score: ${student.score}</li>`;
                    }
                });
                html += '</ul>';
                leaderboardContainer.innerHTML = html;

                if (isAdmin) {
                    leaderboardContainer.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const userId = e.target.dataset.userid;
                            const newName = e.target.previousElementSibling.value;
                            await db.collection('responses').doc(userId).update({ name: newName });
                            alert('Name updated successfully!');
                        });
                    });
                }
            } catch (error) {
                console.error("Error fetching leaderboard data:", error);
                leaderboardContainer.innerHTML = `<h2>Error</h2><p>Could not load leaderboard: ${error.message}</p>`;
            }
        }

        auth.onAuthStateChanged(async user => {
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const loginMessage = document.getElementById('login-message');
            
            let newIsAdmin = false;
            if (user) {
                loginMessage.innerText = 'Logged in as ' + user.email;
                const adminDoc = await db.collection('admins').doc(user.uid).get();
                if (adminDoc.exists) {
                    newIsAdmin = true;
                }
            } else {
                loginMessage.innerText = '';
            }
            isAdmin = newIsAdmin;
            
            if (isAdmin) {
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline';
            } else {
                loginBtn.style.display = 'inline';
                logoutBtn.style.display = 'none';
            }
            
            fetchAndRenderLeaderboard();
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(e => {
                    document.getElementById('login-message').innerText = "Login failed: " + e.message;
                });
        });

        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

        window.onload = fetchAndRenderLeaderboard;
    </script>
</body>
</html>
