<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>THE RIGHT CHOICE</title>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>

Â  <style>
Â  Â  body {Â 
Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  background-color: #f8fafc;Â 
Â  Â  Â  Â  color: #1e293b;
Â  Â  }
    .container-box {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        margin-bottom: 1.5rem;
    }
    .btn {
        padding: 0.625rem 1.25rem;
        margin: 0.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background-color: #f9fafb;
    }
    .btn:hover {
        background-color: #f3f4f6;
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .btn.selected {
        background-color: #22c55e;
        color: white;
        border-color: #22c55e;
    }
    #submit-btn {
        background-color: #22c55e;
        color: white;
        font-weight: 600;
        border: none;
    }
    #submit-btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }
    #admin-panel {
        display: none;
        background-color: #fffff0;
        border: 1px solid #fef08a;
    }
    .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    .status-text {
        font-weight: 600;
        margin-left: 0.5rem;
    }
    .correct-answer {
        color: #ef4444;
        font-weight: 700;
    }
    .highlight {
        font-weight: 700;
    }
    .bar {
        color: #22c55e;
    }
    #results pre {
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
    }
Â  </style>
</head>

<body class="p-4 md:p-8">
Â  <div class="text-xs text-center text-gray-500 bg-yellow-200 p-2 rounded-md mb-4">
Â  Â  Version 1.2.0
Â  </div>
Â  <div class="container-box flex justify-center items-center">
    <svg class="w-48 h-auto" viewBox="0 0 100 40" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 40C9.40202 40 1 31.598 1 21C1 10.402 9.40202 2 20 2C30.598 2 39 10.402 39 21C39 31.598 30.598 40 20 40Z" stroke="#34D399" stroke-width="2"></path><path d="M80 40C69.402 40 61 31.598 61 21C61 10.402 69.402 2 80 2C90.598 2 99 10.402 99 21C99 31.598 90.598 40 80 40Z" stroke="#60A5FA" stroke-width="2"></path><path d="M50 30C41.7157 30 35 23.2843 35 15C35 6.71573 41.7157 0 50 0C58.2843 0 65 6.71573 65 15C65 23.2843 58.2843 30 50 30Z" stroke="#FBBF24" stroke-width="2"></path></svg>
Â  </div>

Â  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="top-controls-wrapper">
Â  Â  <div id="auth-section" class="container-box">
      <h3 class="font-bold text-lg mb-4">Admin Login</h3>
Â  Â  Â  <input id="email" type="email" placeholder="Admin Email" class="w-full p-2 border rounded-md mb-2"/>
Â  Â  Â  <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded-md mb-4"/>
Â  Â  Â  <button id="login-btn" class="btn w-full bg-blue-500 text-white hover:bg-blue-600">Login</button>
Â  Â  Â  <button id="logout-btn" class="btn w-full bg-red-500 text-white hover:bg-red-600" style="display:none;">Logout</button>
Â  Â  Â  <p id="login-message" class="mt-4 text-center"></p>
Â  Â  </div>
Â  Â  <div id="admin-panel" class="container-box">
Â  Â  Â  <h4 class="font-bold text-lg text-amber-600 mb-4">Admin Controls</h4>
      <div class="admin-grid">
        <div id="section-control-container">
    Â  Â  Â  Â  <label class="font-semibold">Current Section:</label>
    Â  Â  Â  Â  <input type="text" id="section-input" placeholder="e.g., Morning Session" class="w-full p-2 border rounded-md mt-1"/>
    Â  Â  Â  Â  <button id="save-section-btn" class="btn mt-2 w-full">Save Section</button>
    Â  Â  Â  Â  <span class="status-text" id="section-status"></span>
    Â  Â  </div>
        <div id="item-count-container">
    Â  Â  Â  Â  <label class="font-semibold">Questions to Show:</label>
    Â  Â  Â  Â  <input type="number" id="item-count-input" min="0" max="100" value="5" class="w-full p-2 border rounded-md mt-1"/>
    Â  Â  Â  Â  <button id="update-item-count" class="btn mt-2 w-full">Update Count</button>
    Â  Â  Â  Â  <span class="status-text" id="questions-count-status"></span>
    Â  Â  </div>
        <div id="top-students-count-container">
    Â  Â  Â  Â  <label class="font-semibold">Top Students to Show:</label>
    Â  Â  Â  Â  <input type="number" id="top-students-count-input" min="1" max="50" value="10" class="w-full p-2 border rounded-md mt-1"/>
    Â  Â  Â  Â  <button id="update-top-students-count" class="btn mt-2 w-full">Update Count</button>
    Â  Â  Â  Â  <span class="status-text" id="top-students-count-status"></span>
    Â  Â  </div>
        <div id="global-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="global-toggle" checked/> <strong>Enable Submissions</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="global-status"></span>
    Â  Â  </div>
        <div id="emoji-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="emoji-visibility-toggle" checked/> <strong>Show Emoji Reactions</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="emoji-status"></span>
    Â  Â  </div>
        <div id="star-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="star-visibility-toggle" checked/> <strong>Show Star Rating</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="star-status"></span>
    Â  Â  </div>
        <div id="yes-no-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="yes-no-visibility-toggle" checked/> <strong>Show Yes/No Survey</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="yes-no-status"></span>
    Â  Â  </div>
        <div id="summary-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="summary-visibility-toggle" checked/> <strong>Show Results Summary</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="summary-status"></span>
    Â  Â  </div>
        <div id="results-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="results-visibility-toggle" checked/> <strong>Show Raw Results</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="results-status"></span>
    Â  Â  </div>
        <div id="top-students-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="top-students-visibility-toggle" checked/> <strong>Show Top Students</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="top-students-status"></span>
    Â  Â  </div>
        <div id="my-score-toggle-container">
    Â  Â  Â  Â  <label><input type="checkbox" id="my-score-visibility-toggle" checked/> <strong>Show My Score</strong></label>
    Â  Â  Â  Â  <span class="status-text" id="my-score-status"></span>
    Â  Â  </div>
      </div>
      <div class="mt-6 pt-6 border-t border-amber-200 grid grid-cols-2 md:grid-cols-4 gap-2">
        <button id="reset-btn" class="btn">Reset Data</button>
        <button id="reset-emoji-btn" class="btn">Reset Emojis</button>
        <button id="reset-stars-btn" class="btn">Reset Stars</button>
        <button id="reset-yes-no-btn" class="btn">Reset Yes/No</button>Â 
        <button id="reset-keys-btn" class="btn">Reset Keys</button>
        <button id="reset-section-btn" class="btn">Reset Section</button>
        <button id="generate-users-btn" class="btn col-span-2 md:col-span-4">Generate 10 Test Users</button>
      </div>
Â  Â  </div>
Â  </div>

Â  <div id="interactive-widgets" class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div id="emoji-container" class="container-box">
    Â  Â  <div class="font-semibold mb-2">React with an emoji:</div>
    Â  Â  <div id="emoji-options" class="flex justify-around">
    Â  Â  Â  <button class="emoji-btn text-3xl" data-emoji="ğŸ‘">ğŸ‘ <span class="count text-sm">0</span></button>
    Â  Â  Â  <button class="emoji-btn text-3xl" data-emoji="â¤ï¸">â¤ï¸ <span class="count text-sm">0</span></button>
    Â  Â  Â  <button class="emoji-btn text-3xl" data-emoji="ğŸ˜‚">ğŸ˜‚ <span class="count text-sm">0</span></button>
    Â  Â  Â  <button class="emoji-btn text-3xl" data-emoji="ğŸ˜®">ğŸ˜® <span class="count text-sm">0</span></button>
    Â  Â  </div>
    Â  </div>
    Â Â 
    Â  <div id="star-rating-container" class="container-box">
    Â  Â  <div class="font-semibold mb-2">Rate your experience:</div>
    Â  Â  <div id="star-options" class="text-center">
    Â  Â  Â  <span class="star-btn text-4xl" data-rating="1">&#9734;</span>
    Â  Â  Â  <span class="star-btn text-4xl" data-rating="2">&#9734;</span>
    Â  Â  Â  <span class="star-btn text-4xl" data-rating="3">&#9734;</span>
    Â  Â  Â  <span class="star-btn text-4xl" data-rating="4">&#9734;</span>
    Â  Â  Â  <span class="star-btn text-4xl" data-rating="5">&#9734;</span>
    Â  Â  </div>
    Â  Â  <div id="star-rating-results" class="text-center mt-2 text-gray-600">Loading...</div>
    Â  </div>

    Â  <div id="yes-no-survey-container" class="container-box">
    Â  Â  <div class="font-semibold mb-2">Yes or No?</div>
    Â  Â  <div id="yes-no-options" class="flex justify-around">
    Â  Â  Â  <button class="yes-no-btn" data-choice="yes"><span class="icon mr-2">ğŸ‘</span> Yes <span class="count ml-2">0</span></button>
    Â  Â  Â  <button class="yes-no-btn" data-choice="no"><span class="icon mr-2">ğŸ‘</span> No <span class="count ml-2">0</span></button>
    Â  Â  </div>
    Â  </div>
  </div>

Â  <div id="survey-container" class="container-box"></div>
Â Â 
Â  <div id="submission-area" class="container-box">
    <div id="save-all-keys-container" style="display:none;" class="mb-4">
    Â  Â  <button id="save-all-keys-btn" class="btn w-full bg-amber-500 text-white hover:bg-amber-600">Save All Answer Keys</button>
    Â  </div>
    Â  <input type="text" id="name-input" placeholder="Your Name" required class="w-full max-w-md p-3 border rounded-md mb-4"/>
    Â  <button id="submit-btn" class="btn w-full max-w-md">Submit</button>
  </div>

Â  <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div id="results" class="container-box"></div>
    <div id="results-summary" class="container-box"></div>
    <div id="top-students-container" class="container-box"></div>
    <div id="my-score-container" class="container-box"></div>
  </div>

Â  <div id="download-container" class="container-box text-center" style="display: none;">
Â  Â  <button id="download-excel-btn" class="btn bg-green-600 text-white hover:bg-green-700">Download Results as Excel (CSV)</button>
Â  </div>


Â  <script>
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
Â  Â  Â  authDomain: "shamankingdata.firebaseapp.com",
Â  Â  Â  projectId: "shamankingdata",
Â  Â  Â  storageBucket: "shamankingdata.appspot.com",
Â  Â  Â  messagingSenderId: "757444066890",
Â  Â  Â  appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore(), auth = firebase.auth();

Â  Â  let isAdmin = false;
Â  Â  let submissionsGloballyEnabled = false;
Â  Â  let userHasSubmitted = false;
    let currentSection = ''; // Holds the current section name

Â  Â  function getUserId() {
Â  Â  Â  let uid = localStorage.getItem('userId');
Â  Â  Â  if (!uid) {
Â  Â  Â  Â  uid = 'user_' + Math.random().toString(36).substr(2,9);
Â  Â  Â  Â  localStorage.setItem('userId', uid);
Â  Â  Â  }
Â  Â  Â  return uid;
Â  Â  }
Â  Â  const userId = getUserId();
Â  Â Â 
Â  Â  // --- UTILITY FUNCTIONS ---
Â  Â  function disableSubmit(text='Already Submitted'){
Â  Â  Â  const btn=document.getElementById('submit-btn');
Â  Â  Â  btn.disabled=true; btn.innerText=text;
Â  Â  }
Â  Â  function enableSubmit(){
Â  Â  Â  const btn=document.getElementById('submit-btn');
Â  Â  Â  btn.disabled=false; btn.innerText='Submit';
Â  Â  }

Â  Â  async function updateSubmitButtonState() {
Â  Â  Â  const userDoc = await db.collection('responses').doc(userId).get();
Â  Â  Â  userHasSubmitted = userDoc.exists;

Â  Â  Â  if (!submissionsGloballyEnabled) {
Â  Â  Â  Â  disableSubmit('Submissions Disabled');
Â  Â  Â  } else if (userHasSubmitted) {
Â  Â  Â  Â  disableSubmit('Already Submitted');
Â  Â  Â  } else {
Â  Â  Â  Â  enableSubmit();
Â  Â  Â  }
Â  Â  }

Â  Â  // --- SURVEY LOGIC ---
Â  Â  function renderSurveyItems(count) {
Â  Â  Â  const container = document.getElementById('survey-container');
Â  Â  Â  const submissionArea = document.getElementById('submission-area');
Â  Â  Â  const saveAllKeysContainer = document.getElementById('save-all-keys-container');
Â  Â  Â  container.innerHTML = '';

Â  Â  Â  if (count > 0) {
        container.style.display = 'block';
Â  Â  Â  Â  submissionArea.style.display = 'block';
Â  Â  Â  Â  saveAllKeysContainer.style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  } else {
        container.style.display = 'none';
Â  Â  Â  Â  submissionArea.style.display = 'none';
Â  Â  Â  Â  saveAllKeysContainer.style.display = 'none';
Â  Â  Â  }

Â  Â  Â  for (let i = 1; i <= count; i++) {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'survey-item mb-4 pb-4 border-b';
Â  Â  Â  Â  div.dataset.item = i;
Â  Â  Â  Â  const inputStyle = isAdmin ? 'flex' : 'none';
Â  Â  Â  Â  div.innerHTML = `<div class="question-title font-semibold text-lg text-green-700">Question #${i}</div>
        <div class="flex flex-wrap items-center">
            <button class="btn" data-letter="A">A</button> <button class="btn" data-letter="B">B</button>
    Â  Â  Â  Â  <button class="btn" data-letter="C">C</button> <button class="btn" data-letter="D">D</button>
    Â  Â  Â  Â  <span class="admin-key-input-container ml-auto" style="display: ${inputStyle};">
    Â  Â  Â  Â  Â  Â  <input type="text" class="answer-key-input p-1 border rounded" data-item="${i}" placeholder="Key" maxlength="1">
    Â  Â  Â  Â  Â  Â  <button class="btn save-key-btn text-xs" data-item="${i}">Save</button>
    Â  Â  Â  Â  </span>
        </div>`;
Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  }
Â  Â  Â  document.querySelectorAll('.survey-item .btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  e.target.closest('.survey-item').querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
Â  Â  Â  Â  Â  e.target.classList.add('selected');
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  setupAnswerKeyListeners();
Â  Â  }
Â  Â Â 
Â  Â  function setupAnswerKeyListeners() {
Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  document.querySelectorAll('.save-key-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.addEventListener('click', async (e) => {
Â  Â  Â  Â  Â  Â  const item = 'item' + e.target.dataset.item;
Â  Â  Â  Â  Â  Â  const input = document.querySelector(`.answer-key-input[data-item="${e.target.dataset.item}"]`);
Â  Â  Â  Â  Â  Â  const value = input.value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  if (!['A', 'B', 'C', 'D', ''].includes(value)) {
Â  Â  Â  Â  Â  Â  Â  alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const docRef = db.collection('settings').doc('answerKey');
Â  Â  Â  Â  Â  Â  await docRef.set({ [item]: value }, { merge: true });
Â  Â  Â  Â  Â  Â  alert(`Answer key for Question #${e.target.dataset.item} saved!`);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function showAggregatedResults() {
Â  Â  Â  const settingsDoc = await db.collection('settings').doc('surveySettings').get();
Â  Â  Â  const visible = (settingsDoc.exists && settingsDoc.data().visibleItems !== undefined) ? settingsDoc.data().visibleItems : 5;
Â  Â  Â Â 
Â  Â  Â  const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  const answerKeyData = answerKeyDoc.exists ? answerKeyDoc.data() : {};

Â  Â  Â  const snapshot = await db.collection('responses').get();
Â  Â  Â  const counts = {};
Â  Â  Â  for (let i = 1; i <= visible; i++) { counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 }; }
Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  const ans = doc.data().answers;
Â  Â  Â  Â  Object.entries(ans).forEach(([k, v]) => { if (counts[k]?.[v] !== undefined) counts[k][v]++; });
Â  Â  Â  });
Â  Â  Â  let max = 1;
Â  Â  Â  Object.values(counts).forEach(c => Object.values(c).forEach(v => max = Math.max(max, v)));
Â  Â  Â  let html = '<h3 class="font-bold text-lg mb-4">Live Results:</h3><pre>';
Â  Â  Â  for (let i = 1; i <= visible; i++) {
Â  Â  Â  Â  const itm = counts['item' + i];
Â  Â  Â  Â  const m = Math.max(...Object.values(itm));
Â  Â  Â  Â  const correctAnswer = answerKeyData['item' + i];
Â  Â  Â  Â  html += `Item ${i}:\n`;
Â  Â  Â  Â  Object.entries(itm).forEach(([ltr, cnt]) => {
Â  Â  Â  Â  Â  const bar = `<span class="bar">${'â–ˆ'.repeat((cnt / max) * 20)}</span>`;
Â  Â  Â  Â  Â  let disp = ltr;
Â  Â  Â  Â  Â  let classes = [];

Â  Â  Â  Â  Â  if (cnt === m && cnt > 0) {
Â  Â  Â  Â  Â  Â  classes.push('highlight');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (ltr === correctAnswer) {
Â  Â  Â  Â  Â  Â  classes.push('correct-answer');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (classes.length > 0) {
Â  Â  Â  Â  Â  Â  disp = `<span class="${classes.join(' ')}">${ltr}</span>`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  html += `Â  ${disp}: ${cnt} ${bar}\n`;
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '<hr class="my-2 border-dashed">';
Â  Â  Â  }
Â  Â  Â  document.getElementById('results').innerHTML = html + '</pre>';

Â  Â  Â  const summaryData = [];
Â  Â  Â  for (let i = 1; i <= visible; i++) {
Â  Â  Â  Â  const itemCounts = counts['item' + i];
Â  Â  Â  Â  const correctAnswer = answerKeyData['item' + i];
Â  Â  Â  Â  if (!correctAnswer) continue;

Â  Â  Â  Â  const totalVotes = Object.values(itemCounts).reduce((sum, count) => sum + count, 0);
Â  Â  Â  Â  const correctVotes = itemCounts[correctAnswer] || 0;
Â  Â  Â  Â  const wrongVotes = totalVotes - correctVotes;
Â  Â  Â  Â Â 
Â  Â  Â  Â  summaryData.push({ questionNumber: i, wrongVotes: wrongVotes });
Â  Â  Â  }
Â  Â  Â  summaryData.sort((a, b) => b.wrongVotes - a.wrongVotes);

Â  Â  Â  let summaryHtml = '<h3 class="font-bold text-lg mb-4">Incorrect Answer Ranking:</h3>';
Â  Â  Â  if (summaryData.length === 0 || !answerKeyDoc.exists) {
Â  Â  Â  Â  summaryHtml += '<p>An answer key must be set by an admin to see this summary.</p>';
Â  Â  Â  } else {
Â  Â  Â  Â  summaryHtml += '<ol class="list-decimal list-inside">';
Â  Â  Â  Â  summaryData.forEach(item => {
Â  Â  Â  Â  Â  summaryHtml += `<li class="mb-2">Question #${item.questionNumber}: <strong>${item.wrongVotes}</strong> incorrect answer(s)</li>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  summaryHtml += '</ol>';
Â  Â  Â  }
Â  Â  Â  document.getElementById('results-summary').innerHTML = summaryHtml;

Â  Â  Â  showTopStudentsResults(snapshot, answerKeyData);
Â  Â  Â  showMyScore(answerKeyData);
Â  Â  }

Â  Â  async function showTopStudentsResults(snapshot, answerKey) {
Â  Â  Â  Â  const container = document.getElementById('top-students-container');
Â  Â  Â  Â  if (!answerKey || Object.keys(answerKey).length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h3 class="font-bold text-lg">Top Students</h3><p>An answer key must be set to display student scores.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const scores = [];
Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  const userAnswers = doc.data().answers;
Â  Â  Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  Â  Â  const numQuestions = Object.keys(answerKey).length;
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const itemKey = 'item' + i;
Â  Â  Â  Â  Â  Â  Â  Â  if (userAnswers[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  scores.push({ name: doc.data().name, score: score, userId: doc.id });
Â  Â  Â  Â  });

Â  Â  Â  Â  scores.sort((a, b) => b.score - a.score);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const topStudentsCountDoc = await db.collection('settings').doc('topStudentsCount').get();
Â  Â  Â  Â  const topN = (topStudentsCountDoc.exists && topStudentsCountDoc.data().count) ? topStudentsCountDoc.data().count : 10;
Â  Â  Â  Â  const topStudents = scores.slice(0, topN);

Â  Â  Â  Â  let html = `<h3 class="font-bold text-lg mb-4">Top ${topN} Students</h3><ul class="space-y-2">`;
Â  Â  Â  Â  topStudents.forEach((student, index) => {
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li class="flex items-center">Rank #${index + 1}: <input type="text" value="${student.name}" data-userid="${student.userId}" class="mx-2 p-1 border rounded"/> Score: ${student.score} <button data-userid="${student.userId}" class="btn text-xs ml-auto">Save</button></li>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li>Rank #${index + 1}: ${student.name} - Score: ${student.score}</li>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  container.innerHTML = html;

Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  container.querySelectorAll('button').forEach(btn => {
Â  Â  Â  Â  Â  Â  btn.addEventListener('click', async (e) => {
Â  Â  Â  Â  Â  Â  Â  const userId = e.target.dataset.userid;
Â  Â  Â  Â  Â  Â  Â  const newName = e.target.previousElementSibling.value;
Â  Â  Â  Â  Â  Â  Â  await db.collection('responses').doc(userId).update({ name: newName });
Â  Â  Â  Â  Â  Â  Â  alert('Name updated!');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function showMyScore(answerKey) {
Â  Â  Â  Â  const container = document.getElementById('my-score-container');
Â  Â  Â  Â  const userDoc = await db.collection('responses').doc(userId).get();
Â  Â  Â  Â  if (!userDoc.exists) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h3 class="font-bold text-lg">My Score</h3><p>Submit your answers to see your score.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userAnswers = userDoc.data().answers;
Â  Â  Â  Â  if (!answerKey || Object.keys(answerKey).length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h3 class="font-bold text-lg">My Score</h3><p>An answer key must be set to calculate your score.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  let summaryHtml = '<h3 class="font-bold text-lg">My Score</h3>';
Â  Â  Â  Â  let answerListHtml = '<ul class="space-y-2">';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sortedKeys = Object.keys(answerKey).sort((a, b) => {
Â  Â  Â  Â  Â  Â  const numA = parseInt(a.replace('item', ''), 10);
Â  Â  Â  Â  Â  Â  const numB = parseInt(b.replace('item', ''), 10);
Â  Â  Â  Â  Â  Â  return numA - numB;
Â  Â  Â  Â  });

Â  Â  Â  Â  sortedKeys.forEach((itemKey) => {
Â  Â  Â  Â  Â  Â  const questionNumber = parseInt(itemKey.replace('item', ''), 10);
Â  Â  Â  Â  Â  Â  const userAnswer = userAnswers[itemKey];
Â  Â  Â  Â  Â  Â  const correctAnswer = answerKey[itemKey];
Â  Â  Â  Â  Â  Â  let icon = 'âŒ';
Â  Â  Â  Â  Â  Â  let iconClass = 'text-red-500';

Â  Â  Â  Â  Â  Â  if (userAnswer && userAnswer === correctAnswer) {
Â  Â  Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  Â  Â  Â  icon = 'âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  iconClass = 'text-green-500';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  answerListHtml += `<li>Question #${questionNumber}: Your answer was ${userAnswer || 'N/A'} <span class="${iconClass} font-bold">${icon}</span></li>`;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  answerListHtml += '</ul>';
Â  Â  Â  Â  summaryHtml += `<p class="my-4 text-xl">Your Final Score: <strong>${score}</strong></p>`;
Â  Â  Â  Â  summaryHtml += `<h4 class="font-semibold mt-4">Answer Summary:</h4>`;
Â  Â  Â  Â  summaryHtml += answerListHtml;
Â  Â  Â  Â  container.innerHTML = summaryHtml;
Â  Â  }

Â  Â  async function generateTestUsers(numUsers) {
Â  Â  Â  if (!isAdmin) return;
Â  Â  Â Â 
Â  Â  Â  const settingsDoc = await db.collection('settings').doc('surveySettings').get();
Â  Â  Â  const visibleItems = (settingsDoc.exists && settingsDoc.data().visibleItems) || 5;
Â  Â  Â  const letters = ['A', 'B', 'C', 'D'];
Â  Â  Â  const batches = [];

Â  Â  Â  for (let i = 0; i < numUsers; i++) {
Â  Â  Â  Â  const userRef = db.collection('responses').doc('test_user_' + Date.now() + i);
Â  Â  Â  Â  const userName = 'Test User ' + (i + 1);
Â  Â  Â  Â  const answers = {};
Â  Â  Â  Â  for (let j = 1; j <= visibleItems; j++) {
Â  Â  Â  Â  Â  answers['item' + j] = letters[Math.floor(Math.random() * letters.length)];
Â  Â  Â  Â  }
Â  Â  Â  Â  batches.push(userRef.set({ name: userName, answers, section: "Test Section", timestamp: firebase.firestore.FieldValue.serverTimestamp() }));
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  await Promise.all(batches);
Â  Â  Â  alert(`${numUsers} test users generated.`);
Â  Â  }
Â  Â Â 
Â  Â  async function saveAllAnswerKeys() {
Â  Â  Â  Â  if (!isAdmin) return;
Â  Â  Â  Â  const answerKey = {};Â 
Â  Â  Â  Â  const validLetters = ['A', 'B', 'C', 'D', ''];Â 
Â  Â  Â  Â  let allValid = true;

Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  const item = 'item' + input.dataset.item;Â 
Â  Â  Â  Â  Â  Â  const value = input.value.trim().toUpperCase();

Â  Â  Â  Â  Â  Â  if (!validLetters.includes(value)) {
Â  Â  Â  Â  Â  Â  Â  Â  allValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
Â  Â  Â  Â  Â  Â  Â  Â  input.focus();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  answerKey[item] = value;
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!allValid) return;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await db.collection('settings').doc('answerKey').set(answerKey);
Â  Â  Â  Â  Â  Â  alert('Answer key for all questions saved successfully!');Â 
Â  Â  Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error('Error saving answer key:', e);Â 
Â  Â  Â  Â  Â  Â  alert('Failed to save answer key.');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function downloadResultsAsCSV() {
Â  Â  Â  Â  if (!isAdmin) {
Â  Â  Â  Â  Â  Â  alert('This feature is for admins only.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const responsesSnap = await db.collection('responses').get();
Â  Â  Â  Â  Â  Â  const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  Â  Â  Â  const surveySettingsDoc = await db.collection('settings').doc('surveySettings').get();

Â  Â  Â  Â  Â  Â  if (!answerKeyDoc.exists || Object.keys(answerKeyDoc.data()).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Cannot generate report. An answer key must be set first.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const answerKey = answerKeyDoc.data();
Â  Â  Â  Â  Â  Â  const numQuestions = surveySettingsDoc.exists ? surveySettingsDoc.data().visibleItems : Object.keys(answerKey).length;

Â  Â  Â  Â  Â  Â  let studentData = [];
Â  Â  Â  Â  Â  Â  responsesSnap.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  const response = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const userAnswers = response.answers || {};
Â  Â  Â  Â  Â  Â  Â  Â  let score = 0;

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemKey = 'item' + i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (answerKey[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  studentData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: response.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score: score,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  answers: userAnswers,
                        section: response.section
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  studentData.sort((a, b) => b.score - a.score);

Â  Â  Â  Â  Â  Â  const headers = ["Rank", "Name", "Section", "Total Score"];
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  headers.push(`Item ${i}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  let csvRows = [headers.join(",")];

Â  Â  Â  Â  Â  Â  studentData.forEach((student, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const rank = index + 1;
Â  Â  Â  Â  Â  Â  Â  Â  const name = `"${student.name.replace(/"/g, '""')}"`;
                const section = `"${(student.section || 'N/A').replace(/"/g, '""')}"`;
Â  Â  Â  Â  Â  Â  Â  Â  const row = [rank, name, section, student.score];

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemKey = 'item' + i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userAnswer = student.answers[itemKey] || "N/A";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const correctAnswer = answerKey[itemKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cellValue = userAnswer;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userAnswer !== "N/A" && correctAnswer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCorrect = userAnswer === correctAnswer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cellValue = `${userAnswer} (${isCorrect ? 'Correct' : 'Wrong'})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(`"${cellValue}"`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  csvRows.push(row.join(","));
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const csvString = csvRows.join("\r\n");
Â  Â  Â  Â  Â  Â  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);
Â  Â  Â  Â  Â  Â  link.setAttribute("download", "student_scores.csv");
Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error downloading CSV:", error);
Â  Â  Â  Â  Â  Â  alert("Failed to download results. See console for details.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- AUTH & INITIALIZATION ---
Â  Â  auth.onAuthStateChanged(async user => {
Â  Â  Â  const adminPanel = document.getElementById('admin-panel'); let newIsAdmin = false;
Â  Â  Â  if (user) {
Â  Â  Â  Â  document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
Â  Â  Â  Â  const adminDoc = await db.collection('admins').doc(user.uid).get();
Â  Â  Â  Â  if (adminDoc.exists) { newIsAdmin = true; }
Â  Â  Â  } else { document.getElementById('login-message').innerText = ''; }
Â  Â  Â  isAdmin = newIsAdmin;
Â  Â  Â  adminPanel.style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  document.getElementById('download-container').style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  document.getElementById('login-btn').style.display = isAdmin ? 'none' : 'inline-block';
Â  Â  Â  document.getElementById('logout-btn').style.display = isAdmin ? 'inline-block' : 'none';
Â  Â  Â  document.querySelectorAll('.admin-key-input-container').forEach(input => { input.style.display = isAdmin ? 'flex' : 'none'; });
Â  Â  Â  document.getElementById('save-all-keys-container').style.display = isAdmin ? 'block' : 'none';

Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  const keyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  Â  if (keyDoc.exists) {
Â  Â  Â  Â  Â  const keyData = keyDoc.data();
Â  Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  const itemKey = 'item' + input.dataset.item;
Â  Â  Â  Â  Â  Â  if (document.activeElement !== input) { input.value = keyData[itemKey] || ''; }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  setupAnswerKeyListeners();
Â  Â  });
Â  Â  document.getElementById('login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert("Login failed: " + e.message)));
Â  Â  document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

Â  Â  function setupRealtimeListeners() {
Â  Â  Â  db.collection('responses').onSnapshot(snapshot => {
Â  Â  Â  Â  const userDoc = snapshot.docs.find(doc => doc.id === userId);
Â  Â  Â  Â  userHasSubmitted = !!userDoc;
Â  Â  Â  Â  updateSubmitButtonState();
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('submissionControl').onSnapshot(doc => {
Â  Â  Â  Â  const isEnabled = doc.exists && doc.data().enabled === true;
Â  Â  Â  Â  submissionsGloballyEnabled = isEnabled;Â 
Â  Â  Â  Â  if (isAdmin) { document.getElementById('global-toggle').checked = isEnabled; }
Â  Â  Â  Â  document.getElementById('global-status').innerText = isEnabled ? 'ON' : 'OFF';
Â  Â  Â  });

        db.collection('settings').doc('sectionControl').onSnapshot(doc => {
            const sectionName = (doc.exists && doc.data().currentSection) ? doc.data().currentSection : '';
            currentSection = sectionName;
            document.getElementById('section-status').innerText = sectionName || 'N/A';
            if (isAdmin) {
                const sectionInput = document.getElementById('section-input');
                if (document.activeElement !== sectionInput) {
                    sectionInput.value = sectionName;
                }
            }
        });

Â  Â  Â  db.collection('settings').doc('surveySettings').onSnapshot(doc => {
Â  Â  Â  Â  const count = (doc.exists && doc.data().visibleItems !== undefined) ? doc.data().visibleItems : 5;
Â  Â  Â  Â  renderSurveyItems(count);
Â  Â  Â  Â  document.getElementById('questions-count-status').innerText = count;
Â  Â  Â  Â  if (isAdmin) { document.getElementById('item-count-input').value = count; }
Â  Â  Â  Â  setupAnswerKeyListeners();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('emojiSettings').onSnapshot(doc => {
Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
Â  Â  Â  Â  document.getElementById('interactive-widgets').style.display = (isAdmin || visible) ? 'grid' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('emoji-visibility-toggle').checked = !!visible; }
Â  Â  Â  Â  document.getElementById('emoji-status').innerText = visible ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('starRatingControl').onSnapshot(doc => {
Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
        // This is handled by the emojiSettings listener now, but we can keep the admin toggle logic
Â  Â  Â  Â  if (isAdmin) { document.getElementById('star-visibility-toggle').checked = !!visible; }
Â  Â  Â  Â  document.getElementById('star-status').innerText = visible ? 'ON' : 'OFF';
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('yesNoSettings').onSnapshot(doc => {
Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
        // This is handled by the emojiSettings listener now, but we can keep the admin toggle logic
Â  Â  Â  Â  if (isAdmin) { document.getElementById('yes-no-visibility-toggle').checked = !!visible; }
Â  Â  Â  Â  document.getElementById('yes-no-status').innerText = visible ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('summarySettings').onSnapshot(doc => {
Â  Â  Â  Â  const isVisible = doc.exists && doc.data().visible === true;
Â  Â  Â  Â  const topStudentsVisible = doc.exists && doc.data().topStudentsVisible === true;
Â  Â  Â  Â  const userScoreVisible = doc.exists && doc.data().userScoreVisible === true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('results-summary').style.display = (isAdmin || isVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('summary-visibility-toggle').checked = isVisible; }
Â  Â  Â  Â  document.getElementById('summary-status').innerText = isVisible ? 'ON' : 'OFF';
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('top-students-container').style.display = (isAdmin || topStudentsVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('top-students-visibility-toggle').checked = topStudentsVisible; }
Â  Â  Â  Â  document.getElementById('top-students-status').innerText = topStudentsVisible ? 'ON' : 'OFF';

Â  Â  Â  Â  document.getElementById('my-score-container').style.display = (isAdmin || userScoreVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('my-score-visibility-toggle').checked = userScoreVisible; }
Â  Â  Â  Â  document.getElementById('my-score-status').innerText = userScoreVisible ? 'ON' : 'OFF';
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('topStudentsCount').onSnapshot(doc => {
Â  Â  Â  Â  const count = (doc.exists && doc.data().count) ? doc.data().count : 10;
Â  Â  Â  Â  if (isAdmin) { document.getElementById('top-students-count-input').value = count; }
Â  Â  Â  Â  document.getElementById('top-students-count-status').innerText = count;
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('resultsSettings').onSnapshot(doc => {
Â  Â  Â  Â  const isVisible = doc.exists && doc.data().visible === true;
Â  Â  Â  Â  document.getElementById('results').style.display = (isAdmin || isVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('results-visibility-toggle').checked = isVisible; }
Â  Â  Â  Â  document.getElementById('results-status').innerText = isVisible ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('answerKey').onSnapshot(doc => {
Â  Â  Â  Â  if (isAdmin && doc.exists) {
Â  Â  Â  Â  Â  const answerKeyData = doc.data();
Â  Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  const itemKey = 'item' + input.dataset.item;
Â  Â  Â  Â  Â  Â  if (document.activeElement !== input) { input.value = answerKeyData[itemKey] || ''; }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('yesNoCounts').onSnapshot(doc => {
Â  Â  Â  Â  const counts = doc.data() || { yes: 0, no: 0 };
Â  Â  Â  Â  const yesCount = counts.yes || 0; const noCount = counts.no || 0;
Â  Â  Â  Â  document.querySelector('.yes-no-btn[data-choice="yes"] .count').innerText = yesCount;
Â  Â  Â  Â  document.querySelector('.yes-no-btn[data-choice="no"] .count').innerText = noCount;
Â  Â  Â  });
Â  Â  }

Â  Â  window.onload = () => {
Â  Â  Â  setupRealtimeListeners();
Â  Â  };
Â  </script>
</body>
</html>
