<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THE RIGHT CHOICE</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>

  <style>
    body { 
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc; 
        color: #1e293b;
    }
    .container-box {
        background-color: #ffffff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        margin-bottom: 1.5rem;
    }
    .btn {
        padding: 0.625rem 1.25rem;
        margin: 0.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid #d1d5db;
        background-color: #f9fafb;
    }
    .btn:hover {
        background-color: #f3f4f6;
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .btn.selected {
        background-color: #22c55e;
        color: white;
        border-color: #22c55e;
    }
    #submit-btn {
        background-color: #22c55e;
        color: white;
        font-weight: 600;
        border: none;
    }
    #submit-btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }
    #admin-panel {
        display: none;
        background-color: #fffff0;
        border: 1px solid #fef08a;
    }
    .admin-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }
    .status-text {
        font-weight: 600;
        margin-left: 0.5rem;
    }
    .correct-answer {
        color: #ef4444;
        font-weight: 700;
    }
    .highlight {
        font-weight: 700;
    }
    .bar {
        color: #22c55e;
    }
    #results pre {
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
    }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="text-xs text-center text-gray-500 bg-yellow-200 p-2 rounded-md mb-4">
    Version 1.2.0
  </div>
  <div class="container-box flex justify-center items-center">
    <svg class="w-48 h-auto" viewBox="0 0 100 40" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 40C9.40202 40 1 31.598 1 21C1 10.402 9.40202 2 20 2C30.598 2 39 10.402 39 21C39 31.598 30.598 40 20 40Z" stroke="#34D399" stroke-width="2"></path><path d="M80 40C69.402 40 61 31.598 61 21C61 10.402 69.402 2 80 2C90.598 2 99 10.402 99 21C99 31.598 90.598 40 80 40Z" stroke="#60A5FA" stroke-width="2"></path><path d="M50 30C41.7157 30 35 23.2843 35 15C35 6.71573 41.7157 0 50 0C58.2843 0 65 6.71573 65 15C65 23.2843 58.2843 30 50 30Z" stroke="#FBBF24" stroke-width="2"></path></svg>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6" id="top-controls-wrapper">
    <div id="auth-section" class="container-box">
      <h3 class="font-bold text-lg mb-4">Admin Login</h3>
      <input id="email" type="email" placeholder="Admin Email" class="w-full p-2 border rounded-md mb-2"/>
      <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded-md mb-4"/>
      <button id="login-btn" class="btn w-full bg-blue-500 text-white hover:bg-blue-600">Login</button>
      <button id="logout-btn" class="btn w-full bg-red-500 text-white hover:bg-red-600" style="display:none;">Logout</button>
      <p id="login-message" class="mt-4 text-center"></p>
    </div>
    <div id="admin-panel" class="container-box">
      <h4 class="font-bold text-lg text-amber-600 mb-4">Admin Controls</h4>
      <div class="admin-grid">
        <div id="section-control-container">
            <label class="font-semibold">Current Section:</label>
            <input type="text" id="section-input" placeholder="e.g., Morning Session" class="w-full p-2 border rounded-md mt-1"/>
            <button id="save-section-btn" class="btn mt-2 w-full">Save Section</button>
            <span class="status-text" id="section-status"></span>
        </div>
        <div id="item-count-container">
            <label class="font-semibold">Questions to Show:</label>
            <input type="number" id="item-count-input" min="0" max="100" value="5" class="w-full p-2 border rounded-md mt-1"/>
            <button id="update-item-count" class="btn mt-2 w-full">Update Count</button>
            <span class="status-text" id="questions-count-status"></span>
        </div>
        <div id="top-students-count-container">
            <label class="font-semibold">Top Students to Show:</label>
            <input type="number" id="top-students-count-input" min="1" max="50" value="10" class="w-full p-2 border rounded-md mt-1"/>
            <button id="update-top-students-count" class="btn mt-2 w-full">Update Count</button>
            <span class="status-text" id="top-students-count-status"></span>
        </div>
        <div id="global-toggle-container">
            <label><input type="checkbox" id="global-toggle" checked/> <strong>Enable Submissions</strong></label>
            <span class="status-text" id="global-status"></span>
        </div>
        <div id="emoji-toggle-container">
            <label><input type="checkbox" id="emoji-visibility-toggle" checked/> <strong>Show Emoji Reactions</strong></label>
            <span class="status-text" id="emoji-status"></span>
        </div>
        <div id="star-toggle-container">
            <label><input type="checkbox" id="star-visibility-toggle" checked/> <strong>Show Star Rating</strong></label>
            <span class="status-text" id="star-status"></span>
        </div>
        <div id="yes-no-toggle-container">
            <label><input type="checkbox" id="yes-no-visibility-toggle" checked/> <strong>Show Yes/No Survey</strong></label>
            <span class="status-text" id="yes-no-status"></span>
        </div>
        <div id="summary-toggle-container">
            <label><input type="checkbox" id="summary-visibility-toggle" checked/> <strong>Show Results Summary</strong></label>
            <span class="status-text" id="summary-status"></span>
        </div>
        <div id="results-toggle-container">
            <label><input type="checkbox" id="results-visibility-toggle" checked/> <strong>Show Raw Results</strong></label>
            <span class="status-text" id="results-status"></span>
        </div>
        <div id="top-students-toggle-container">
            <label><input type="checkbox" id="top-students-visibility-toggle" checked/> <strong>Show Top Students</strong></label>
            <span class="status-text" id="top-students-status"></span>
        </div>
        <div id="my-score-toggle-container">
            <label><input type="checkbox" id="my-score-visibility-toggle" checked/> <strong>Show My Score</strong></label>
            <span class="status-text" id="my-score-status"></span>
        </div>
      </div>
      <div class="mt-6 pt-6 border-t border-amber-200 grid grid-cols-2 md:grid-cols-4 gap-2">
        <button id="reset-btn" class="btn">Reset Data</button>
        <button id="reset-emoji-btn" class="btn">Reset Emojis</button>
        <button id="reset-stars-btn" class="btn">Reset Stars</button>
        <button id="reset-yes-no-btn" class="btn">Reset Yes/No</button> 
        <button id="reset-keys-btn" class="btn">Reset Keys</button>
        <button id="reset-section-btn" class="btn">Reset Section</button>
        <button id="generate-users-btn" class="btn col-span-2 md:col-span-4">Generate 10 Test Users</button>
      </div>
    </div>
  </div>

  <div id="interactive-widgets" class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div id="emoji-container" class="container-box">
        <div class="font-semibold mb-2">React with an emoji:</div>
        <div id="emoji-options" class="flex justify-around">
          <button class="emoji-btn text-3xl" data-emoji="👍">👍 <span class="count text-sm">0</span></button>
          <button class="emoji-btn text-3xl" data-emoji="❤️">❤️ <span class="count text-sm">0</span></button>
          <button class="emoji-btn text-3xl" data-emoji="😂">😂 <span class="count text-sm">0</span></button>
          <button class="emoji-btn text-3xl" data-emoji="😮">😮 <span class="count text-sm">0</span></button>
        </div>
      </div>
      
      <div id="star-rating-container" class="container-box">
        <div class="font-semibold mb-2">Rate your experience:</div>
        <div id="star-options" class="text-center">
          <span class="star-btn text-4xl" data-rating="1">&#9734;</span>
          <span class="star-btn text-4xl" data-rating="2">&#9734;</span>
          <span class="star-btn text-4xl" data-rating="3">&#9734;</span>
          <span class="star-btn text-4xl" data-rating="4">&#9734;</span>
          <span class="star-btn text-4xl" data-rating="5">&#9734;</span>
        </div>
        <div id="star-rating-results" class="text-center mt-2 text-gray-600">Loading...</div>
      </div>

      <div id="yes-no-survey-container" class="container-box">
        <div class="font-semibold mb-2">Yes or No?</div>
        <div id="yes-no-options" class="flex justify-around">
          <button class="yes-no-btn" data-choice="yes"><span class="icon mr-2">👍</span> Yes <span class="count ml-2">0</span></button>
          <button class="yes-no-btn" data-choice="no"><span class="icon mr-2">👎</span> No <span class="count ml-2">0</span></button>
        </div>
      </div>
  </div>

  <div id="survey-container" class="container-box"></div>
  
  <div id="submission-area" class="container-box">
    <div id="save-all-keys-container" style="display:none;" class="mb-4">
        <button id="save-all-keys-btn" class="btn w-full bg-amber-500 text-white hover:bg-amber-600">Save All Answer Keys</button>
      </div>
      <input type="text" id="name-input" placeholder="Your Name" required class="w-full max-w-md p-3 border rounded-md mb-4"/>
      <button id="submit-btn" class="btn w-full max-w-md">Submit</button>
  </div>

  <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div id="results" class="container-box"></div>
    <div id="results-summary" class="container-box"></div>
    <div id="top-students-container" class="container-box"></div>
    <div id="my-score-container" class="container-box"></div>
  </div>

  <div id="download-container" class="container-box text-center" style="display: none;">
    <button id="download-excel-btn" class="btn bg-green-600 text-white hover:bg-green-700">Download Results as Excel (CSV)</button>
  </div>


  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
      authDomain: "shamankingdata.firebaseapp.com",
      projectId: "shamankingdata",
      storageBucket: "shamankingdata.appspot.com",
      messagingSenderId: "757444066890",
      appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();

    let isAdmin = false;
    let submissionsGloballyEnabled = false;
    let userHasSubmitted = false;
    let currentSection = ''; // Holds the current section name

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }
    const userId = getUserId();
    
    // --- UTILITY FUNCTIONS ---
    function disableSubmit(text='Already Submitted'){
      const btn=document.getElementById('submit-btn');
      btn.disabled=true; btn.innerText=text;
    }
    function enableSubmit(){
      const btn=document.getElementById('submit-btn');
      btn.disabled=false; btn.innerText='Submit';
    }

    async function updateSubmitButtonState() {
      const userDoc = await db.collection('responses').doc(userId).get();
      userHasSubmitted = userDoc.exists;

      if (!submissionsGloballyEnabled) {
        disableSubmit('Submissions Disabled');
      } else if (userHasSubmitted) {
        disableSubmit('Already Submitted');
      } else {
        enableSubmit();
      }
    }

    // --- SURVEY LOGIC ---
    function renderSurveyItems(count) {
      const container = document.getElementById('survey-container');
      const submissionArea = document.getElementById('submission-area');
      const saveAllKeysContainer = document.getElementById('save-all-keys-container');
      container.innerHTML = '';

      if (count > 0) {
        container.style.display = 'block';
        submissionArea.style.display = 'block';
        saveAllKeysContainer.style.display = isAdmin ? 'block' : 'none';
      } else {
        container.style.display = 'none';
        submissionArea.style.display = 'none';
        saveAllKeysContainer.style.display = 'none';
      }

      for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'survey-item mb-4 pb-4 border-b';
        div.dataset.item = i;
        const inputStyle = isAdmin ? 'flex' : 'none';
        div.innerHTML = `<div class="question-title font-semibold text-lg text-green-700">Question #${i}</div>
        <div class="flex flex-wrap items-center">
            <button class="btn" data-letter="A">A</button> <button class="btn" data-letter="B">B</button>
            <button class="btn" data-letter="C">C</button> <button class="btn" data-letter="D">D</button>
            <span class="admin-key-input-container ml-auto" style="display: ${inputStyle};">
                <input type="text" class="answer-key-input p-1 border rounded" data-item="${i}" placeholder="Key" maxlength="1">
                <button class="btn save-key-btn text-xs" data-item="${i}">Save</button>
            </span>
        </div>`;
        container.appendChild(div);
      }
      document.querySelectorAll('.survey-item .btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.survey-item').querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
          e.target.classList.add('selected');
        });
      });
      setupAnswerKeyListeners();
    }
    
    function setupAnswerKeyListeners() {
      if (isAdmin) {
        document.querySelectorAll('.save-key-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const item = 'item' + e.target.dataset.item;
            const input = document.querySelector(`.answer-key-input[data-item="${e.target.dataset.item}"]`);
            const value = input.value.trim().toUpperCase();
            if (!['A', 'B', 'C', 'D', ''].includes(value)) {
              alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
              return;
            }
            const docRef = db.collection('settings').doc('answerKey');
            await docRef.set({ [item]: value }, { merge: true });
            alert(`Answer key for Question #${e.target.dataset.item} saved!`);
          });
        });
      }
    }
    
    async function showAggregatedResults() {
      const settingsDoc = await db.collection('settings').doc('surveySettings').get();
      const visible = (settingsDoc.exists && settingsDoc.data().visibleItems !== undefined) ? settingsDoc.data().visibleItems : 5;
      
      const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
      const answerKeyData = answerKeyDoc.exists ? answerKeyDoc.data() : {};

      const snapshot = await db.collection('responses').get();
      const counts = {};
      for (let i = 1; i <= visible; i++) { counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 }; }
      snapshot.forEach(doc => {
        const ans = doc.data().answers;
        Object.entries(ans).forEach(([k, v]) => { if (counts[k]?.[v] !== undefined) counts[k][v]++; });
      });
      let max = 1;
      Object.values(counts).forEach(c => Object.values(c).forEach(v => max = Math.max(max, v)));
      let html = '<h3 class="font-bold text-lg mb-4">Live Results:</h3><pre>';
      for (let i = 1; i <= visible; i++) {
        const itm = counts['item' + i];
        const m = Math.max(...Object.values(itm));
        const correctAnswer = answerKeyData['item' + i];
        html += `Item ${i}:\n`;
        Object.entries(itm).forEach(([ltr, cnt]) => {
          const bar = `<span class="bar">${'█'.repeat((cnt / max) * 20)}</span>`;
          let disp = ltr;
          let classes = [];

          if (cnt === m && cnt > 0) {
            classes.push('highlight');
          }
          if (ltr === correctAnswer) {
            classes.push('correct-answer');
          }
          
          if (classes.length > 0) {
            disp = `<span class="${classes.join(' ')}">${ltr}</span>`;
          }
          
          html += `  ${disp}: ${cnt} ${bar}\n`;
        });
        html += '<hr class="my-2 border-dashed">';
      }
      document.getElementById('results').innerHTML = html + '</pre>';

      const summaryData = [];
      for (let i = 1; i <= visible; i++) {
        const itemCounts = counts['item' + i];
        const correctAnswer = answerKeyData['item' + i];
        if (!correctAnswer) continue;

        const totalVotes = Object.values(itemCounts).reduce((sum, count) => sum + count, 0);
        const correctVotes = itemCounts[correctAnswer] || 0;
        const wrongVotes = totalVotes - correctVotes;
        
        summaryData.push({ questionNumber: i, wrongVotes: wrongVotes });
      }
      summaryData.sort((a, b) => b.wrongVotes - a.wrongVotes);

      let summaryHtml = '<h3 class="font-bold text-lg mb-4">Incorrect Answer Ranking:</h3>';
      if (summaryData.length === 0 || !answerKeyDoc.exists) {
        summaryHtml += '<p>An answer key must be set by an admin to see this summary.</p>';
      } else {
        summaryHtml += '<ol class="list-decimal list-inside">';
        summaryData.forEach(item => {
          summaryHtml += `<li class="mb-2">Question #${item.questionNumber}: <strong>${item.wrongVotes}</strong> incorrect answer(s)</li>`;
        });
        summaryHtml += '</ol>';
      }
      document.getElementById('results-summary').innerHTML = summaryHtml;

      showTopStudentsResults(snapshot, answerKeyData);
      showMyScore(answerKeyData);
    }

    async function showTopStudentsResults(snapshot, answerKey) {
        const container = document.getElementById('top-students-container');
        if (!answerKey || Object.keys(answerKey).length === 0) {
            container.innerHTML = '<h3 class="font-bold text-lg">Top Students</h3><p>An answer key must be set to display student scores.</p>';
            return;
        }

        const scores = [];
        snapshot.forEach(doc => {
            const userAnswers = doc.data().answers;
            let score = 0;
            const numQuestions = Object.keys(answerKey).length;
            for (let i = 1; i <= numQuestions; i++) {
                const itemKey = 'item' + i;
                if (userAnswers[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
                    score++;
                }
            }
            scores.push({ name: doc.data().name, score: score, userId: doc.id });
        });

        scores.sort((a, b) => b.score - a.score);
        
        const topStudentsCountDoc = await db.collection('settings').doc('topStudentsCount').get();
        const topN = (topStudentsCountDoc.exists && topStudentsCountDoc.data().count) ? topStudentsCountDoc.data().count : 10;
        const topStudents = scores.slice(0, topN);

        let html = `<h3 class="font-bold text-lg mb-4">Top ${topN} Students</h3><ul class="space-y-2">`;
        topStudents.forEach((student, index) => {
            if (isAdmin) {
                html += `<li class="flex items-center">Rank #${index + 1}: <input type="text" value="${student.name}" data-userid="${student.userId}" class="mx-2 p-1 border rounded"/> Score: ${student.score} <button data-userid="${student.userId}" class="btn text-xs ml-auto">Save</button></li>`;
            } else {
                html += `<li>Rank #${index + 1}: ${student.name} - Score: ${student.score}</li>`;
            }
        });
        html += '</ul>';
        container.innerHTML = html;

        if (isAdmin) {
          container.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const userId = e.target.dataset.userid;
              const newName = e.target.previousElementSibling.value;
              await db.collection('responses').doc(userId).update({ name: newName });
              alert('Name updated!');
            });
          });
        }
    }

    async function showMyScore(answerKey) {
        const container = document.getElementById('my-score-container');
        const userDoc = await db.collection('responses').doc(userId).get();
        if (!userDoc.exists) {
            container.innerHTML = '<h3 class="font-bold text-lg">My Score</h3><p>Submit your answers to see your score.</p>';
            return;
        }
        
        const userAnswers = userDoc.data().answers;
        if (!answerKey || Object.keys(answerKey).length === 0) {
            container.innerHTML = '<h3 class="font-bold text-lg">My Score</h3><p>An answer key must be set to calculate your score.</p>';
            return;
        }

        let score = 0;
        let summaryHtml = '<h3 class="font-bold text-lg">My Score</h3>';
        let answerListHtml = '<ul class="space-y-2">';
        
        const sortedKeys = Object.keys(answerKey).sort((a, b) => {
            const numA = parseInt(a.replace('item', ''), 10);
            const numB = parseInt(b.replace('item', ''), 10);
            return numA - numB;
        });

        sortedKeys.forEach((itemKey) => {
            const questionNumber = parseInt(itemKey.replace('item', ''), 10);
            const userAnswer = userAnswers[itemKey];
            const correctAnswer = answerKey[itemKey];
            let icon = '❌';
            let iconClass = 'text-red-500';

            if (userAnswer && userAnswer === correctAnswer) {
                score++;
                icon = '✅';
                iconClass = 'text-green-500';
            }
            answerListHtml += `<li>Question #${questionNumber}: Your answer was ${userAnswer || 'N/A'} <span class="${iconClass} font-bold">${icon}</span></li>`;
        });
        
        answerListHtml += '</ul>';
        summaryHtml += `<p class="my-4 text-xl">Your Final Score: <strong>${score}</strong></p>`;
        summaryHtml += `<h4 class="font-semibold mt-4">Answer Summary:</h4>`;
        summaryHtml += answerListHtml;
        container.innerHTML = summaryHtml;
    }

    async function generateTestUsers(numUsers) {
      if (!isAdmin) return;
      
      const settingsDoc = await db.collection('settings').doc('surveySettings').get();
      const visibleItems = (settingsDoc.exists && settingsDoc.data().visibleItems) || 5;
      const letters = ['A', 'B', 'C', 'D'];
      const batches = [];

      for (let i = 0; i < numUsers; i++) {
        const userRef = db.collection('responses').doc('test_user_' + Date.now() + i);
        const userName = 'Test User ' + (i + 1);
        const answers = {};
        for (let j = 1; j <= visibleItems; j++) {
          answers['item' + j] = letters[Math.floor(Math.random() * letters.length)];
        }
        batches.push(userRef.set({ name: userName, answers, section: "Test Section", timestamp: firebase.firestore.FieldValue.serverTimestamp() }));
      }
      
      await Promise.all(batches);
      alert(`${numUsers} test users generated.`);
    }
    
    async function saveAllAnswerKeys() {
        if (!isAdmin) return;
        const answerKey = {}; 
        const validLetters = ['A', 'B', 'C', 'D', '']; 
        let allValid = true;

        document.querySelectorAll('.answer-key-input').forEach(input => {
            const item = 'item' + input.dataset.item; 
            const value = input.value.trim().toUpperCase();

            if (!validLetters.includes(value)) {
                allValid = false;
                alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
                input.focus();
            }
            answerKey[item] = value;
        });

        if (!allValid) return;

        try {
            await db.collection('settings').doc('answerKey').set(answerKey);
            alert('Answer key for all questions saved successfully!'); 
            showAggregatedResults();
        } catch (e) {
            console.error('Error saving answer key:', e); 
            alert('Failed to save answer key.');
        }
    }

    async function downloadResultsAsCSV() {
        if (!isAdmin) {
            alert('This feature is for admins only.');
            return;
        }

        try {
            const responsesSnap = await db.collection('responses').get();
            const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
            const surveySettingsDoc = await db.collection('settings').doc('surveySettings').get();

            if (!answerKeyDoc.exists || Object.keys(answerKeyDoc.data()).length === 0) {
                alert('Cannot generate report. An answer key must be set first.');
                return;
            }

            const answerKey = answerKeyDoc.data();
            const numQuestions = surveySettingsDoc.exists ? surveySettingsDoc.data().visibleItems : Object.keys(answerKey).length;

            let studentData = [];
            responsesSnap.forEach(doc => {
                const response = doc.data();
                const userAnswers = response.answers || {};
                let score = 0;

                for (let i = 1; i <= numQuestions; i++) {
                    const itemKey = 'item' + i;
                    if (answerKey[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
                        score++;
                    }
                }
                studentData.push({
                    name: response.name,
                    score: score,
                    answers: userAnswers,
                        section: response.section
                });
            });

            studentData.sort((a, b) => b.score - a.score);

            const headers = ["Rank", "Name", "Section", "Total Score"];
            for (let i = 1; i <= numQuestions; i++) {
                headers.push(`Item ${i}`);
            }
            let csvRows = [headers.join(",")];

            studentData.forEach((student, index) => {
                const rank = index + 1;
                const name = `"${student.name.replace(/"/g, '""')}"`;
                const section = `"${(student.section || 'N/A').replace(/"/g, '""')}"`;
                const row = [rank, name, section, student.score];

                for (let i = 1; i <= numQuestions; i++) {
                    const itemKey = 'item' + i;
                    const userAnswer = student.answers[itemKey] || "N/A";
                    const correctAnswer = answerKey[itemKey];
                    let cellValue = userAnswer;

                    if (userAnswer !== "N/A" && correctAnswer) {
                        const isCorrect = userAnswer === correctAnswer;
                        cellValue = `${userAnswer} (${isCorrect ? 'Correct' : 'Wrong'})`;
                    }
                    row.push(`"${cellValue}"`);
                }
                csvRows.push(row.join(","));
            });

            const csvString = csvRows.join("\r\n");
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "student_scores.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error("Error downloading CSV:", error);
            alert("Failed to download results. See console for details.");
        }
    }

    // --- AUTH & INITIALIZATION ---
    auth.onAuthStateChanged(async user => {
      const adminPanel = document.getElementById('admin-panel'); let newIsAdmin = false;
      if (user) {
        document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (adminDoc.exists) { newIsAdmin = true; }
      } else { document.getElementById('login-message').innerText = ''; }
      isAdmin = newIsAdmin;
      adminPanel.style.display = isAdmin ? 'block' : 'none';
      document.getElementById('download-container').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('login-btn').style.display = isAdmin ? 'none' : 'inline-block';
      document.getElementById('logout-btn').style.display = isAdmin ? 'inline-block' : 'none';
      document.querySelectorAll('.admin-key-input-container').forEach(input => { input.style.display = isAdmin ? 'flex' : 'none'; });
      document.getElementById('save-all-keys-container').style.display = isAdmin ? 'block' : 'none';

      if (isAdmin) {
        const keyDoc = await db.collection('settings').doc('answerKey').get();
        if (keyDoc.exists) {
          const keyData = keyDoc.data();
          document.querySelectorAll('.answer-key-input').forEach(input => {
            const itemKey = 'item' + input.dataset.item;
            if (document.activeElement !== input) { input.value = keyData[itemKey] || ''; }
          });
        }
      }
      setupAnswerKeyListeners();
    });
    document.getElementById('login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert("Login failed: " + e.message)));
    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

    function setupRealtimeListeners() {
      db.collection('responses').onSnapshot(snapshot => {
        const userDoc = snapshot.docs.find(doc => doc.id === userId);
        userHasSubmitted = !!userDoc;
        updateSubmitButtonState();
        showAggregatedResults();
      });

      db.collection('settings').doc('submissionControl').onSnapshot(doc => {
        const isEnabled = doc.exists && doc.data().enabled === true;
        submissionsGloballyEnabled = isEnabled; 
        if (isAdmin) { document.getElementById('global-toggle').checked = isEnabled; }
        document.getElementById('global-status').innerText = isEnabled ? 'ON' : 'OFF';
      });

        db.collection('settings').doc('sectionControl').onSnapshot(doc => {
            const sectionName = (doc.exists && doc.data().currentSection) ? doc.data().currentSection : '';
            currentSection = sectionName;
            document.getElementById('section-status').innerText = sectionName || 'N/A';
            if (isAdmin) {
                const sectionInput = document.getElementById('section-input');
                if (document.activeElement !== sectionInput) {
                    sectionInput.value = sectionName;
                }
            }
        });

      db.collection('settings').doc('surveySettings').onSnapshot(doc => {
        const count = (doc.exists && doc.data().visibleItems !== undefined) ? doc.data().visibleItems : 5;
        renderSurveyItems(count);
        document.getElementById('questions-count-status').innerText = count;
        if (isAdmin) { document.getElementById('item-count-input').value = count; }
        setupAnswerKeyListeners();
      });

      db.collection('settings').doc('emojiSettings').onSnapshot(doc => {
        const visible = doc.exists && doc.data().visible;
        document.getElementById('interactive-widgets').style.display = (isAdmin || visible) ? 'grid' : 'none';
        if (isAdmin) { document.getElementById('emoji-visibility-toggle').checked = !!visible; }
        document.getElementById('emoji-status').innerText = visible ? 'ON' : 'OFF';
      });

      db.collection('settings').doc('starRatingControl').onSnapshot(doc => {
        const visible = doc.exists && doc.data().visible;
        // This is handled by the emojiSettings listener now, but we can keep the admin toggle logic
        if (isAdmin) { document.getElementById('star-visibility-toggle').checked = !!visible; }
        document.getElementById('star-status').innerText = visible ? 'ON' : 'OFF';
      });
      
      db.collection('settings').doc('yesNoSettings').onSnapshot(doc => {
        const visible = doc.exists && doc.data().visible;
        // This is handled by the emojiSettings listener now, but we can keep the admin toggle logic
        if (isAdmin) { document.getElementById('yes-no-visibility-toggle').checked = !!visible; }
        document.getElementById('yes-no-status').innerText = visible ? 'ON' : 'OFF';
      });

      db.collection('settings').doc('summarySettings').onSnapshot(doc => {
        const isVisible = doc.exists && doc.data().visible === true;
        const topStudentsVisible = doc.exists && doc.data().topStudentsVisible === true;
        const userScoreVisible = doc.exists && doc.data().userScoreVisible === true;
        
        document.getElementById('results-summary').style.display = (isAdmin || isVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('summary-visibility-toggle').checked = isVisible; }
        document.getElementById('summary-status').innerText = isVisible ? 'ON' : 'OFF';
        
        document.getElementById('top-students-container').style.display = (isAdmin || topStudentsVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('top-students-visibility-toggle').checked = topStudentsVisible; }
        document.getElementById('top-students-status').innerText = topStudentsVisible ? 'ON' : 'OFF';

        document.getElementById('my-score-container').style.display = (isAdmin || userScoreVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('my-score-visibility-toggle').checked = userScoreVisible; }
        document.getElementById('my-score-status').innerText = userScoreVisible ? 'ON' : 'OFF';
      });
      
      db.collection('settings').doc('topStudentsCount').onSnapshot(doc => {
        const count = (doc.exists && doc.data().count) ? doc.data().count : 10;
        if (isAdmin) { document.getElementById('top-students-count-input').value = count; }
        document.getElementById('top-students-count-status').innerText = count;
        showAggregatedResults();
      });

      db.collection('settings').doc('resultsSettings').onSnapshot(doc => {
        const isVisible = doc.exists && doc.data().visible === true;
        document.getElementById('results').style.display = (isAdmin || isVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('results-visibility-toggle').checked = isVisible; }
        document.getElementById('results-status').innerText = isVisible ? 'ON' : 'OFF';
      });

      db.collection('settings').doc('answerKey').onSnapshot(doc => {
        if (isAdmin && doc.exists) {
          const answerKeyData = doc.data();
          document.querySelectorAll('.answer-key-input').forEach(input => {
            const itemKey = 'item' + input.dataset.item;
            if (document.activeElement !== input) { input.value = answerKeyData[itemKey] || ''; }
          });
        }
        showAggregatedResults();
      });

      db.collection('settings').doc('yesNoCounts').onSnapshot(doc => {
        const counts = doc.data() || { yes: 0, no: 0 };
        const yesCount = counts.yes || 0; const noCount = counts.no || 0;
        document.querySelector('.yes-no-btn[data-choice="yes"] .count').innerText = yesCount;
        document.querySelector('.yes-no-btn[data-choice="no"] .count').innerText = noCount;
      });
    }

    window.onload = () => {
      setupRealtimeListeners();
    };
  </script>
</body>
</html>
