<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>THE RIGHT CHOICE</title>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-check-compat.js"></script>

Â  <style>
Â  Â  body {Â 
Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;Â 
Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  overflow-x: hidden;Â 
Â  Â  Â  Â  background-color: #f7f9fc;Â 
Â  Â  Â  Â  color: #333;
Â  Â  }
Â  Â  .container-box {
Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  }
Â  Â  .btn {Â 
Â  Â  Â  Â  padding: 10px 20px;Â 
Â  Â  Â  Â  margin: 5px;Â 
Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  background:#f0f0f0;Â 
Â  Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  transition: background-color 0.3s, transform 0.2s;
Â  Â  }
Â  Â  .btn:hover {
Â  Â  Â  Â  background-color: #e5e5e5;
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .btn.selected {Â 
Â  Â  Â  Â  background:#4CAF50;Â 
Â  Â  Â  Â  color:#fff;Â 
Â  Â  Â  Â  border-color: #4CAF50;
Â  Â  }
Â  Â  #submit-btn {
Â  Â  Â  Â  background-color: #4CAF50;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  border: none;
Â  Â  }
Â  Â  #submit-btn[disabled] {Â 
Â  Â  Â  Â  background:#ccc;Â 
Â  Â  Â  Â  color:#666;Â 
Â  Â  Â  Â  cursor:not-allowed;Â 
Â  Â  }
Â  Â  #results {Â 
Â  Â  Â  Â  padding:15px;Â 
Â  Â  Â  Â  background-color: #e8f5e9;
Â  Â  Â  Â  border: 1px solid #c8e6c9;
Â  Â  Â  Â  white-space:pre-wrap;Â 
Â  Â  Â  Â  font-family:monospace;Â 
Â  Â  }
Â  Â  .bar { color:#4CAF50; }
Â  Â  .highlight { font-weight:bold; }
Â  Â  .line { border-top:1px solid #e0e0e0; margin:15px 0; }
Â  Â  .question-title { color: #388e3c; font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
Â  Â  .admin-key-input-container {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .admin-key-input-container input {
Â  Â  Â  margin-right: 5px;
Â  Â  }

Â  Â  .emoji-btn {
Â  Â  Â  font-size: 28px;
Â  Â  Â  padding: 5px 10px;
Â  Â  Â  margin: 5px;
Â  Â  Â  background: #f0f0f0;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.2s;
Â  Â  }
Â  Â  .emoji-btn:hover {
Â  Â  Â  Â  transform: scale(1.1);
Â  Â  }
Â  Â  .emoji-btn.selected {
Â  Â  Â  transform: scale(1.2);
Â  Â  Â  box-shadow: 0 0 5px #ffc107;
Â  Â  }
Â  Â  .emoji-btn .count, .yes-no-btn .count {
Â  Â  Â  font-size: 14px;
Â  Â  Â  margin-left: 5px;
Â  Â  }
Â  Â Â 
Â  Â  @keyframes emoji-pop {
Â  Â  Â  0% { transform: scale(1); }
Â  Â  Â  50% { transform: scale(1.4); }
Â  Â  Â  100% { transform: scale(1); }
Â  Â  }

Â  Â  .emoji-btn.clicked-animation, .yes-no-btn.clicked-animation {
Â  Â  Â  animation: emoji-pop 0.4s ease-in-out;
Â  Â  }

Â  Â  #top-controls-wrapper {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 20px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  #auth-section {
Â  Â  Â  Â  background-color: #e3f2fd;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
Â  Â  Â  Â  border: 1px solid #bbdefb;
Â  Â  }
Â  Â  #admin-panel {
Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  background-color: #fffde7;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
Â  Â  Â  Â  border: 1px solid #ffe0b2;
Â  Â  }
Â  Â  #admin-panel h4 {
Â  Â  Â  Â  color: #ff6f00;
Â  Â  Â  Â  margin-top: 0;
Â  Â  }
Â  Â  #admin-panel button {
Â  Â  Â  display: block;
Â  Â  Â  margin: 8px 0;
Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  #admin-panel div {
Â  Â  Â  margin-top: 8px;
Â  Â  Â  padding: 5px 0;
Â  Â  Â  border-bottom: 1px dashed #e0e0e0;
Â  Â  }
Â  Â  #admin-panel div:last-of-type {
Â  Â  Â  Â  border-bottom: none;
Â  Â  }
Â  Â  .status-text {
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  color: #4CAF50;
Â  Â  }

Â  Â  /* Star Rating Styles */
Â  Â  #star-rating-container {
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  background-color: #fff9e6;
Â  Â  Â  Â  border: 1px solid #ffecb3;
Â  Â  }
Â  Â  .star-btn {
Â  Â  Â  color: #ccc;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 30px;
Â  Â  Â  transition: color 0.2s, transform 0.2s;
Â  Â  }
Â  Â  .star-btn:hover, .star-btn.selected {
Â  Â  Â  color: #ffb300;Â 
Â  Â  Â  transform: scale(1.2);
Â  Â  }
Â  Â  #star-rating-results {
Â  Â  Â  margin-top: 10px;
Â  Â  Â  font-style: italic;
Â  Â  Â  color: #555;
Â  Â  }

Â  Â  /* Yes/No Survey Styles */
Â  Â  #yes-no-survey-container {
Â  Â  Â  margin-top: 25px;Â 
Â  Â  }
Â  Â  .yes-no-btn {
Â  Â  Â  background: #f0f4c3;
Â  Â  Â  border: 1px solid #cddc39;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  margin: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 16px;Â 
Â  Â  Â  transition: transform 0.2s, background-color 0.2s;
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .yes-no-btn:not([disabled]):hover {
Â  Â  Â  background-color: #dce775;
Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .yes-no-btn .icon {
Â  Â  Â  display: inline-block;
Â  Â  Â  transition: transform 0.4s ease-out;
Â  Â  Â  margin-right: 8px;
Â  Â  Â  font-size: 20px;
Â  Â  }
Â  Â  .yes-no-btn.selected {
Â  Â  Â  background-color: #aed581;
Â  Â  Â  color: #333;Â 
Â  Â  }
Â  Â  .yes-no-btn.selected:hover {
Â  Â  Â  background-color: #aed581;
Â  Â  }
Â  Â  .yes-no-btn[disabled] {
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  opacity: 0.7;
Â  Â  }
Â  Â  .yes-no-btn[disabled]:hover {
Â  Â  Â  background: #f0f4c3;
Â  Â  }

Â  Â  @keyframes fly-across {
Â  Â  Â  from { transform: translate(0, 0); opacity: 1; }
Â  Â  Â  to { transform: translate(var(--end-x), var(--end-y)); opacity: 0; }
Â  Â  }
Â  Â  .flying-emoji {
Â  Â  Â  position: fixed; z-index: 9999; font-size: 24px; pointer-events: none;
Â  Â  Â  animation-name: fly-across;
Â  Â  Â  animation-timing-function: cubic-bezier(0.17, 0.84, 0.44, 1);
Â  Â  Â  animation-fill-mode: forwards;
Â  Â  }

Â  Â  .answer-key-input {
Â  Â  Â  width: 35px; margin-left: 15px; text-align: center; text-transform: uppercase;
Â  Â  Â  border: 1px solid #ccc; border-radius: 4px; padding: 4px;
Â  Â  }
Â  Â Â 
Â  Â  #name-input {
Â  Â  Â  padding: 12px;Â 
Â  Â  Â  font-size: 16px;Â 
Â  Â  Â  margin-top: 15px;Â 
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  display: block;Â 
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 300px;
Â  Â  }
Â  Â  #results-summary {
Â  Â  Â  padding: 15px;Â 
Â  Â  Â  background: #f0f4c3;Â 
Â  Â  Â  border: 1px solid #cddc39;
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  display: none;Â 
Â  Â  }
Â  Â  #results-summary h3 { margin-top: 0; color: #689f38; }
Â  Â  #results-summary ol { padding-left: 20px; }
Â  Â  #results-summary li { margin-bottom: 8px; }

Â  Â  .correct-answer {
Â  Â  Â  color: red;
Â  Â  Â  font-weight: bold;
Â  Â  }

Â  Â  #top-students-container, #my-score-container {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  padding: 20px;
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  border: 1px solid #bbdefb;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  display: none;
Â  Â  }
Â  Â  #top-students-container h3, #my-score-container h3 {
Â  Â  Â  margin-top: 0;
Â  Â  Â  color: #1565c0;
Â  Â  }
Â  Â  #top-students-container ul, #my-score-container ul {
Â  Â  Â  list-style: none;
Â  Â  Â  padding-left: 0;
Â  Â  }
Â  Â  #top-students-container li, #my-score-container li {
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .correct-icon { color: green; font-weight: bold; }
Â  Â  .incorrect-icon { color: red; font-weight: bold; }
Â  Â Â 
Â  </style>
</head>

<body>
Â  <div style="font-size: 14px; color: black; background: #ffeb3b; padding: 5px; margin-bottom: 10px; border-radius: 8px;">
Â  Â  Version 1.0.24
Â  </div>
Â  <div class="container-box">
Â  Â  <img src="RInew.jpg" width="350" height="165" style="display: block; margin: 0;"/>
Â  </div>

Â  <div class="container-box" id="top-controls-wrapper">
Â  Â  <div id="auth-section">
Â  Â  Â  <input id="email" type="email" placeholder="Admin Email"/>
Â  Â  Â  <input id="password" type="password" placeholder="Password"/>
Â  Â  Â  <button id="login-btn" class="btn">Login</button>
Â  Â  Â  <button id="logout-btn" class="btn" style="display:none;">Logout</button>
Â  Â  Â  <p id="login-message"></p>
Â  Â  </div>
Â  Â  <div id="admin-panel">
Â  Â  Â  <h4>Admin Controls</h4>
Â  Â  Â  <button id="reset-btn" class="btn">Reset Question Data</button>
Â  Â  Â  <button id="reset-emoji-btn" class="btn">Reset Emoji Counts</button>
Â  Â  Â  <button id="reset-stars-btn" class="btn">Reset Star Ratings</button>
Â  Â  Â  <button id="reset-yes-no-btn" class="btn">Reset Yes/No Survey</button>Â 
Â  Â  Â  <button id="reset-keys-btn" class="btn">Reset Answer Key</button>
Â  Â  Â  <div id="global-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="global-toggle" checked/> <strong>Enable Submissions</strong></label>
Â  Â  Â  Â  <span class="status-text" id="global-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="emoji-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="emoji-visibility-toggle" checked/> <strong>Show Emoji Reactions</strong></label>
Â  Â  Â  Â  <span class="status-text" id="emoji-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="star-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="star-visibility-toggle" checked/> <strong>Show Star Rating</strong></label>
Â  Â  Â  Â  <span class="status-text" id="star-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="yes-no-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="yes-no-visibility-toggle" checked/> <strong>Show Yes/No Survey</strong></label>
Â  Â  Â  Â  <span class="status-text" id="yes-no-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="summary-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="summary-visibility-toggle" checked/> <strong>Show Results Summary</strong></label>
Â  Â  Â  Â  <span class="status-text" id="summary-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="results-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="results-visibility-toggle" checked/> <strong>Show Raw Results</strong></label>
Â  Â  Â  Â  <span class="status-text" id="results-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="top-students-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="top-students-visibility-toggle" checked/> <strong>Show Top Students</strong></label>
Â  Â  Â  Â  <span class="status-text" id="top-students-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="my-score-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="my-score-visibility-toggle" checked/> <strong>Show My Score</strong></label>
Â  Â  Â  Â  <span class="status-text" id="my-score-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="item-count-container">
Â  Â  Â  Â  <label><strong>Questions to Show:</strong></label>
Â  Â  Â  Â  <input type="number" id="item-count-input" min="0" max="100" value="5" style="width: 50px;"/>
Â  Â  Â  Â  <button id="update-item-count" class="btn">Update</button>
Â  Â  Â  Â  <span class="status-text" id="questions-count-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="top-students-count-container">
Â  Â  Â  Â  <label><strong>Top Students to Show:</strong></label>
Â  Â  Â  Â  <input type="number" id="top-students-count-input" min="1" max="50" value="10" style="width: 50px;"/>
Â  Â  Â  Â  <button id="update-top-students-count" class="btn">Update</button>
Â  Â  Â  Â  <span class="status-text" id="top-students-count-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <button id="generate-users-btn" class="btn">Generate 10 Users</button>
Â  Â  </div>
Â  </div>

Â  <div id="emoji-container" class="container-box">
Â  Â  <div><strong>React with an emoji:</strong></div>
Â  Â  <div id="emoji-options">
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ˜®">ğŸ˜® <span class="count">0</span></button>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div id="star-rating-container" class="container-box">
Â  Â  <div><strong>Rate your experience:</strong></div>
Â  Â  <div id="star-options">
Â  Â  Â  <span class="star-btn" data-rating="1">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="2">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="3">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="4">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="5">&#9734;</span>
Â  Â  </div>
Â  Â  <div id="star-rating-results">Loading...</div>
Â  </div>

Â  <div id="yes-no-survey-container" class="container-box">
Â  Â  <div><strong>Yes or No?</strong></div>
Â  Â  <div id="yes-no-options">
Â  Â  Â  <button class="yes-no-btn" data-choice="yes"><span class="icon">ğŸ‘</span> Yes <span class="count">0</span></button>
Â  Â  Â  <button class="yes-no-btn" data-choice="no"><span class="icon">ğŸ‘</span> No <span class="count">0</span></button>
Â  Â  </div>
Â  </div>

Â  <div id="survey-container" class="container-box"></div>
Â Â 
Â  <div id="save-all-keys-container" style="display:none; margin-bottom: 15px;">
Â  Â  <button id="save-all-keys-btn" class="btn">Save All Answer Keys</button>
Â  </div>
Â  <input type="text" id="name-input" placeholder="Your Name" required />
Â  <button id="submit-btn" class="btn">Submit</button>

Â  <div id="results" class="container-box"></div>
Â  <div id="results-summary" class="container-box"></div>
Â  <div id="top-students-container" class="container-box"></div>
Â  <div id="my-score-container" class="container-box"></div>

Â  <div id="download-container" class="container-box" style="text-align: center; display: none;">
Â  Â  Â  <button id="download-excel-btn" class="btn">Download Results as Excel (CSV)</button>
Â  </div>


Â  <script>
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
Â  Â  Â  authDomain: "shamankingdata.firebaseapp.com",
Â  Â  Â  projectId: "shamankingdata",
Â  Â  Â  storageBucket: "shamankingdata.appspot.com",
Â  Â  Â  messagingSenderId: "757444066890",
Â  Â  Â  appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);

Â  Â  // --- ADD THIS CODE BLOCK to initialize App Check ---
Â  Â  try {
Â  Â  Â  Â  const appCheck = firebase.appCheck();
Â  Â  Â  Â  appCheck.activate(
Â  Â  Â  Â  Â  Â  // REMINDER: Put your real reCAPTCHA v3 site key here
Â  Â  Â  Â  Â  Â  'YOUR_RECAPTCHA_V3_SITE_KEY',
Â  Â  Â  Â  Â  Â  true // Automatic token refreshment.
Â  Â  Â  Â  );
Â  Â  Â  Â  console.log('Firebase App Check activated successfully.');
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error activating Firebase App Check:', error);
Â  Â  }
Â  Â  // --- END of App Check initialization ---

Â  Â  const db = firebase.firestore(), auth = firebase.auth();

Â  Â  let isAdmin = false;
Â  Â  let submissionsGloballyEnabled = false;
Â  Â  let userHasSubmitted = false;
Â  Â Â 
Â  Â  function getUserId() {
Â  Â  Â  let uid = localStorage.getItem('userId');
Â  Â  Â  if (!uid) {
Â  Â  Â  Â  uid = 'user_' + Math.random().toString(36).substr(2,9);
Â  Â  Â  Â  localStorage.setItem('userId', uid);
Â  Â  Â  }
Â  Â  Â  return uid;
Â  Â  }
Â  Â  const userId = getUserId();
Â  Â Â 
Â  Â  // --- UTILITY FUNCTIONS ---
Â  Â  function disableSubmit(text='Already Submitted'){
Â  Â  Â  const btn=document.getElementById('submit-btn');
Â  Â  Â  btn.disabled=true; btn.innerText=text;
Â  Â  }
Â  Â  function enableSubmit(){
Â  Â  Â  const btn=document.getElementById('submit-btn');
Â  Â  Â  btn.disabled=false; btn.innerText='Submit';
Â  Â  }

Â  Â  async function updateSubmitButtonState() {
Â  Â  Â  const userDoc = await db.collection('responses').doc(userId).get();
Â  Â  Â  userHasSubmitted = userDoc.exists;

Â  Â  Â  if (!submissionsGloballyEnabled) {
Â  Â  Â  Â  disableSubmit('Submissions Disabled');
Â  Â  Â  } else if (userHasSubmitted) {
Â  Â  Â  Â  disableSubmit('Already Submitted');
Â  Â  Â  } else {
Â  Â  Â  Â  enableSubmit();
Â  Â  Â  }
Â  Â  }

Â  Â  // --- SURVEY LOGIC ---
Â  Â  function renderSurveyItems(count) {
Â  Â  Â  const container = document.getElementById('survey-container');
Â  Â  Â  const submitBtn = document.getElementById('submit-btn');
Â  Â  Â  const saveAllKeysContainer = document.getElementById('save-all-keys-container');
Â  Â  Â  container.innerHTML = '';

Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  submitBtn.style.display = 'inline-block';
Â  Â  Â  Â  saveAllKeysContainer.style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  } else {
Â  Â  Â  Â  submitBtn.style.display = 'none';
Â  Â  Â  Â  saveAllKeysContainer.style.display = 'none';
Â  Â  Â  }

Â  Â  Â  for (let i = 1; i <= count; i++) {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'survey-item';
Â  Â  Â  Â  div.dataset.item = i;
Â  Â  Â  Â  const inputStyle = isAdmin ? 'flex' : 'none';
Â  Â  Â  Â  div.innerHTML = `<div class="question-title">Question #${i}</div>
Â  Â  Â  Â  Â  <button class="btn" data-letter="A">A</button> <button class="btn" data-letter="B">B</button>
Â  Â  Â  Â  Â  <button class="btn" data-letter="C">C</button> <button class="btn" data-letter="D">D</button>
Â  Â  Â  Â  Â  <span class="admin-key-input-container" style="display: ${inputStyle};">
Â  Â  Â  Â  Â  Â  <input type="text" class="answer-key-input" data-item="${i}" placeholder="Key" maxlength="1">
Â  Â  Â  Â  Â  Â  <button class="btn save-key-btn" data-item="${i}">Save</button>
Â  Â  Â  Â  Â  </span>`;
Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  }
Â  Â  Â  document.querySelectorAll('.survey-item .btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  e.target.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
Â  Â  Â  Â  Â  e.target.classList.add('selected');
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â  setupAnswerKeyListeners();
Â  Â  }
Â  Â Â 
Â  Â  function setupAnswerKeyListeners() {
Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  document.querySelectorAll('.save-key-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.addEventListener('click', async (e) => {
Â  Â  Â  Â  Â  Â  const item = 'item' + e.target.dataset.item;
Â  Â  Â  Â  Â  Â  const input = document.querySelector(`.answer-key-input[data-item="${e.target.dataset.item}"]`);
Â  Â  Â  Â  Â  Â  const value = input.value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  if (!['A', 'B', 'C', 'D', ''].includes(value)) {
Â  Â  Â  Â  Â  Â  Â  alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const docRef = db.collection('settings').doc('answerKey');
Â  Â  Â  Â  Â  Â  await docRef.set({ [item]: value }, { merge: true });
Â  Â  Â  Â  Â  Â  alert(`Answer key for Question #${e.target.dataset.item} saved!`);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function showAggregatedResults() {
Â  Â  Â  const settingsDoc = await db.collection('settings').doc('surveySettings').get();
Â  Â  Â  const visible = (settingsDoc.exists && settingsDoc.data().visibleItems !== undefined) ? settingsDoc.data().visibleItems : 5;
Â  Â  Â Â 
Â  Â  Â  const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  const answerKeyData = answerKeyDoc.exists ? answerKeyDoc.data() : {};

Â  Â  Â  const snapshot = await db.collection('responses').get();
Â  Â  Â  const counts = {};
Â  Â  Â  for (let i = 1; i <= visible; i++) { counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 }; }
Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  const ans = doc.data().answers;
Â  Â  Â  Â  Object.entries(ans).forEach(([k, v]) => { if (counts[k]?.[v] !== undefined) counts[k][v]++; });
Â  Â  Â  });
Â  Â  Â  let max = 1;
Â  Â  Â  Object.values(counts).forEach(c => Object.values(c).forEach(v => max = Math.max(max, v)));
Â  Â  Â  let html = '<h3>Results:</h3><pre>';
Â  Â  Â  for (let i = 1; i <= visible; i++) {
Â  Â  Â  Â  const itm = counts['item' + i];
Â  Â  Â  Â  const m = Math.max(...Object.values(itm));
Â  Â  Â  Â  const correctAnswer = answerKeyData['item' + i];
Â  Â  Â  Â  html += `Item ${i}:\n`;
Â  Â  Â  Â  Object.entries(itm).forEach(([ltr, cnt]) => {
Â  Â  Â  Â  Â  const bar = `<span class="bar">${'â–ˆ'.repeat((cnt / max) * 20)}</span>`;
Â  Â  Â  Â  Â  let disp = ltr;
Â  Â  Â  Â  Â  let classes = [];

Â  Â  Â  Â  Â  if (cnt === m && cnt > 0) {
Â  Â  Â  Â  Â  Â  classes.push('highlight');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (ltr === correctAnswer) {
Â  Â  Â  Â  Â  Â  classes.push('correct-answer');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (classes.length > 0) {
Â  Â  Â  Â  Â  Â  disp = `<span class="${classes.join(' ')}">${ltr}</span>`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  html += `Â  ${disp}: ${cnt} ${bar}\n`;
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</pre><div class="line"></div><pre>';
Â  Â  Â  }
Â  Â  Â  document.getElementById('results').innerHTML = html + '</pre>';

Â  Â  Â  const summaryData = [];
Â  Â  Â  for (let i = 1; i <= visible; i++) {
Â  Â  Â  Â  const itemCounts = counts['item' + i];
Â  Â  Â  Â  const correctAnswer = answerKeyData['item' + i];
Â  Â  Â  Â  if (!correctAnswer) continue;

Â  Â  Â  Â  const totalVotes = Object.values(itemCounts).reduce((sum, count) => sum + count, 0);
Â  Â  Â  Â  const correctVotes = itemCounts[correctAnswer] || 0;
Â  Â  Â  Â  const wrongVotes = totalVotes - correctVotes;
Â  Â  Â  Â Â 
Â  Â  Â  Â  summaryData.push({ questionNumber: i, wrongVotes: wrongVotes });
Â  Â  Â  }
Â  Â  Â  summaryData.sort((a, b) => b.wrongVotes - a.wrongVotes);

Â  Â  Â  let summaryHtml = '<h3>Ranking of Questions by Incorrect Answers:</h3>';
Â  Â  Â  if (summaryData.length === 0 || !answerKeyDoc.exists) {
Â  Â  Â  Â  summaryHtml += '<p>An answer key must be set by an admin to see this summary.</p>';
Â  Â  Â  } else {
Â  Â  Â  Â  summaryHtml += '<ol>';
Â  Â  Â  Â  summaryData.forEach(item => {
Â  Â  Â  Â  Â  summaryHtml += `<li>Question #${item.questionNumber}: <strong>${item.wrongVotes}</strong> incorrect answer(s)</li>`;
Â  Â  Â  Â  });
Â  Â  Â  Â  summaryHtml += '</ol>';
Â  Â  Â  }
Â  Â  Â  document.getElementById('results-summary').innerHTML = summaryHtml;

Â  Â  Â  showTopStudentsResults(snapshot, answerKeyData);
Â  Â  Â  showMyScore(answerKeyData);
Â  Â  }

Â  Â  async function showTopStudentsResults(snapshot, answerKey) {
Â  Â  Â  Â  const container = document.getElementById('top-students-container');
Â  Â  Â  Â  if (!answerKey || Object.keys(answerKey).length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h3>Top Students</h3><p>An answer key must be set to display student scores.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const scores = [];
Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  Â  const userAnswers = doc.data().answers;
Â  Â  Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  Â  Â  const numQuestions = Object.keys(answerKey).length;
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const itemKey = 'item' + i;
Â  Â  Â  Â  Â  Â  Â  Â  if (userAnswers[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  scores.push({ name: doc.data().name, score: score, userId: doc.id });
Â  Â  Â  Â  });

Â  Â  Â  Â  scores.sort((a, b) => b.score - a.score);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const topStudentsCountDoc = await db.collection('settings').doc('topStudentsCount').get();
Â  Â  Â  Â  const topN = (topStudentsCountDoc.exists && topStudentsCountDoc.data().count) ? topStudentsCountDoc.data().count : 10;
Â  Â  Â  Â  const topStudents = scores.slice(0, topN);

Â  Â  Â  Â  let html = `<h3>Top ${topN} Students</h3><ul>`;
Â  Â  Â  Â  topStudents.forEach((student, index) => {
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li>Rank #${index + 1}: <input type="text" value="${student.name}" data-userid="${student.userId}"/> Score: ${student.score} <button data-userid="${student.userId}">Save</button></li>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li>Rank #${index + 1}: ${student.name} - Score: ${student.score}</li>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  container.innerHTML = html;

Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  container.querySelectorAll('button').forEach(btn => {
Â  Â  Â  Â  Â  Â  btn.addEventListener('click', async (e) => {
Â  Â  Â  Â  Â  Â  Â  const userId = e.target.dataset.userid;
Â  Â  Â  Â  Â  Â  Â  const newName = e.target.previousElementSibling.value;
Â  Â  Â  Â  Â  Â  Â  await db.collection('responses').doc(userId).update({ name: newName });
Â  Â  Â  Â  Â  Â  Â  alert('Name updated!');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function showMyScore(answerKey) {
Â  Â  Â  Â  const container = document.getElementById('my-score-container');
Â  Â  Â  Â  const userDoc = await db.collection('responses').doc(userId).get();
Â  Â  Â  Â  if (!userDoc.exists) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h3>My Score</h3><p>Submit your answers to see your score.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userAnswers = userDoc.data().answers;
Â  Â  Â  Â  if (!answerKey || Object.keys(answerKey).length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<h3>My Score</h3><p>An answer key must be set to calculate your score.</p>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  let summaryHtml = '<h3>My Score</h3>';
Â  Â  Â  Â  let answerListHtml = '<ul>';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sortedKeys = Object.keys(answerKey).sort((a, b) => {
Â  Â  Â  Â  Â  Â  const numA = parseInt(a.replace('item', ''), 10);
Â  Â  Â  Â  Â  Â  const numB = parseInt(b.replace('item', ''), 10);
Â  Â  Â  Â  Â  Â  return numA - numB;
Â  Â  Â  Â  });

Â  Â  Â  Â  sortedKeys.forEach((itemKey, index) => {
Â  Â  Â  Â  Â  Â  const questionNumber = index + 1;
Â  Â  Â  Â  Â  Â  const userAnswer = userAnswers[itemKey];
Â  Â  Â  Â  Â  Â  const correctAnswer = answerKey[itemKey];
Â  Â  Â  Â  Â  Â  let icon = 'âŒ';
Â  Â  Â  Â  Â  Â  let iconClass = 'incorrect-icon';

Â  Â  Â  Â  Â  Â  if (userAnswer && userAnswer === correctAnswer) {
Â  Â  Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  Â  Â  Â  icon = 'âœ…';
Â  Â  Â  Â  Â  Â  Â  Â  iconClass = 'correct-icon';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  answerListHtml += `<li>Question #${questionNumber}: Your answer was ${userAnswer || 'N/A'} <span class="${iconClass}">${icon}</span></li>`;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  answerListHtml += '</ul>';
Â  Â  Â  Â  summaryHtml += `<p>Your Final Score: <strong>${score}</strong></p>`;
Â  Â  Â  Â  summaryHtml += `<h4>Answer Summary:</h4>`;
Â  Â  Â  Â  summaryHtml += answerListHtml;
Â  Â  Â  Â  container.innerHTML = summaryHtml;
Â  Â  }

Â  Â  async function generateTestUsers(numUsers) {
Â  Â  Â  if (!isAdmin) {
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const settingsDoc = await db.collection('settings').doc('surveySettings').get();
Â  Â  Â  const visibleItems = (settingsDoc.exists && settingsDoc.data().visibleItems) || 5;
Â  Â  Â  const letters = ['A', 'B', 'C', 'D'];
Â  Â  Â  const batches = [];

Â  Â  Â  for (let i = 0; i < numUsers; i++) {
Â  Â  Â  Â  const userRef = db.collection('responses').doc('test_user_' + Date.now() + i);
Â  Â  Â  Â  const userName = 'Test User ' + (i + 1);
Â  Â  Â  Â  const answers = {};
Â  Â  Â  Â  for (let j = 1; j <= visibleItems; j++) {
Â  Â  Â  Â  Â  answers['item' + j] = letters[Math.floor(Math.random() * letters.length)];
Â  Â  Â  Â  }
Â  Â  Â  Â  batches.push(userRef.set({ name: userName, answers, timestamp: firebase.firestore.FieldValue.serverTimestamp() }));
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  await Promise.all(batches);
Â  Â  Â  alert(`${numUsers} test users generated.`);
Â  Â  }
Â  Â Â 
Â  Â  async function saveAllAnswerKeys() {
Â  Â  Â  Â  if (!isAdmin) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const answerKey = {};Â 
Â  Â  Â  Â  const validLetters = ['A', 'B', 'C', 'D', ''];Â 
Â  Â  Â  Â  let allValid = true;

Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  const item = 'item' + input.dataset.item;Â 
Â  Â  Â  Â  Â  Â  const value = input.value.trim().toUpperCase();

Â  Â  Â  Â  Â  Â  if (!validLetters.includes(value)) {
Â  Â  Â  Â  Â  Â  Â  Â  allValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
Â  Â  Â  Â  Â  Â  Â  Â  input.focus();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  answerKey[item] = value;
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!allValid) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await db.collection('settings').doc('answerKey').set(answerKey);
Â  Â  Â  Â  Â  Â  alert('Answer key for all questions saved successfully!');Â 
Â  Â  Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error('Error saving answer key:', e);Â 
Â  Â  Â  Â  Â  Â  alert('Failed to save answer key.');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function downloadResultsAsCSV() {
Â  Â  Â  Â  if (!isAdmin) {
Â  Â  Â  Â  Â  Â  alert('This feature is for admins only.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const responsesSnap = await db.collection('responses').get();
Â  Â  Â  Â  Â  Â  const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  Â  Â  Â  const surveySettingsDoc = await db.collection('settings').doc('surveySettings').get();

Â  Â  Â  Â  Â  Â  if (!answerKeyDoc.exists || Object.keys(answerKeyDoc.data()).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Cannot generate report. An answer key must be set first.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const answerKey = answerKeyDoc.data();
Â  Â  Â  Â  Â  Â  const numQuestions = surveySettingsDoc.exists ? surveySettingsDoc.data().visibleItems : Object.keys(answerKey).length;

Â  Â  Â  Â  Â  Â  let studentData = [];
Â  Â  Â  Â  Â  Â  responsesSnap.forEach(doc => {
Â  Â  Â  Â  Â  Â  Â  Â  const response = doc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const userAnswers = response.answers || {};
Â  Â  Â  Â  Â  Â  Â  Â  let score = 0;

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemKey = 'item' + i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (answerKey[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  studentData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: response.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  score: score,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  answers: userAnswers
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  studentData.sort((a, b) => b.score - a.score);

Â  Â  Â  Â  Â  Â  const headers = ["Rank", "Name", "Total Score"];
Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  headers.push(`Item ${i}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  let csvRows = [headers.join(",")];

Â  Â  Â  Â  Â  Â  studentData.forEach((student, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const rank = index + 1;
Â  Â  Â  Â  Â  Â  Â  Â  const name = `"${student.name.replace(/"/g, '""')}"`;
Â  Â  Â  Â  Â  Â  Â  Â  const row = [rank, name, student.score];

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemKey = 'item' + i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userAnswer = student.answers[itemKey] || "N/A";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const correctAnswer = answerKey[itemKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let cellValue = userAnswer;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userAnswer !== "N/A" && correctAnswer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isCorrect = userAnswer === correctAnswer;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cellValue = `${userAnswer} (${isCorrect ? 'Correct' : 'Wrong'})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  row.push(`"${cellValue}"`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  csvRows.push(row.join(","));
Â  Â  Â  Â  Â  _BOS_ });

Â  Â  Â  Â  Â  Â  const csvString = csvRows.join("\r\n");
Â  Â  Â  Â  Â  Â  const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  const url = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  link.setAttribute("href", url);
Â  Â  Â  Â  Â  Â  link.setAttribute("download", "student_scores.csv");
Â  Â  Â  Â  Â  Â  link.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error downloading CSV:", error);
Â  Â  Â  Â  Â  Â  alert("Failed to download results. See console for details.");
Â  Â  Â  Â  }
Â  Â  }


Â  Â  function createFlyingEmojis(targetButton) {
Â  Â  Â  const rect = targetButton.getBoundingClientRect(); const emojiChar = targetButton.dataset.emoji; const particleCount = 15;Â 
Â  Â  Â  for (let i = 0; i < particleCount; i++) {
Â  Â  Â  Â  const particle = document.createElement('span'); particle.classList.add('flying-emoji'); particle.innerHTML = emojiChar;
Â  Â  Â  Â  const startX = rect.left + rect.width / 2; const startY = rect.top + rect.height / 2;
Â  Â  Â  Â  particle.style.left = `${startX}px`; particle.style.top = `${startY}px`;
Â  Â  Â  Â  const endX = (Math.random() - 0.5) * 2 * window.innerWidth; const endY = (Math.random() - 0.5) * 2 * window.innerHeight;
Â  Â  Â  Â  const duration = Math.random() * 1.5 + 1;
Â  Â  Â  Â  particle.style.setProperty('--end-x', `${endX}px`); particle.style.setProperty('--end-y', `${endY}px`); particle.style.animationDuration = `${duration}s`;
Â  Â  Â  Â  document.body.appendChild(particle);
Â  Â  Â  Â  setTimeout(() => { particle.remove(); }, duration * 1000);
Â  Â  Â  }
Â  Â  }
Â  Â  async function loadEmojiResults() {
Â  Â  Â  const snap = await db.collection('emojiReactions').get(); const counts = {};
Â  Â  Â  snap.forEach(doc => { counts[doc.data().emoji] = (counts[doc.data().emoji] || 0) + 1; });
Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => { btn.querySelector('.count').innerText = counts[btn.dataset.emoji] || 0; });
Â  Â  }
Â  Â  async function checkIfReacted() {
Â  Â  Â  const doc = await db.collection('emojiReactions').doc(userId).get();
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => { btn.dataset.emoji === doc.data().emoji ? btn.classList.add('selected') : btn.disabled = true; });
Â  Â  Â  }
Â  Â  }
Â  Â  async function handleEmojiClick(e) {
Â  Â  Â  const clickedButton = e.currentTarget; const doc = await db.collection('emojiReactions').doc(userId).get();
Â  Â  Â  if (doc.exists) return;
Â  Â  Â  createFlyingEmojis(clickedButton); clickedButton.classList.add('clicked-animation');
Â  Â  Â  clickedButton.addEventListener('animationend', () => clickedButton.classList.remove('clicked-animation'), { once: true });
Â  Â  Â  await db.collection('emojiReactions').doc(userId).set({ emoji: clickedButton.dataset.emoji, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  loadEmojiResults(); checkIfReacted();
Â  Â  }
Â  Â  function updateStarsUI(rating) {
Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => {
Â  Â  Â  Â  const isSelected = star.dataset.rating <= rating;
Â  Â  Â  Â  star.classList.toggle('selected', isSelected); star.innerHTML = isSelected ? '&#9733;' : '&#9734;';
Â  Â  Â  });
Â  Â  }
Â  Â  async function loadStarRatingResults() {
Â  Â  Â  const doc = await db.collection('settings').doc('starRatingControl').get();
Â  Â  Â  if (doc.exists && doc.data().totalRatings > 0) {
Â  Â  Â  Â  const { sumOfRatings = 0, totalRatings = 0 } = doc.data(); const avg = (sumOfRatings / totalRatings).toFixed(1); const avgRounded = Math.round(avg);
Â  Â  Â  Â  document.getElementById('star-rating-results').innerText = `Average: ${avg} (${totalRatings} ratings)`;
Â  Â  Â  Â  if (!document.querySelector('.star-btn[disabled]')) { updateStarsUI(avgRounded); }
Â  Â  Â  } else { document.getElementById('star-rating-results').innerText = 'No ratings yet.'; updateStarsUI(0); }
Â  Â  }
Â  Â  async function checkIfStarRated() {
Â  Â  Â  const doc = await db.collection('starRatings').doc(userId).get();
Â  Â  Â  if(doc.exists) {
Â  Â  Â  Â  const userRating = doc.data().rating; updateStarsUI(userRating);
Â  Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => star.setAttribute('disabled', true));
Â  Â  Â  }
Â  Â  }
Â  Â  async function handleStarClick(rating) {
Â  Â  Â  const starRatingRef = db.collection('starRatings').doc(userId); const userRatingDoc = await starRatingRef.get();
Â  Â  Â  if(userRatingDoc.exists) return;
Â  Â  Â  if (confirm(`You are about to submit a rating of ${rating} out of 5. Are you sure?`)) {
Â  Â  Â  Â  const settingsRef = db.collection('settings').doc('starRatingControl');
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  Â  const settingsDoc = await transaction.get(settingsRef); const { sumOfRatings = 0, totalRatings = 0 } = settingsDoc.data() || {};
Â  Â  Â  Â  Â  Â  transaction.set(starRatingRef, { rating, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  Â  Â  Â  transaction.set(settingsRef, { sumOfRatings: sumOfRatings + rating, totalRatings: totalRatings + 1 }, { merge: true });
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  checkIfStarRated(); loadStarRatingResults();
Â  Â  Â  Â  } catch (e) { console.error("Transaction failed: ", e); alert("Could not submit rating. Please try again."); }
Â  Â  Â  }
Â  Â  }
Â  Â  async function checkIfYesNoVoted() {
Â  Â  Â  const doc = await db.collection('yesNoVotes').doc(userId).get();
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  const choice = doc.data().choice;
Â  Â  Â  Â  document.querySelectorAll('.yes-no-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.disabled = true; if (btn.dataset.choice === choice) { btn.classList.add('selected'); }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  async function handleYesNoClick(e) {
Â  Â  Â  const clickedButton = e.currentTarget; clickedButton.classList.add('clicked-animation');
Â  Â  Â  clickedButton.addEventListener('animationend', () => { clickedButton.classList.remove('clicked-animation'); }, { once: true });
Â  Â  Â  const choice = clickedButton.dataset.choice; const voteRef = db.collection('yesNoVotes').doc(userId);
Â  Â  Â  const userVoteDoc = await voteRef.get(); if (userVoteDoc.exists) return;Â 
Â  Â  Â  const countsRef = db.collection('settings').doc('yesNoCounts');
Â  Â  Â  try {
Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  const countsDoc = await transaction.get(countsRef); const currentCounts = countsDoc.data() || { yes: 0, no: 0 };
Â  Â  Â  Â  Â  const newCounts = { ...currentCounts }; newCounts[choice]++;
Â  Â  Â  Â  Â  transaction.set(voteRef, { choice, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  Â  Â  transaction.set(countsRef, newCounts, { merge: true });
Â  Â  Â  Â  });
Â  Â  Â  Â  checkIfYesNoVoted();Â 
Â  Â  Â  } catch (error) { console.error("Transaction failed: ", error); alert("Your vote could not be cast. Please try again."); }
Â  Â  }

Â  Â  // --- ADMIN UTILITIES ---
Â  Â  async function resetData(collectionName, confirmationMsg) {
Â  Â  Â  if (!isAdmin || !confirm(confirmationMsg)) return;
Â  Â  Â  const snapshot = await db.collection(collectionName).get();
Â  Â  Â  if (snapshot.empty) return alert(`No data to delete in ${collectionName}.`);
Â  Â  Â  const batch = db.batch(); snapshot.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  await batch.commit(); alert(`${collectionName} data deleted.`);
Â  Â  }

Â  Â  // --- EVENT LISTENERS ---
Â  Â  document.getElementById('update-item-count').addEventListener('click', async () => {
Â  Â  Â  const count = parseInt(document.getElementById('item-count-input').value, 10);
Â  Â  Â  if (count < 0 || count > 100) return alert("Enter a number between 0 and 100.");
Â  Â  Â  await db.collection('settings').doc('surveySettings').set({ visibleItems: count }, { merge: true });
Â  Â  Â  alert(`Visible items updated to ${count}`);
Â  Â  });
Â  Â Â 
Â  Â  document.getElementById('update-top-students-count').addEventListener('click', async () => {
Â  Â  Â  const count = parseInt(document.getElementById('top-students-count-input').value, 10);
Â  Â  Â  if (count < 1 || count > 50) return alert("Enter a number between 1 and 50.");
Â  Â  Â  await db.collection('settings').doc('topStudentsCount').set({ count: count }, { merge: true });
Â  Â  Â  alert(`Top students count updated to ${count}`);
Â  Â  });
Â  Â Â 
Â  Â  document.getElementById('reset-keys-btn').addEventListener('click', async () => {
Â  Â  Â  if (!isAdmin) return;
Â  Â  Â  if (!confirm('Are you sure you want to reset the entire answer key? This action cannot be undone.')) { return; }
Â  Â  Â  try {
Â  Â  Â  Â  await db.collection('settings').doc('answerKey').delete();
Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => { input.value = ''; });
Â  Â  Â  Â  alert('Answer key has been successfully reset.'); showAggregatedResults();
Â  Â  Â  } catch (e) { console.error('Error resetting answer key:', e); alert('Failed to reset the answer key.'); }
Â  Â  });
Â  Â Â 
Â  Â  document.getElementById('save-all-keys-btn').addEventListener('click', saveAllAnswerKeys);

Â  Â  document.getElementById('global-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('submissionControl').set({ enabled: e.target.checked }); });
Â  Â  document.getElementById('emoji-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('emojiSettings').set({ visible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('star-visibility-toggle').addEventListener('change', async (e) => { if(isAdmin) await db.collection('settings').doc('starRatingControl').set({ visible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('yes-no-visibility-toggle').addEventListener('change', async (e) => { if(isAdmin) await db.collection('settings').doc('yesNoSettings').set({ visible: e.target.checked }, { merge: true }); });Â 
Â  Â  document.getElementById('summary-toggle-container').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('summarySettings').set({ visible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('results-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('resultsSettings').set({ visible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('top-students-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('summarySettings').set({ topStudentsVisible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('my-score-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('summarySettings').set({ userScoreVisible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('generate-users-btn').addEventListener('click', async () => { await generateTestUsers(10); showAggregatedResults(); });
Â  Â  document.getElementById('download-excel-btn').addEventListener('click', downloadResultsAsCSV);

Â  Â  document.getElementById('reset-btn').addEventListener('click', () => resetData('responses', 'Delete all question data?'));
Â  Â  document.getElementById('reset-emoji-btn').addEventListener('click', () => { resetData('emojiReactions', 'Delete all emoji reactions?').then(loadEmojiResults); });
Â  Â  document.getElementById('reset-stars-btn').addEventListener('click', async () => {
Â  Â  Â  await resetData('starRatings', 'Delete all star ratings?');
Â  Â  Â  await db.collection('settings').doc('starRatingControl').set({ sumOfRatings: 0, totalRatings: 0 }, { merge: true });
Â  Â  Â  updateStarsUI(0); loadStarRatingResults();
Â  Â  });
Â  Â  document.getElementById('reset-yes-no-btn').addEventListener('click', async () => {
Â  Â  Â  await resetData('yesNoVotes', 'Delete all Yes/No survey votes?');
Â  Â  Â  await db.collection('settings').doc('yesNoCounts').set({ yes: 0, no: 0 });
Â  Â  });
Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => btn.addEventListener('click', handleEmojiClick));
Â  Â  document.querySelectorAll('.star-btn').forEach(star => {
Â  Â  Â  star.addEventListener('click', (e) => handleStarClick(parseInt(e.target.dataset.rating)));
Â  Â  Â  star.addEventListener('mouseover', (e) => { if (e.target.hasAttribute('disabled')) return; updateStarsUI(e.target.dataset.rating); });
Â  Â  });
Â  Â  document.getElementById('star-options').addEventListener('mouseout', () => { if (!document.querySelector('.star-btn[disabled]')) { loadStarRatingResults(); } });
Â  Â  document.querySelectorAll('.yes-no-btn').forEach(btn => btn.addEventListener('click', handleYesNoClick));

Â  Â  document.getElementById('submit-btn').addEventListener('click', async () => {
Â  Â  Â  if (!submissionsGloballyEnabled) return alert("Submissions are currently disabled.");
Â  Â  Â  const doc = await db.collection('responses').doc(userId).get();
Â  Â  Â  if (doc.exists) return alert("You have already submitted.");
Â  Â  Â  const nameInput = document.getElementById('name-input'); const userName = nameInput.value.trim();
Â  Â  Â  if (!userName) { alert('Please enter your name before submitting.'); nameInput.focus(); return; }
Â  Â  Â  const answers = {}; const items = document.querySelectorAll('.survey-item'); let allAnswered = true;
Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  const sel = item.querySelector('.btn.selected');
Â  Â  Â  Â  if (sel) answers['item' + item.dataset.item] = sel.dataset.letter; else allAnswered = false;
Â  Â  Â  });
Â  Â  Â  if (items.length > 0 && !allAnswered && !confirm("Some questions are unanswered. Submit anyway?")) return;
Â  Â  Â  await db.collection('responses').doc(userId).set({ name: userName, answers, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  alert("Thanks for your submission, " + userName + "!"); showAggregatedResults();
Â  Â  });

Â  Â  // --- AUTH & INITIALIZATION ---
Â  Â  auth.onAuthStateChanged(async user => {
Â  Â  Â  const adminPanel = document.getElementById('admin-panel'); let newIsAdmin = false;
Â  Â  Â  if (user) {
Â  Â  Â  Â  document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
Â  Â  Â  Â  const adminDoc = await db.collection('admins').doc(user.uid).get();
Â  Â  Â  Â  if (adminDoc.exists) { newIsAdmin = true; }
Â  Â  Â  } else { document.getElementById('login-message').innerText = ''; }
Â  Â  Â  isAdmin = newIsAdmin;
Â  Â  Â  adminPanel.style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  document.getElementById('download-container').style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  document.getElementById('login-btn').style.display = isAdmin ? 'none' : 'inline';
Â  Â  Â  document.getElementById('logout-btn').style.display = isAdmin ? 'inline' : 'none';
Â  Â  Â  document.querySelectorAll('.admin-key-input-container').forEach(input => { input.style.display = isAdmin ? 'flex' : 'none'; });
Â  Â  Â  // Control visibility of the save all keys button
Â  Â  Â  document.getElementById('save-all-keys-container').style.display = isAdmin ? 'block' : 'none';

Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  const keyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  Â  if (keyDoc.exists) {
Â  Â  Â  Â  Â  const keyData = keyDoc.data();
Â  Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  const itemKey = 'item' + input.dataset.item;
Â  Â  Â  Â  Â  Â  if (document.activeElement !== input) { input.value = keyData[itemKey] || ''; }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  setupAnswerKeyListeners();
Â  Â  });
Â  Â  document.getElementById('login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert("Login failed: " + e.message)));
Â  Â  document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

Â  Â  function setupRealtimeListeners() {
Â  Â  Â  db.collection('responses').onSnapshot(snapshot => {
Â  Â  Â  Â  const userDoc = snapshot.docs.find(doc => doc.id === userId);
Â  Â  Â  Â  userHasSubmitted = !!userDoc;
Â  Â  Â  Â  updateSubmitButtonState();
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('submissionControl').onSnapshot(doc => {
Â  Â  Â  Â  const isEnabled = doc.exists && doc.data().enabled === true;
Â  Â  Â  Â  submissionsGloballyEnabled = isEnabled;Â 
Â  Â  Â  Â  if (isAdmin) { document.getElementById('global-toggle').checked = isEnabled; }
Â  Â  Â  Â  document.getElementById('global-status').innerText = isEnabled ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('surveySettings').onSnapshot(doc => {
Â  Â  Â  Â  const count = (doc.exists && doc.data().visibleItems !== undefined) ? doc.data().visibleItems : 5;
Â  Â  Â  Â  renderSurveyItems(count);
Â  Â  Â  Â  document.getElementById('questions-count-status').innerText = count;
Â  Â  Â  Â  if (isAdmin) { document.getElementById('item-count-input').value = count; }
Â  Â  Â  Â  setupAnswerKeyListeners();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('emojiSettings').onSnapshot(doc => {
Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
Â  Â  Â  Â  document.getElementById('emoji-container').style.display = (isAdmin || visible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('emoji-visibility-toggle').checked = !!visible; }
Â  Â  Â  Â  document.getElementById('emoji-status').innerText = visible ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('starRatingControl').onSnapshot(doc => {
Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
Â  Â  Â  Â  document.getElementById('star-rating-container').style.display = (isAdmin || visible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('star-visibility-toggle').checked = !!visible; }
Â  Â  Â  Â  document.getElementById('star-status').innerText = visible ? 'ON' : 'OFF';
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('yesNoSettings').onSnapshot(doc => {
Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
Â  Â  Â  Â  document.getElementById('yes-no-survey-container').style.display = (isAdmin || visible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('yes-no-visibility-toggle').checked = !!visible; }
Â  Â  Â  Â  document.getElementById('yes-no-status').innerText = visible ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('summarySettings').onSnapshot(doc => {
Â  Â  Â  Â  const isVisible = doc.exists && doc.data().visible === true;
Â  Â  Â  Â  const topStudentsVisible = doc.exists && doc.data().topStudentsVisible === true;
Â  Â  Â  Â  const userScoreVisible = doc.exists && doc.data().userScoreVisible === true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('results-summary').style.display = (isAdmin || isVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('summary-visibility-toggle').checked = isVisible; }
Â  Â  Â  Â  document.getElementById('summary-status').innerText = isVisible ? 'ON' : 'OFF';
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('top-students-container').style.display = (isAdmin || topStudentsVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('top-students-visibility-toggle').checked = topStudentsVisible; }
Â  Â  Â  Â  document.getElementById('top-students-status').innerText = topStudentsVisible ? 'ON' : 'OFF';

Â  Â  Â  Â  document.getElementById('my-score-container').style.display = (isAdmin || userScoreVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('my-score-visibility-toggle').checked = userScoreVisible; }
Â  Â  Â  Â  document.getElementById('my-score-status').innerText = userScoreVisible ? 'ON' : 'OFF';
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('topStudentsCount').onSnapshot(doc => {
Â  Â  Â  Â  const count = (doc.exists && doc.data().count) ? doc.data().count : 10;
Â  Â  Â  Â  if (isAdmin) { document.getElementById('top-students-count-input').value = count; }
Â  Â  Â  Â  document.getElementById('top-students-count-status').innerText = count;
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('resultsSettings').onSnapshot(doc => {
Â  Â  Â  Â  const isVisible = doc.exists && doc.data().visible === true;
Â  Â  Â  Â  document.getElementById('results').style.display = (isAdmin || isVisible) ? 'block' : 'none';
Â  Â  Â  Â  if (isAdmin) { document.getElementById('results-visibility-toggle').checked = isVisible; }
Â  Â  Â  Â  document.getElementById('results-status').innerText = isVisible ? 'ON' : 'OFF';
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('answerKey').onSnapshot(doc => {
Â  Â  Â  Â  if (isAdmin && doc.exists) {
Â  Â  Â  Â  Â  const answerKeyData = doc.data();
Â  Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  const itemKey = 'item' + input.dataset.item;
Â  Â  Â  Â  Â  Â  if (document.activeElement !== input) { input.value = answerKeyData[itemKey] || ''; }
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('yesNoCounts').onSnapshot(doc => {
Â  Â  Â  Â  const counts = doc.data() || { yes: 0, no: 0 };
Â  Â  Â  Â  const yesCount = counts.yes || 0; const noCount = counts.no || 0;
Â  Â  Â  Â  document.querySelector('.yes-no-btn[data-choice="yes"] .count').innerText = yesCount;
Â  Â  Â  Â  document.querySelector('.yes-no-btn[data-choice="no"] .count').innerText = noCount;
Â  Â  Â  Â  const yesIcon = document.querySelector('.yes-no-btn[data-choice="yes"] .icon');
Â  Â  Â  Â  const noIcon = document.querySelector('.yes-no-btn[data-choice="no"] .icon');
Â  Â  Â  Â  const calculateScale = (count) => {
Â  Â  Â  Â  Â  const baseScale = 1; const scaleFactor = 0.4; const maxScale = 4.0;
Â  Â  Â  Â  Â  let scale = baseScale + Math.log1p(count) * scaleFactor;
Â  Â  Â  Â  Â  return Math.min(scale, maxScale);
Â  Â  Â  Â  };
Â  Â  Â  Â  if (yesIcon) { yesIcon.style.transform = `scale(${calculateScale(yesCount)})`; }
Â  Â  Â  Â  if (noIcon) { noIcon.style.transform = `scale(${calculateScale(noCount)})`; }
Â  Â  Â  });
Â  Â  }
window.onload = async () => {
  // --- This part stays the same ---
  loadEmojiResults();
  checkIfReacted();
  loadStarRatingResults();
  checkIfStarRated();
  checkIfYesNoVoted();

  // --- NEW, MORE ROBUST FIX ---
  try {
    // This line specifically waits until a token is available.
    // It will throw an error if App Check fails, which helps with debugging.
    await firebase.appCheck().getToken(false); 
    
    console.log("App Check token is ready. Connecting to Firestore...");
    setupRealtimeListeners();

  } catch (error) {
    console.error("Could not get App Check token, Firestore will not be initialized.", error);
    // You might want to display a message to the user here
    alert("Could not connect to the server. Please refresh the page.");
  }
};
Â  </script>
</body>
</html>
