<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>THE RIGHT CHOICE</title>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

Â  <style>
Â  Â  body {Â 
Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;Â 
Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  overflow-x: hidden;Â 
Â  Â  Â  Â  background-color: #f7f9fc;Â 
Â  Â  Â  Â  color: #333;
Â  Â  }
Â  Â  .container-box {
Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  }
Â  Â  .btn {Â 
Â  Â  Â  Â  padding: 10px 20px;Â 
Â  Â  Â  Â  margin: 5px;Â 
Â  Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  Â  background:#f0f0f0;Â 
Â  Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  transition: background-color 0.3s, transform 0.2s;
Â  Â  }
Â  Â  .btn:hover {
Â  Â  Â  Â  background-color: #e5e5e5;
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .btn.selected {Â 
Â  Â  Â  Â  background:#4CAF50;Â 
Â  Â  Â  Â  color:#fff;Â 
Â  Â  Â  Â  border-color: #4CAF50;
Â  Â  }
Â  Â  #submit-btn {
Â  Â  Â  Â  background-color: #4CAF50;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  border: none;
Â  Â  }
Â  Â  #submit-btn[disabled] {Â 
Â  Â  Â  Â  background:#ccc;Â 
Â  Â  Â  Â  color:#666;Â 
Â  Â  Â  Â  cursor:not-allowed;Â 
Â  Â  }
Â  Â  #results {Â 
Â  Â  Â  Â  padding:15px;Â 
Â  Â  Â  Â  background-color: #e8f5e9;
Â  Â  Â  Â  border: 1px solid #c8e6c9;
Â  Â  Â  Â  white-space:pre-wrap;Â 
Â  Â  Â  Â  font-family:monospace;Â 
Â  Â  }
Â  Â  .bar { color:#4CAF50; }
Â  Â  .highlight { font-weight:bold; }
Â  Â  .line { border-top:1px solid #e0e0e0; margin:15px 0; }
Â  Â  .question-title { color: #388e3c; font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
Â  Â  .admin-key-input-container {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .admin-key-input-container input {
Â  Â  Â  margin-right: 5px;
Â  Â  }

Â  Â  .emoji-btn {
Â  Â  Â  font-size: 28px;
Â  Â  Â  padding: 5px 10px;
Â  Â  Â  margin: 5px;
Â  Â  Â  background: #f0f0f0;
Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.2s;
Â  Â  }
Â  Â  .emoji-btn:hover {
Â  Â  Â  Â  transform: scale(1.1);
Â  Â  }
Â  Â  .emoji-btn.selected {
Â  Â  Â  transform: scale(1.2);
Â  Â  Â  box-shadow: 0 0 5px #ffc107;
Â  Â  }
Â  Â  .emoji-btn .count, .yes-no-btn .count {
Â  Â  Â  font-size: 14px;
Â  Â  Â  margin-left: 5px;
Â  Â  }
Â  Â Â 
Â  Â  @keyframes emoji-pop {
Â  Â  Â  0% { transform: scale(1); }
Â  Â  Â  50% { transform: scale(1.4); }
Â  Â  Â  100% { transform: scale(1); }
Â  Â  }

Â  Â  .emoji-btn.clicked-animation, .yes-no-btn.clicked-animation {
Â  Â  Â  animation: emoji-pop 0.4s ease-in-out;
Â  Â  }

Â  Â  #top-controls-wrapper {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 20px;
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  #auth-section {
Â  Â  Â  Â  background-color: #e3f2fd;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
Â  Â  Â  Â  border: 1px solid #bbdefb;
Â  Â  }
Â  Â  #admin-panel {
Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  background-color: #fffde7;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
Â  Â  Â  Â  border: 1px solid #ffe0b2;
Â  Â  }
Â  Â  #admin-panel h4 {
Â  Â  Â  Â  color: #ff6f00;
Â  Â  Â  Â  margin-top: 0;
Â  Â  }
Â  Â  #admin-panel button {
Â  Â  Â  display: block;
Â  Â  Â  margin: 8px 0;
Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  #admin-panel div {
Â  Â  Â  margin-top: 8px;
Â  Â  Â  padding: 5px 0;
Â  Â  Â  border-bottom: 1px dashed #e0e0e0;
Â  Â  }
Â  Â  #admin-panel div:last-of-type {
Â  Â  Â  Â  border-bottom: none;
Â  Â  }
Â  Â  .status-text {
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  color: #4CAF50;
Â  Â  }

Â  Â  /* Star Rating Styles */
Â  Â  #star-rating-container {
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  background-color: #fff9e6;
Â  Â  Â  Â  border: 1px solid #ffecb3;
Â  Â  }
Â  Â  .star-btn {
Â  Â  Â  color: #ccc;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 30px;
Â  Â  Â  transition: color 0.2s, transform 0.2s;
Â  Â  }
Â  Â  .star-btn:hover, .star-btn.selected {
Â  Â  Â  color: #ffb300;Â 
Â  Â  Â  transform: scale(1.2);
Â  Â  }
Â  Â  #star-rating-results {
Â  Â  Â  margin-top: 10px;
Â  Â  Â  font-style: italic;
Â  Â  Â  color: #555;
Â  Â  }

Â  Â  /* Yes/No Survey Styles */
Â  Â  #yes-no-survey-container {
Â  Â  Â  margin-top: 25px;Â 
Â  Â  }
Â  Â  .yes-no-btn {
Â  Â  Â  background: #f0f4c3;
Â  Â  Â  border: 1px solid #cddc39;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  margin: 5px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: bold;
Â  Â  Â  font-size: 16px;Â 
Â  Â  Â  transition: transform 0.2s, background-color 0.2s;
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .yes-no-btn:not([disabled]):hover {
Â  Â  Â  background-color: #dce775;
Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .yes-no-btn .icon {
Â  Â  Â  display: inline-block;
Â  Â  Â  transition: transform 0.4s ease-out;
Â  Â  Â  margin-right: 8px;
Â  Â  Â  font-size: 20px;
Â  Â  }
Â  Â  .yes-no-btn.selected {
Â  Â  Â  background-color: #aed581;
Â  Â  Â  color: #333;Â 
Â  Â  }
Â  Â  .yes-no-btn.selected:hover {
Â  Â  Â  background-color: #aed581;
Â  Â  }
Â  Â  .yes-no-btn[disabled] {
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  opacity: 0.7;
Â  Â  }
Â  Â  .yes-no-btn[disabled]:hover {
Â  Â  Â  background: #f0f4c3;
Â  Â  }

Â  Â  @keyframes fly-across {
Â  Â  Â  from { transform: translate(0, 0); opacity: 1; }
Â  Â  Â  to { transform: translate(var(--end-x), var(--end-y)); opacity: 0; }
Â  Â  }
Â  Â  .flying-emoji {
Â  Â  Â  position: fixed; z-index: 9999; font-size: 24px; pointer-events: none;
Â  Â  Â  animation-name: fly-across;
Â  Â  Â  animation-timing-function: cubic-bezier(0.17, 0.84, 0.44, 1);
Â  Â  Â  animation-fill-mode: forwards;
Â  Â  }

Â  Â  .answer-key-input {
Â  Â  Â  width: 35px; margin-left: 15px; text-align: center; text-transform: uppercase;
Â  Â  Â  border: 1px solid #ccc; border-radius: 4px; padding: 4px;
Â  Â  }
Â  Â Â 
Â  Â  #name-input {
Â  Â  Â  padding: 12px;Â 
Â  Â  Â  font-size: 16px;Â 
Â  Â  Â  margin-top: 15px;Â 
Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  border: 1px solid #ccc;Â 
Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  display: block;Â 
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 300px;
Â  Â  }
Â  Â  #results-summary {
Â  Â  Â  padding: 15px;Â 
Â  Â  Â  background: #f0f4c3;Â 
Â  Â  Â  border: 1px solid #cddc39;
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  display: none;Â 
Â  Â  }
Â  Â  #results-summary h3 { margin-top: 0; color: #689f38; }
Â  Â  #results-summary ol { padding-left: 20px; }
Â  Â  #results-summary li { margin-bottom: 8px; }

Â  Â  .correct-answer {
Â  Â  Â  color: red;
Â  Â  Â  font-weight: bold;
Â  Â  }

Â  Â  #top-students-container, #my-score-container {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  padding: 20px;
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  border: 1px solid #bbdefb;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  display: none;
Â  Â  }
Â  Â  #top-students-container h3, #my-score-container h3 {
Â  Â  Â  margin-top: 0;
Â  Â  Â  color: #1565c0;
Â  Â  }
Â  Â  #top-students-container ul, #my-score-container ul {
Â  Â  Â  list-style: none;
Â  Â  Â  padding-left: 0;
Â  Â  }
Â  Â  #top-students-container li, #my-score-container li {
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .correct-icon { color: green; font-weight: bold; }
Â  Â  .incorrect-icon { color: red; font-weight: bold; }
Â  Â Â 
Â  </style>
</head>

<body>
Â  <div style="font-size: 14px; color: black; background: #ffeb3b; padding: 5px; margin-bottom: 10px; border-radius: 8px;">
Â  Â  Version 1.0.24
Â  </div>
Â  <div class="container-box">
Â  Â  <img src="RInew.jpg" width="350" height="165" style="display: block; margin: 0;"/>
Â  </div>

Â  <div class="container-box" id="top-controls-wrapper">
Â  Â  <div id="auth-section">
Â  Â  Â  <input id="email" type="email" placeholder="Admin Email"/>
Â  Â  Â  <input id="password" type="password" placeholder="Password"/>
Â  Â  Â  <button id="login-btn" class="btn">Login</button>
Â  Â  Â  <button id="logout-btn" class="btn" style="display:none;">Logout</button>
Â  Â  Â  <p id="login-message"></p>
Â  Â  </div>
Â  Â  <div id="admin-panel">
Â  Â  Â  <h4>Admin Controls</h4>
Â  Â  Â  <button id="reset-btn" class="btn">Reset Question Data</button>
Â  Â  Â  <button id="reset-emoji-btn" class="btn">Reset Emoji Counts</button>
Â  Â  Â  <button id="reset-stars-btn" class="btn">Reset Star Ratings</button>
Â  Â  Â  <button id="reset-yes-no-btn" class="btn">Reset Yes/No Survey</button>Â 
Â  Â  Â  <button id="reset-keys-btn" class="btn">Reset Answer Key</button>
Â  Â  Â  <div id="global-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="global-toggle" checked/> <strong>Enable Submissions</strong></label>
Â  Â  Â  Â  <span class="status-text" id="global-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="emoji-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="emoji-visibility-toggle" checked/> <strong>Show Emoji Reactions</strong></label>
Â  Â  Â  Â  <span class="status-text" id="emoji-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="star-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="star-visibility-toggle" checked/> <strong>Show Star Rating</strong></label>
Â  Â  Â  Â  <span class="status-text" id="star-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="yes-no-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="yes-no-visibility-toggle" checked/> <strong>Show Yes/No Survey</strong></label>
Â  Â  Â  Â  <span class="status-text" id="yes-no-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="summary-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="summary-visibility-toggle" checked/> <strong>Show Results Summary</strong></label>
Â  Â  Â  Â  <span class="status-text" id="summary-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="results-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="results-visibility-toggle" checked/> <strong>Show Raw Results</strong></label>
Â  Â  Â  Â  <span class="status-text" id="results-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="top-students-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="top-students-visibility-toggle" checked/> <strong>Show Top Students</strong></label>
Â  Â  Â  Â  <span class="status-text" id="top-students-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="my-score-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="my-score-visibility-toggle" checked/> <strong>Show My Score</strong></label>
Â  Â  Â  Â  <span class="status-text" id="my-score-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="item-count-container">
Â  Â  Â  Â  <label><strong>Questions to Show:</strong></label>
Â  Â  Â  Â  <input type="number" id="item-count-input" min="0" max="100" value="5" style="width: 50px;"/>
Â  Â  Â  Â  <button id="update-item-count" class="btn">Update</button>
Â  Â  Â  Â  <span class="status-text" id="questions-count-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <div id="top-students-count-container">
Â  Â  Â  Â  <label><strong>Top Students to Show:</strong></label>
Â  Â  Â  Â  <input type="number" id="top-students-count-input" min="1" max="50" value="10" style="width: 50px;"/>
Â  Â  Â  Â  <button id="update-top-students-count" class="btn">Update</button>
Â  Â  Â  Â  <span class="status-text" id="top-students-count-status"></span>
Â  Â  Â  </div>
Â  Â  Â  <button id="generate-users-btn" class="btn">Generate 10 Users</button>
Â  Â  </div>
Â  </div>

Â  <div id="emoji-container" class="container-box">
Â  Â  <div><strong>React with an emoji:</strong></div>
Â  Â  <div id="emoji-options">
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ˜®">ğŸ˜® <span class="count">0</span></button>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div id="star-rating-container" class="container-box">
Â  Â  <div><strong>Rate your experience:</strong></div>
Â  Â  <div id="star-options">
Â  Â  Â  <span class="star-btn" data-rating="1">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="2">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="3">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="4">&#9734;</span>
Â  Â  Â  <span class="star-btn" data-rating="5">&#9734;</span>
Â  Â  </div>
Â  Â  <div id="star-rating-results">Loading...</div>
Â  </div>

Â  <div id="yes-no-survey-container" class="container-box">
Â  Â  <div><strong>Yes or No?</strong></div>
Â  Â  <div id="yes-no-options">
Â  Â  Â  <button class="yes-no-btn" data-choice="yes"><span class="icon">ğŸ‘</span> Yes <span class="count">0</span></button>
Â  Â  Â  <button class="yes-no-btn" data-choice="no"><span class="icon">ğŸ‘</span> No <span class="count">0</span></button>
Â  Â  </div>
Â  </div>

Â  <div id="survey-container" class="container-box"></div>
Â Â 
Â  <div id="save-all-keys-container" style="display:none; margin-bottom: 15px;">
Â  Â  <button id="save-all-keys-btn" class="btn">Save All Answer Keys</button>
Â  </div>
Â  <input type="text" id="name-input" placeholder="Your Name" required />
Â  <button id="submit-btn" class="btn">Submit</button>

Â  <div id="results" class="container-box"></div>
Â  <div id="results-summary" class="container-box"></div>
Â  <div id="top-students-container" class="container-box"></div>
Â  <div id="my-score-container" class="container-box"></div>

Â  <div id="download-container" class="container-box" style="text-align: center; display: none;">
Â  Â  Â  <button id="download-excel-btn" class="btn">Download Results as Excel (CSV)</button>
Â  </div>


Â  <script>
Â  Â  // --- CONFIGURATION & INITIALIZATION ---
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
Â  Â  Â  authDomain: "shamankingdata.firebaseapp.com",
Â  Â  Â  projectId: "shamankingdata",
Â  Â  Â  storageBucket: "shamankingdata.appspot.com",
Â  Â  Â  messagingSenderId: "757444066890",
Â  Â  Â  appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore();
Â  Â  const auth = firebase.auth();

Â  Â  // --- GLOBAL STATE ---
Â  Â  let isAdmin = false;
Â  Â  let submissionsGloballyEnabled = false;
Â  Â  let userHasSubmitted = false;

Â  Â  // --- CACHED DOM ELEMENTS ---
Â  Â  const DOM = {
Â  Â  Â  emailInput: document.getElementById('email'),
Â  Â  Â  passwordInput: document.getElementById('password'),
Â  Â  Â  loginBtn: document.getElementById('login-btn'),
Â  Â  Â  logoutBtn: document.getElementById('logout-btn'),
Â  Â  Â  loginMessage: document.getElementById('login-message'),
Â  Â  Â  adminPanel: document.getElementById('admin-panel'),
Â  Â  Â  submitBtn: document.getElementById('submit-btn'),
Â  Â  Â  surveyContainer: document.getElementById('survey-container'),
Â  Â  Â  saveAllKeysContainer: document.getElementById('save-all-keys-container'),
Â  Â  Â  resultsContainer: document.getElementById('results'),
Â  Â  Â  resultsSummaryContainer: document.getElementById('results-summary'),
Â  Â  Â  topStudentsContainer: document.getElementById('top-students-container'),
Â  Â  Â  myScoreContainer: document.getElementById('my-score-container'),
Â  Â  Â  downloadContainer: document.getElementById('download-container'),
Â  Â  Â  nameInput: document.getElementById('name-input'),
Â  Â  Â  // Toggles & Inputs
Â  Â  Â  globalToggle: document.getElementById('global-toggle'),
Â  Â  Â  globalStatus: document.getElementById('global-status'),
Â  Â  Â  itemCountInput: document.getElementById('item-count-input'),
Â  Â  Â  questionsCountStatus: document.getElementById('questions-count-status'),
Â  Â  Â  topStudentsCountInput: document.getElementById('top-students-count-input'),
Â  Â  Â  topStudentsCountStatus: document.getElementById('top-students-count-status'),
Â  Â  Â  // Feature Containers
Â  Â  Â  emojiContainer: document.getElementById('emoji-container'),
Â  Â  Â  starRatingContainer: document.getElementById('star-rating-container'),
Â  Â  Â  yesNoSurveyContainer: document.getElementById('yes-no-survey-container'),
Â  Â  Â  starOptions: document.getElementById('star-options'),
Â  Â  Â  starRatingResults: document.getElementById('star-rating-results'),
Â  Â  };

Â  Â  // --- UTILITY FUNCTIONS ---
Â  Â  const getUserId = () => {
Â  Â  Â  let uid = localStorage.getItem('userId');
Â  Â  Â  if (!uid) {
Â  Â  Â  Â  uid = `user_${Math.random().toString(36).substring(2, 11)}`;
Â  Â  Â  Â  localStorage.setItem('userId', uid);
Â  Â  Â  }
Â  Â  Â  return uid;
Â  Â  };
Â  Â  const userId = getUserId();

Â  Â  const setSubmitButtonState = (disabled, text) => {
Â  Â  Â  DOM.submitBtn.disabled = disabled;
Â  Â  Â  DOM.submitBtn.innerText = text;
Â  Â  };

Â  Â  const updateSubmitButtonState = async () => {
Â  Â  Â  const userDoc = await db.collection('responses').doc(userId).get();
Â  Â  Â  userHasSubmitted = userDoc.exists;

Â  Â  Â  if (!submissionsGloballyEnabled) {
Â  Â  Â  Â  setSubmitButtonState(true, 'Submissions Disabled');
Â  Â  Â  } else if (userHasSubmitted) {
Â  Â  Â  Â  setSubmitButtonState(true, 'Already Submitted');
Â  Â  Â  } else {
Â  Â  Â  Â  setSubmitButtonState(false, 'Submit');
Â  Â  Â  }
Â  Â  };

Â  Â  // --- UI & RENDER FUNCTIONS ---
Â  Â  const renderSurveyItems = (count) => {
Â  Â  Â  DOM.surveyContainer.innerHTML = '';
Â  Â  Â  const showSubmit = count > 0;
Â  Â  Â  DOM.submitBtn.style.display = showSubmit ? 'inline-block' : 'none';
Â  Â  Â  DOM.saveAllKeysContainer.style.display = showSubmit && isAdmin ? 'block' : 'none';

Â  Â  Â  for (let i = 1; i <= count; i++) {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'survey-item';
Â  Â  Â  Â  div.dataset.item = i;
Â  Â  Â  Â  const inputStyle = isAdmin ? 'flex' : 'none';
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  <div class="question-title">Question #${i}</div>
Â  Â  Â  Â  Â  <button class="btn" data-letter="A">A</button>
Â  Â  Â  Â  Â  <button class="btn" data-letter="B">B</button>
Â  Â  Â  Â  Â  <button class="btn" data-letter="C">C</button>
Â  Â  Â  Â  Â  <button class="btn" data-letter="D">D</button>
Â  Â  Â  Â  Â  <span class="admin-key-input-container" style="display: ${inputStyle};">
Â  Â  Â  Â  Â  Â  <input type="text" class="answer-key-input" data-item="${i}" placeholder="Key" maxlength="1">
Â  Â  Â  Â  Â  Â  <button class="btn save-key-btn" data-item="${i}">Save</button>
Â  Â  Â  Â  Â  </span>`;
Â  Â  Â  Â  DOM.surveyContainer.appendChild(div);
Â  Â  Â  }
Â  Â  Â  setupSurveyItemListeners();
Â  Â  };
Â  Â Â 
Â  Â  const updateAdminUI = async (isAdminStatus) => {
Â  Â  Â  isAdmin = isAdminStatus;
Â  Â  Â  DOM.adminPanel.style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  DOM.downloadContainer.style.display = isAdmin ? 'block' : 'none';
Â  Â  Â  DOM.loginBtn.style.display = isAdmin ? 'none' : 'inline';
Â  Â  Â  DOM.logoutBtn.style.display = isAdmin ? 'inline' : 'none';
Â  Â  Â  DOM.saveAllKeysContainer.style.display = isAdmin && DOM.surveyContainer.children.length > 0 ? 'block' : 'none';
Â  Â  Â  document.querySelectorAll('.admin-key-input-container').forEach(el => el.style.display = isAdmin ? 'flex' : 'none');
Â  Â  Â Â 
Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  await loadAndApplyAnswerKey();
Â  Â  Â  }
Â  Â  Â  showAggregatedResults();
Â  Â  };

Â  Â  // --- CORE LOGIC & DATA HANDLING ---
Â  Â  async function showAggregatedResults() {
Â  Â  Â  const settingsDoc = await db.collection('settings').doc('surveySettings').get();
Â  Â  Â  const visibleCount = settingsDoc.data()?.visibleItems ?? 5;

Â  Â  Â  const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  const answerKeyData = answerKeyDoc.data() ?? {};

Â  Â  Â  const snapshot = await db.collection('responses').get();
Â  Â  Â  const counts = {};
Â  Â  Â  for (let i = 1; i <= visibleCount; i++) {
Â  Â  Â  Â  counts[`item${i}`] = { A: 0, B: 0, C: 0, D: 0 };
Â  Â  Â  }
Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  const answers = doc.data().answers;
Â  Â  Â  Â  for (const [key, value] of Object.entries(answers)) {
Â  Â  Â  Â  Â  if (counts[key]?.[value] !== undefined) {
Â  Â  Â  Â  Â  Â  counts[key][value]++;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  const totalMax = Math.max(1, ...Object.values(counts).flatMap(c => Object.values(c)));

Â  Â  Â  const resultsHtml = Object.entries(counts).map(([itemKey, itemCounts]) => {
Â  Â  Â  Â  const itemNum = itemKey.replace('item', '');
Â  Â  Â  Â  const itemMax = Math.max(0, ...Object.values(itemCounts));
Â  Â  Â  Â  const correctAnswer = answerKeyData[itemKey];

Â  Â  Â  Â  const optionsHtml = Object.entries(itemCounts).map(([letter, count]) => {
Â  Â  Â  Â  Â  const bar = `<span class="bar">${'â–ˆ'.repeat((count / totalMax) * 20)}</span>`;
Â  Â  Â  Â  Â  const classes = [];
Â  Â  Â  Â  Â  if (count > 0 && count === itemMax) classes.push('highlight');
Â  Â  Â  Â  Â  if (letter === correctAnswer) classes.push('correct-answer');
Â  Â  Â  Â  Â  const displayLetter = classes.length > 0 ? `<span class="${classes.join(' ')}">${letter}</span>` : letter;
Â  Â  Â  Â  Â  return `  ${displayLetter}: ${count} ${bar}`;
Â  Â  Â  Â  }).join('\n');
Â  Â  Â  Â  return `Item ${itemNum}:\n${optionsHtml}`;
Â  Â  Â  }).join('\n</pre><div class="line"></div><pre>\n');

Â  Â  Â  DOM.resultsContainer.innerHTML = `<h3>Results:</h3><pre>${resultsHtml}</pre>`;

Â  Â  Â  // Update dependent components
Â  Â  Â  showResultsSummary(counts, answerKeyData);
Â  Â  Â  showTopStudentsResults(snapshot, answerKeyData);
Â  Â  Â  showMyScore(answerKeyData);
Â  Â  }
Â  Â Â 
Â  Â  const showResultsSummary = (counts, answerKeyData) => {
Â  Â  Â  if (!answerKeyData || Object.keys(answerKeyData).length === 0) {
Â  Â  Â  Â  DOM.resultsSummaryContainer.innerHTML = '<h3>Ranking of Questions by Incorrect Answers:</h3><p>An answer key must be set by an admin to see this summary.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const summaryData = Object.entries(counts).map(([itemKey, itemCounts]) => {
Â  Â  Â  Â  const correctAnswer = answerKeyData[itemKey];
Â  Â  Â  Â  if (!correctAnswer) return null;
Â  Â  Â  Â  const totalVotes = Object.values(itemCounts).reduce((a, b) => a + b, 0);
Â  Â  Â  Â  const correctVotes = itemCounts[correctAnswer] ?? 0;
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  questionNumber: parseInt(itemKey.replace('item', '')),
Â  Â  Â  Â  Â  wrongVotes: totalVotes - correctVotes,
Â  Â  Â  Â  };
Â  Â  Â  }).filter(Boolean).sort((a, b) => b.wrongVotes - a.wrongVotes);

Â  Â  Â  const summaryList = summaryData.map(item => `<li>Question #${item.questionNumber}: <strong>${item.wrongVotes}</strong> incorrect answer(s)</li>`).join('');
Â  Â  Â  DOM.resultsSummaryContainer.innerHTML = `<h3>Ranking of Questions by Incorrect Answers:</h3><ol>${summaryList}</ol>`;
Â  Â  };
Â  Â Â 
Â  Â  async function showTopStudentsResults(snapshot, answerKey) {
Â  Â  Â  const container = DOM.topStudentsContainer;
Â  Â  Â  if (!answerKey || Object.keys(answerKey).length === 0) {
Â  Â  Â  Â  container.innerHTML = '<h3>Top Students</h3><p>An answer key must be set to display student scores.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const scores = [];
Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  const data = doc.data();
Â  Â  Â  Â  const userAnswers = data.answers ?? {};
Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  for (const [itemKey, correctAnswer] of Object.entries(answerKey)) {
Â  Â  Â  Â  Â  if (userAnswers[itemKey] === correctAnswer) {
Â  Â  Â  Â  Â  Â  score++;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  scores.push({ name: data.name, score: score, userId: doc.id });
Â  Â  Â  });
Â  Â  Â  scores.sort((a, b) => b.score - a.score);

Â  Â  Â  const topStudentsCountDoc = await db.collection('settings').doc('topStudentsCount').get();
Â  Â  Â  const topN = topStudentsCountDoc.data()?.count ?? 10;
Â  Â  Â Â 
Â  Â  Â  const listHtml = scores.slice(0, topN).map((student, index) => {
Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  return `<li>Rank #${index + 1}: <input type="text" value="${student.name}" data-userid="${student.userId}"/> Score: ${student.score} <button class="save-name-btn" data-userid="${student.userId}">Save</button></li>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  return `<li>Rank #${index + 1}: ${student.name} - Score: ${student.score}</li>`;
Â  Â  Â  }).join('');

Â  Â  Â  container.innerHTML = `<h3>Top ${topN} Students</h3><ul>${listHtml}</ul>`;
Â  Â  Â  if (isAdmin) setupTopStudentsAdminListeners();
Â  Â  }

Â  Â  async function showMyScore(answerKey) {
Â  Â  Â  const container = DOM.myScoreContainer;
Â  Â  Â  const userDoc = await db.collection('responses').doc(userId).get();
Â  Â  Â  if (!userDoc.exists) {
Â  Â  Â  Â  container.innerHTML = '<h3>My Score</h3><p>Submit your answers to see your score.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!answerKey || Object.keys(answerKey).length === 0) {
Â  Â  Â  Â  container.innerHTML = '<h3>My Score</h3><p>An answer key must be set to calculate your score.</p>';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const userAnswers = userDoc.data().answers ?? {};
Â  Â  Â  let totalScore = 0;
Â  Â  Â Â 
Â  Â  Â  const sortedKeys = Object.keys(answerKey).sort((a, b) => parseInt(a.replace('item', '')) - parseInt(b.replace('item', '')));

Â  Â  Â  const answerListHtml = sortedKeys.map(itemKey => {
Â  Â  Â  Â  const questionNumber = itemKey.replace('item', '');
Â  Â  Â  Â  const userAnswer = userAnswers[itemKey];
Â  Â  Â  Â  const correctAnswer = answerKey[itemKey];
Â  Â  Â  Â  const isCorrect = userAnswer === correctAnswer;
Â  Â  Â  Â  if (isCorrect) totalScore++;
Â  Â  Â  Â  const icon = isCorrect ? 'âœ…' : 'âŒ';
Â  Â  Â  Â  const iconClass = isCorrect ? 'correct-icon' : 'incorrect-icon';
Â  Â  Â  Â  return `<li>Question #${questionNumber}: Your answer was ${userAnswer || 'N/A'} <span class="${iconClass}">${icon}</span></li>`;
Â  Â  Â  }).join('');

Â  Â  Â  container.innerHTML = `
Â  Â  Â  Â  <h3>My Score</h3>
Â  Â  Â  Â  <p>Your Final Score: <strong>${totalScore}</strong></p>
Â  Â  Â  Â  <h4>Answer Summary:</h4>
Â  Â  Â  Â  <ul>${answerListHtml}</ul>`;
Â  Â  }

Â  Â  // --- EVENT HANDLERS ---
Â  Â  const handleSubmit = async () => {
Â  Â  Â  if (!submissionsGloballyEnabled) return alert("Submissions are currently disabled.");
Â  Â  Â  if (userHasSubmitted) return alert("You have already submitted.");

Â  Â  Â  const userName = DOM.nameInput.value.trim();
Â  Â  Â  if (!userName) {
Â  Â  Â  Â  alert('Please enter your name before submitting.');
Â  Â  Â  Â  DOM.nameInput.focus();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const answers = {};
Â  Â  Â  const items = document.querySelectorAll('.survey-item');
Â  Â  Â  let allAnswered = true;
Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  const selected = item.querySelector('.btn.selected');
Â  Â  Â  Â  if (selected) {
Â  Â  Â  Â  Â  answers[`item${item.dataset.item}`] = selected.dataset.letter;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  allAnswered = false;
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  if (items.length > 0 && !allAnswered) {
Â  Â  Â  Â  if (!confirm("Some questions are unanswered. Submit anyway?")) return;
Â  Â  Â  }

Â  Â  Â  await db.collection('responses').doc(userId).set({
Â  Â  Â  Â  name: userName,
Â  Â  Â  Â  answers,
Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  });
Â  Â  Â  alert(`Thanks for your submission, ${userName}!`);
Â  Â  Â  showAggregatedResults();
Â  Â  };
Â  Â Â 
Â  Â  const handleEmojiClick = async (e) => {
Â  Â  Â  const clickedButton = e.currentTarget;
Â  Â  Â  if (await db.collection('emojiReactions').doc(userId).get().then(d => d.exists)) return;
Â  Â  Â Â 
Â  Â  Â  clickedButton.classList.add('clicked-animation');
Â  Â  Â  clickedButton.addEventListener('animationend', () => clickedButton.classList.remove('clicked-animation'), { once: true });

Â  Â  Â  await db.collection('emojiReactions').doc(userId).set({
Â  Â  Â  Â  emoji: clickedButton.dataset.emoji,
Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  });
Â  Â  Â  loadEmojiResults();
Â  Â  Â  checkIfReacted();
Â  Â  };
Â  Â Â 
Â  Â  const handleStarClick = async (rating) => {
Â  Â  Â  if (await db.collection('starRatings').doc(userId).get().then(d => d.exists)) return;
Â  Â  Â  if (!confirm(`You are about to submit a rating of ${rating} out of 5. Are you sure?`)) return;

Â  Â  Â  const settingsRef = db.collection('settings').doc('starRatingControl');
Â  Â  Â  try {
Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  const settingsDoc = await transaction.get(settingsRef);
Â  Â  Â  Â  Â  const { sumOfRatings = 0, totalRatings = 0 } = settingsDoc.data() ?? {};
Â  Â  Â  Â  Â  transaction.set(db.collection('starRatings').doc(userId), { rating, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  Â  Â  transaction.set(settingsRef, { sumOfRatings: sumOfRatings + rating, totalRatings: totalRatings + 1 }, { merge: true });
Â  Â  Â  Â  });
Â  Â  Â  Â  checkIfStarRated();
Â  Â  Â  Â  loadStarRatingResults();
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Star rating transaction failed: ", e);
Â  Â  Â  Â  alert("Could not submit rating. Please try again.");
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const handleYesNoClick = async (e) => {
Â  Â  Â  const clickedButton = e.currentTarget;
Â  Â  Â  if (await db.collection('yesNoVotes').doc(userId).get().then(d => d.exists)) return;

Â  Â  Â  clickedButton.classList.add('clicked-animation');
Â  Â  Â  clickedButton.addEventListener('animationend', () => clickedButton.classList.remove('clicked-animation'), { once: true });
Â  Â  Â  const choice = clickedButton.dataset.choice;
Â  Â  Â Â 
Â  Â  Â  const countsRef = db.collection('settings').doc('yesNoCounts');
Â  Â  Â  try {
Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  const countsDoc = await transaction.get(countsRef);
Â  Â  Â  Â  Â  const newCounts = { ...countsDoc.data() } ?? { yes: 0, no: 0 };
Â  Â  Â  Â  Â  newCounts[choice] = (newCounts[choice] || 0) + 1;
Â  Â  Â  Â  Â  transaction.set(db.collection('yesNoVotes').doc(userId), { choice, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  Â  Â  transaction.set(countsRef, newCounts, { merge: true });
Â  Â  Â  Â  });
Â  Â  Â  Â  checkIfYesNoVoted();
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Yes/No transaction failed: ", error);
Â  Â  Â  Â  alert("Your vote could not be cast. Please try again.");
Â  Â  Â  }
Â  Â  };

Â  Â  // --- ADMIN-SPECIFIC FUNCTIONS ---
Â  Â  const resetData = async (collectionName, confirmationMsg) => {
Â  Â  Â  if (!isAdmin || !confirm(confirmationMsg)) return;
Â  Â  Â  const snapshot = await db.collection(collectionName).get();
Â  Â  Â  if (snapshot.empty) return alert(`No data to delete in ${collectionName}.`);
Â  Â  Â  const batch = db.batch();
Â  Â  _B/W photo of a person looking at the camera_ Â  Â  snapshot.docs.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  await batch.commit();
Â  Â  Â  alert(`${collectionName} data deleted.`);
Â  Â  };
Â  Â Â 
Â  Â  const saveAllAnswerKeys = async () => {
Â  Â  Â  if (!isAdmin) return;
Â  Â  Â  const answerKey = {};
Â  Â  Â  const validLetters = ['A', 'B', 'C', 'D', ''];
Â  Â  Â  for (const input of document.querySelectorAll('.answer-key-input')) {
Â  Â  Â  Â  const value = input.value.trim().toUpperCase();
Â  Â  Â  Â  if (!validLetters.includes(value)) {
Â  Â  Â  Â  Â  alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
Â  Â  Â  Â  Â  input.focus();
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  answerKey[`item${input.dataset.item}`] = value;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  await db.collection('settings').doc('answerKey').set(answerKey);
Â  Â  Â  Â  alert('Answer key for all questions saved successfully!');
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Error saving answer key:', e);
Â  Â  Â  Â  alert('Failed to save answer key.');
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const downloadResultsAsCSV = async () => {
Â  Â  Â  if (!isAdmin) return alert('This feature is for admins only.');
Â  Â  Â  const [responsesSnap, answerKeyDoc, surveySettingsDoc] = await Promise.all([
Â  Â  Â  Â  db.collection('responses').get(),
Â  Â  Â  Â  db.collection('settings').doc('answerKey').get(),
Â  Â  Â  Â  db.collection('settings').doc('surveySettings').get()
Â  Â  Â  ]);

Â  Â  Â  const answerKey = answerKeyDoc.data();
Â  Â  Â  if (!answerKey) return alert('Cannot generate report. An answer key must be set first.');
Â  Â  Â Â 
Â  Â  Â  const numQuestions = surveySettingsDoc.data()?.visibleItems ?? Object.keys(answerKey).length;
Â  Â  Â  const studentData = responsesSnap.docs.map(doc => {
Â  Â  Â  Â  const response = doc.data();
Â  Â  Â  Â  const userAnswers = response.answers ?? {};
Â  Â  Â  Â  let score = 0;
Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  const itemKey = `item${i}`;
Â  Â  Â  Â  Â  if (answerKey[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) score++;
Â  Â  Â  Â  }
Â  Â  Â  Â  return { name: response.name, score, answers: userAnswers };
Â  Â  Â  }).sort((a, b) => b.score - a.score);

Â  Â  Â  const headers = ["Rank", "Name", "Total Score", ...Array.from({ length: numQuestions }, (_, i) => `Item ${i + 1}`)];
Â  Â  Â  const csvRows = [headers.join(",")];
Â  Â  Â Â 
Â  Â  Â  studentData.forEach((student, index) => {
Â  Â  Â  Â  const rank = index + 1;
Â  Â  Â  Â  const name = `"${(student.name || '').replace(/"/g, '""')}"`;
Â  Â  Â  Â  const row = [rank, name, student.score];
Â  Â  Â  Â  for (let i = 1; i <= numQuestions; i++) {
Â  Â  Â  Â  Â  const itemKey = `item${i}`;
Â  Â  Â  Â  Â  const userAnswer = student.answers[itemKey] || "N/A";
Â  Â  Â  Â  Â  const correctAnswer = answerKey[itemKey];
Â  Â  Â  Â  Â  let cellValue = userAnswer;
Â  Â  Â  Â  Â  if (userAnswer !== "N/A" && correctAnswer) {
Â  Â  Â  Â  Â  Â  cellValue = `${userAnswer} (${userAnswer === correctAnswer ? 'Correct' : 'Wrong'})`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  row.push(`"${cellValue}"`);
Â  Â  Â  Â  }
Â  Â  Â  Â  csvRows.push(row.join(","));
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  const blob = new Blob([csvRows.join("\r\n")], { type: 'text/csv;charset=utf-8;' });
Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  link.download = "student_scores.csv";
Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  link.click();
Â  Â  Â  document.body.removeChild(link);
Â  Â  };

Â  Â  // --- INITIAL DATA LOAD & CHECKS ---
Â  Â  const loadEmojiResults = async () => {
Â  Â  Â  const snapshot = await db.collection('emojiReactions').get();
Â  Â  Â  const counts = {};
Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  const emoji = doc.data().emoji;
Â  Â  Â  Â  counts[emoji] = (counts[emoji] || 0) + 1;
Â  Â  Â  });
Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => {
Â  Â  Â  Â  btn.querySelector('.count').innerText = counts[btn.dataset.emoji] ?? 0;
Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â  Â  const checkIfReacted = async () => {
Â  Â  Â  const doc = await db.collection('emojiReactions').doc(userId).get();
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  const reactedEmoji = doc.data().emoji;
Â  Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => {
Â  Â  Â  Â  Â  if (btn.dataset.emoji === reactedEmoji) {
Â  Â  Â  Â  Â  Â  btn.classList.add('selected');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const updateStarsUI = (rating) => {
Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => {
Â  Â  Â  Â  const isSelected = star.dataset.rating <= rating;
Â  Â  Â  Â  star.classList.toggle('selected', isSelected);
Â  Â  Â  Â  star.innerHTML = isSelected ? '&#9733;' : '&#9734;';
Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â  Â  const loadStarRatingResults = async () => {
Â  Â  Â  const doc = await db.collection('settings').doc('starRatingControl').get();
Â  Â  Â  const { sumOfRatings = 0, totalRatings = 0 } = doc.data() ?? {};
Â  Â  Â  if (totalRatings > 0) {
Â  Â  Â  Â  const avg = (sumOfRatings / totalRatings).toFixed(1);
Â  Â  Â  Â  DOM.starRatingResults.innerText = `Average: ${avg} (${totalRatings} ratings)`;
Â  Â  Â  Â  if (!document.querySelector('.star-btn[disabled]')) {
Â  Â  Â  Â  Â  updateStarsUI(Math.round(avg));
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  DOM.starRatingResults.innerText = 'No ratings yet.';
Â  Â  Â  Â  updateStarsUI(0);
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const checkIfStarRated = async () => {
Â  Â  Â  const doc = await db.collection('starRatings').doc(userId).get();
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  updateStarsUI(doc.data().rating);
Â  Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => star.setAttribute('disabled', true));
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const checkIfYesNoVoted = async () => {
Â  Â  Â  const doc = await db.collection('yesNoVotes').doc(userId).get();
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  const choice = doc.data().choice;
Â  Â  Â  Â  document.querySelectorAll('.yes-no-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  if (btn.dataset.choice === choice) btn.classList.add('selected');
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const loadAndApplyAnswerKey = async () => {
Â  Â  Â  Â  const keyDoc = await db.collection('settings').doc('answerKey').get();
Â  Â  Â  Â  const keyData = keyDoc.data() ?? {};
Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => {
Â  Â  Â  Â  Â  Â  if (document.activeElement !== input) {
Â  Â  Â  Â  Â  Â  Â  Â  input.value = keyData[`item${input.dataset.item}`] || '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  };

Â  Â  // --- EVENT LISTENER SETUP ---
Â  Â  const setupSurveyItemListeners = () => {
Â  Â  Â  document.querySelectorAll('.survey-item .btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  e.target.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
Â  Â  Â  Â  Â  e.target.classList.add('selected');
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  document.querySelectorAll('.save-key-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.addEventListener('click', async (e) => {
Â  Â  Â  Â  Â  Â  const item = `item${e.target.dataset.item}`;
Â  Â  Â  Â  Â  Â  const input = document.querySelector(`.answer-key-input[data-item="${e.target.dataset.item}"]`);
Â  Â  Â  Â  Â  Â  const value = input.value.trim().toUpperCase();
Â  Â  Â  Â  Â  Â  if (!['A', 'B', 'C', 'D', ''].includes(value)) {
Â  Â  Â  Â  Â  Â  Â  return alert(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  await db.collection('settings').doc('answerKey').set({ [item]: value }, { merge: true });
Â  Â  Â  Â  Â  Â  alert(`Answer key for Question #${e.target.dataset.item} saved!`);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  };
Â  Â Â 
Â  Â  const setupTopStudentsAdminListeners = () => {
Â  Â  Â  DOM.topStudentsContainer.querySelectorAll('.save-name-btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', async (e) => {
Â  Â  Â  Â  Â  const userIdToUpdate = e.target.dataset.userid;
Â  Â  Â  Â  Â  const newName = e.target.previousElementSibling.value;
Â  Â  Â  Â  Â  await db.collection('responses').doc(userIdToUpdate).update({ name: newName });
Â  Â  Â  Â  Â  alert('Name updated!');
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  };
Â  Â Â 
Â  Â  const bindEventListeners = () => {
Â  Â  Â  // Main Actions
Â  Â  Â  DOM.loginBtn.addEventListener('click', () => auth.signInWithEmailAndPassword(DOM.emailInput.value, DOM.passwordInput.value).catch(e => alert(`Login failed: ${e.message}`)));
Â  Â  Â  DOM.logoutBtn.addEventListener('click', () => auth.signOut());
Â  Â  Â  DOM.submitBtn.addEventListener('click', handleSubmit);
Â  Â  Â  document.getElementById('download-excel-btn').addEventListener('click', downloadResultsAsCSV);

Â  Â  Â  // Feature Interactions
Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => btn.addEventListener('click', handleEmojiClick));
Â  Â  Â  document.querySelectorAll('.yes-no-btn').forEach(btn => btn.addEventListener('click', handleYesNoClick));
Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => {
Â  Â  Â  Â  star.addEventListener('click', (e) => handleStarClick(parseInt(e.target.dataset.rating)));
Â  Â  Â  Â  star.addEventListener('mouseover', (e) => { if (!e.target.hasAttribute('disabled')) updateStarsUI(e.target.dataset.rating); });
Â  Â  Â  });
Â  Â  Â  DOM.starOptions.addEventListener('mouseout', () => { if (!document.querySelector('.star-btn[disabled]')) loadStarRatingResults(); });
Â  Â  Â Â 
Â  Â  Â  // Admin Panel
Â  Â  Â  document.getElementById('save-all-keys-btn').addEventListener('click', saveAllAnswerKeys);
Â  Â  Â  document.getElementById('reset-btn').addEventListener('click', () => resetData('responses', 'Delete all question data?'));
Â  Â  Â  document.getElementById('reset-emoji-btn').addEventListener('click', () => resetData('emojiReactions', 'Delete all emoji reactions?').then(loadEmojiResults));
Â  Â  Â  document.getElementById('reset-stars-btn').addEventListener('click', async () => {
Â  Â  Â  Â  await resetData('starRatings', 'Delete all star ratings?');
Â  Â  Â  Â  await db.collection('settings').doc('starRatingControl').set({ sumOfRatings: 0, totalRatings: 0 }, { merge: true });
Â  Â  Â  Â  updateStarsUI(0); loadStarRatingResults();
Â  Â  Â  });
Â  Â  Â  document.getElementById('reset-yes-no-btn').addEventListener('click', async () => {
Â  Â  Â  Â  await resetData('yesNoVotes', 'Delete all Yes/No survey votes?');
Â  Â  Â  Â  await db.collection('settings').doc('yesNoCounts').set({ yes: 0, no: 0 });
Â  Â  Â  });
Â  Â  Â  document.getElementById('reset-keys-btn').addEventListener('click', async () => {
Â  Â  Â  Â  if (!isAdmin || !confirm('Are you sure you want to reset the entire answer key?')) return;
Â  Â  Â  Â  await db.collection('settings').doc('answerKey').delete();
Â  Â  Â  Â  document.querySelectorAll('.answer-key-input').forEach(input => input.value = '');
Â  Â  Â  Â  alert('Answer key has been reset.');
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  document.getElementById('update-item-count').addEventListener('click', async () => {
Â  Â  Â  Â  const count = parseInt(DOM.itemCountInput.value, 10);
Â  Â  Â  Â  if (count >= 0 && count <= 100) {
Â  Â  Â  Â  Â  await db.collection('settings').doc('surveySettings').set({ visibleItems: count }, { merge: true });
Â  Â  Â  Â  Â  alert(`Visible items updated to ${count}`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("Enter a number between 0 and 100.");
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  document.getElementById('update-top-students-count').addEventListener('click', async () => {
Â  Â  Â  Â  const count = parseInt(DOM.topStudentsCountInput.value, 10);
Â  Â  Â  Â  if (count >= 1 && count <= 50) {
Â  Â  Â  Â  Â  await db.collection('settings').doc('topStudentsCount').set({ count }, { merge: true });
Â  Â  Â  Â  Â  alert(`Top students count updated to ${count}`);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  alert("Enter a number between 1 and 50.");
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  // Admin Toggles
Â  Â  Â  ['global-toggle', 'emoji-visibility-toggle', 'star-visibility-toggle', 'yes-no-visibility-toggle', 'summary-visibility-toggle', 'results-visibility-toggle', 'top-students-visibility-toggle', 'my-score-visibility-toggle'].forEach(id => {
Â  Â  Â  Â  document.getElementById(id).addEventListener('change', (e) => {
Â  Â  Â  Â  Â  if (!isAdmin) return;
Â  Â  Â  Â  Â  const settingsMap = {
Â  Â  Â  Â  Â  Â  'global-toggle': { doc: 'submissionControl', field: 'enabled' },
Â  Â  Â  Â  Â  Â  'emoji-visibility-toggle': { doc: 'emojiSettings', field: 'visible' },
Â  Â  Â  Â  Â  Â  'star-visibility-toggle': { doc: 'starRatingControl', field: 'visible' },
Â  Â  Â  Â  Â  Â  'yes-no-visibility-toggle': { doc: 'yesNoSettings', field: 'visible' },
Â  Â  Â  Â  Â  Â  'summary-visibility-toggle': { doc: 'summarySettings', field: 'visible' },
Â  Â  Â  Â  Â  Â  'results-visibility-toggle': { doc: 'resultsSettings', field: 'visible' },
Â  Â  Â  Â  Â  Â  'top-students-visibility-toggle': { doc: 'summarySettings', field: 'topStudentsVisible' },
Â  Â  Â  Â  Â  Â  'my-score-visibility-toggle': { doc: 'summarySettings', field: 'userScoreVisible' },
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  const { doc, field } = settingsMap[id];
Â  Â  Â  Â  Â  db.collection('settings').doc(doc).set({ [field]: e.target.checked }, { merge: true });
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  };

Â  Â  // --- REAL-TIME LISTENERS ---
Â  Â  const setupRealtimeListeners = () => {
Â  Â  Â  auth.onAuthStateChanged(async user => {
Â  Â  Â  Â  let newIsAdmin = false;
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  DOM.loginMessage.innerText = `Logged in as ${user.email}`;
Â  Â  Â  Â  Â  const adminDoc = await db.collection('admins').doc(user.uid).get();
Â  Â  Â  Â  Â  newIsAdmin = adminDoc.exists;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  DOM.loginMessage.innerText = '';
Â  Â  Â  Â  }
Â  Â  Â  Â  updateAdminUI(newIsAdmin);
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('responses').onSnapshot(snapshot => {
Â  Â  Â  Â  userHasSubmitted = !!snapshot.docs.find(doc => doc.id === userId);
Â  Â  Â  Â  updateSubmitButtonState();
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });

Â  Â  Â  db.collection('settings').doc('submissionControl').onSnapshot(doc => {
Â  Â  Â  Â  const isEnabled = doc.data()?.enabled ?? false;
Â  Â  Â  Â  submissionsGloballyEnabled = isEnabled;
Â  Â  Â  Â  if (isAdmin) DOM.globalToggle.checked = isEnabled;
Â  Â  Â  Â  DOM.globalStatus.innerText = isEnabled ? 'ON' : 'OFF';
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('surveySettings').onSnapshot(doc => {
Â  Â  Â  Â  const count = doc.data()?.visibleItems ?? 5;
Â  Â  Â  Â  renderSurveyItems(count);
Â  Â  Â  Â  if (isAdmin) DOM.itemCountInput.value = count;
Â  Â  Â  Â  DOM.questionsCountStatus.innerText = count;
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('topStudentsCount').onSnapshot(doc => {
Â  Â  Â  Â  const count = doc.data()?.count ?? 10;
Â  Â  Â  Â  if (isAdmin) DOM.topStudentsCountInput.value = count;
Â  Â  Â  Â  DOM.topStudentsCountStatus.innerText = count;
Â  Â  Â  });

Â  Â  Â  // Visibility toggles
Â  Â  Â  const visibilityListeners = {
Â  Â  Â  Â  emojiSettings: { el: DOM.emojiContainer, check: 'emoji-visibility-toggle', stat: 'emoji-status', field: 'visible'},
Â  Â  Â  Â  starRatingControl: { el: DOM.starRatingContainer, check: 'star-visibility-toggle', stat: 'star-status', field: 'visible'},
Â  Â  Â  Â  yesNoSettings: { el: DOM.yesNoSurveyContainer, check: 'yes-no-visibility-toggle', stat: 'yes-no-status', field: 'visible'},
Â  Â  Â  Â  resultsSettings: { el: DOM.resultsContainer, check: 'results-visibility-toggle', stat: 'results-status', field: 'visible'},
Â  Â  Â  };
Â  Â  Â  for(const [docName, conf] of Object.entries(visibilityListeners)) {
Â  Â  Â  Â  db.collection('settings').doc(docName).onSnapshot(doc => {
Â  Â  Â  Â  Â  const isVisible = doc.data()?.[conf.field] ?? false;
Â  Â  Â  Â  Â  conf.el.style.display = isAdmin || isVisible ? 'block' : 'none';
Â  Â  Â  Â  Â  if (isAdmin) document.getElementById(conf.check).checked = isVisible;
Â  Â  Â  Â  Â  document.getElementById(conf.stat).innerText = isVisible ? 'ON' : 'OFF';
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('summarySettings').onSnapshot(doc => {
Â  Â  Â  Â  const data = doc.data() ?? {};
Â  Â  Â  Â  const isVisible = data.visible ?? false;
Â  Â  Â  Â  const topStudentsVisible = data.topStudentsVisible ?? false;
Â  Â  Â  Â  const userScoreVisible = data.userScoreVisible ?? false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  DOM.resultsSummaryContainer.style.display = isAdmin || isVisible ? 'block' : 'none';
Â  Â  Â  Â  DOM.topStudentsContainer.style.display = isAdmin || topStudentsVisible ? 'block' : 'none';
Â  Â  Â  Â  DOM.myScoreContainer.style.display = isAdmin || userScoreVisible ? 'block' : 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  document.getElementById('summary-visibility-toggle').checked = isVisible;
Â  Â  Â  Â  Â  document.getElementById('top-students-visibility-toggle').checked = topStudentsVisible;
Â  Â  Â  Â  Â  document.getElementById('my-score-visibility-toggle').checked = userScoreVisible;
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('summary-status').innerText = isVisible ? 'ON' : 'OFF';
Â  Â  Â  Â  document.getElementById('top-students-status').innerText = topStudentsVisible ? 'ON' : 'OFF';
Â  Â  Â  Â  document.getElementById('my-score-status').innerText = userScoreVisible ? 'ON' : 'OFF';
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('answerKey').onSnapshot(doc => {
Â  Â  Â  Â  if(isAdmin) loadAndApplyAnswerKey();
Â  Â  Â  Â  showAggregatedResults();
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  db.collection('settings').doc('yesNoCounts').onSnapshot(doc => {
Â  Â  Â  Â  const { yes: yesCount = 0, no: noCount = 0 } = doc.data() ?? {};
Â  Â  Â  Â  document.querySelector('.yes-no-btn[data-choice="yes"] .count').innerText = yesCount;
Â  Â  Â  Â  document.querySelector('.yes-no-btn[data-choice="no"] .count').innerText = noCount;
Â  Â  Â  });
Â  Â  };

Â  Â  // --- APP START ---
Â  Â  window.onload = () => {
Â  Â  Â  // Load initial state for non-realtime elements
Â  Â  Â  loadEmojiResults();
Â  Â  Â  checkIfReacted();
Â  Â  Â  loadStarRatingResults();
Â  Â  Â  checkIfStarRated();
Â  Â  Â  checkIfYesNoVoted();

Â  Â  Â  // Set up all event handlers and real-time listeners
Â  Â  Â  bindEventListeners();
Â  Â  Â  setupRealtimeListeners();
Â  Â  };

Â  </script>
</body>
</html>
