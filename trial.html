<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>THE RIGHT CHOICE</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        padding: 20px; 
        overflow-x: hidden; 
        background-color: #f7f9fc; 
        color: #333;
    }
    .container-box {
        background-color: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
    }
    .btn { 
        padding: 10px 20px; 
        margin: 5px; 
        border: 1px solid #ccc; 
        background:#f0f0f0; 
        cursor:pointer; 
        border-radius: 8px;
        transition: background-color 0.3s, transform 0.2s;
    }
    .btn:hover {
        background-color: #e5e5e5;
        transform: translateY(-2px);
    }
    .btn.selected { 
        background:#4CAF50; 
        color:#fff; 
        border-color: #4CAF50;
    }
    #submit-btn {
        background-color: #4CAF50;
        color: white;
        font-weight: bold;
        border: none;
    }
    #submit-btn[disabled] { 
        background:#ccc; 
        color:#666; 
        cursor:not-allowed; 
    }
    #results { 
        padding:15px; 
        background-color: #e8f5e9;
        border: 1px solid #c8e6c9;
        white-space:pre-wrap; 
        font-family:monospace; 
    }
    .bar { color:#4CAF50; }
    .highlight { font-weight:bold; }
    .line { border-top:1px solid #e0e0e0; margin:15px 0; }
    .question-title { color: #388e3c; font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
    .admin-key-input-container {
      display: flex;
      align-items: center;
    }
    .admin-key-input-container input {
      margin-right: 5px;
    }

    #top-controls-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
    }
    #auth-section {
        background-color: #e3f2fd;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #bbdefb;
    }
    #admin-panel {
        display: none; 
        background-color: #fffde7;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border: 1px solid #ffe0b2;
    }
    #admin-panel h4 {
        color: #ff6f00;
        margin-top: 0;
    }
    #admin-panel button {
      display: block;
      margin: 8px 0;
      width: 100%;
    }
    #admin-panel div {
      margin-top: 8px;
      padding: 5px 0;
      border-bottom: 1px dashed #e0e0e0;
    }
    #admin-panel div:last-of-type {
        border-bottom: none;
    }
    .status-text {
        font-weight: bold;
        margin-left: 5px;
        color: #4CAF50;
    }

    .answer-key-input {
      width: 35px; margin-left: 15px; text-align: center; text-transform: uppercase;
      border: 1px solid #ccc; border-radius: 4px; padding: 4px;
    }
    
    .user-input-container {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 10px;
    }
    .user-input-container input {
        padding: 12px; 
        font-size: 16px; 
        border: 1px solid #ccc; 
        border-radius: 8px; 
        flex-grow: 1;
        min-width: 200px;
    }
    #results-summary {
      padding: 15px; 
      background: #f0f4c3; 
      border: 1px solid #cddc39;
      font-family: Arial, sans-serif;
      display: none; 
    }
    #results-summary h3 { margin-top: 0; color: #689f38; }
    #results-summary ol { padding-left: 20px; }
    #results-summary li { margin-bottom: 8px; }

    .correct-answer {
      color: red;
      font-weight: bold;
    }

    #top-students-container, #my-score-container {
      margin-top: 20px;
      padding: 20px;
      background: #e3f2fd;
      border: 1px solid #bbdefb;
      border-radius: 12px;
      display: none;
    }
    #top-students-container h3, #my-score-container h3 {
      margin-top: 0;
      color: #1565c0;
    }
    #top-students-container ul, #my-score-container ul {
      list-style: none;
      padding-left: 0;
    }
    #top-students-container li, #my-score-container li {
        margin-bottom: 8px;
    }
    .correct-icon { color: green; font-weight: bold; }
    .incorrect-icon { color: red; font-weight: bold; }

    #message-box {
        display: none;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        color: #fff;
        text-align: center;
        font-weight: bold;
        transition: opacity 0.5s;
    }
    #message-box.success {
        background-color: #4CAF50;
    }
    #message-box.error {
        background-color: #f44336;
    }

    #statistics-container {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }
    #statistics-container h4 {
        margin-top: 0;
        color: #388e3c;
    }

    /* Styles for the new Group Rating Filter */
    #group-rating-container {
        background-color: #fafafa;
        border: 1px solid #ddd;
    }
    #group-rating-container h3 {
        color: #333;
        margin-top: 0;
        border-bottom: 2px solid #4CAF50;
        padding-bottom: 10px;
    }
    #subject-filter {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        font-size: 1em;
    }
    #group-rating-results ul {
        list-style: none;
        padding: 0;
    }
    #group-rating-results li {
        background-color: #e8f5e9;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        font-weight: bold;
    }
    #group-rating-results .score {
        color: #388e3c;
    }
    
  </style>
</head>

<body>
  <div id="message-box"></div>
  <div style="font-size: 14px; color: black; background: #ffeb3b; padding: 5px; margin-bottom: 10px; border-radius: 8px;">
    Version 1.1.3
  </div>
  <div class="container-box">
    <img src="https://placehold.co/350x165/eeeeee/cccccc?text=Image" onerror="this.onerror=null;this.src='https://placehold.co/350x165/eeeeee/cccccc?text=Image+Not+Found';" width="350" height="165" style="display: block; margin: 0;"/>
  </div>

  <div class="container-box" id="top-controls-wrapper">
    <div id="auth-section">
      <input id="email" type="email" placeholder="Admin Email"/>
      <input id="password" type="password" placeholder="Password"/>
      <button id="login-btn" class="btn">Login</button>
      <button id="logout-btn" class="btn" style="display:none;">Logout</button>
      <p id="login-message"></p>
    </div>
    <div id="admin-panel">
      <h4>Admin Controls</h4>
      <button id="reset-btn" class="btn">Reset Question Data</button>
      <button id="reset-keys-btn" class="btn">Reset Answer Key</button>
      <div id="global-toggle-container">
        <label><input type="checkbox" id="global-toggle" checked/> <strong>Enable Submissions</strong></label>
        <span class="status-text" id="global-status"></span>
      </div>
       <div id="group-container">
        <label><strong>User Group:</strong></label>
        <input type="text" id="group-input" placeholder="e.g., Grade 5"/>
        <button id="save-group-btn" class="btn">Save</button>
        <span class="status-text" id="group-status"></span>
      </div>
      <div id="subject-container">
        <label><strong>Subject:</strong></label>
        <input type="text" id="subject-input" placeholder="e.g., Science"/>
        <button id="save-subject-btn" class="btn">Save</button>
        <span class="status-text" id="subject-status"></span>
      </div>
      <div id="summary-toggle-container">
        <label><input type="checkbox" id="summary-visibility-toggle" checked/> <strong>Show Results Summary</strong></label>
        <span class="status-text" id="summary-status"></span>
      </div>
      <div id="results-toggle-container">
        <label><input type="checkbox" id="results-visibility-toggle" checked/> <strong>Show Raw Results</strong></label>
        <span class="status-text" id="results-status"></span>
      </div>
      <div id="top-students-toggle-container">
        <label><input type="checkbox" id="top-students-visibility-toggle" checked/> <strong>Show Top Students</strong></label>
        <span class="status-text" id="top-students-status"></span>
      </div>
      <div id="my-score-toggle-container">
        <label><input type="checkbox" id="my-score-visibility-toggle" checked/> <strong>Show My Score</strong></label>
        <span class="status-text" id="my-score-status"></span>
      </div>
      <div id="item-count-container">
        <label><strong>Questions to Show:</strong></label>
        <input type="number" id="item-count-input" min="0" max="100" value="5" style="width: 50px;"/>
        <button id="update-item-count" class="btn">Update</button>
        <span class="status-text" id="questions-count-status"></span>
      </div>
      <div id="top-students-count-container">
        <label><strong>Top Students to Show:</strong></label>
        <input type="number" id="top-students-count-input" min="1" max="50" value="10" style="width: 50px;"/>
        <button id="update-top-students-count" class="btn">Update</button>
        <span class="status-text" id="top-students-count-status"></span>
      </div>
      <button id="generate-users-btn" class="btn">Generate 10 Users</button>
      <button id="submit-group-score-btn" class="btn" style="background-color: #0277bd; color: white;">Submit Group Score</button>
    </div>
  </div>

  <div class="container-box" id="info-display" style="display: none;">
      <h3>Survey Information</h3>
      <p><strong>Group:</strong> <span id="display-group"></span></p>
      <p><strong>Subject:</strong> <span id="display-subject"></span></p>
      <div id="statistics-container">
        <h4>Overall Performance</h4>
        <p id="group-score-display" style="font-weight: bold;"></p>
      </div>
  </div>

  <div id="survey-container" class="container-box"></div>
 
  <div id="save-all-keys-container" style="display:none; margin-bottom: 15px;">
    <button id="save-all-keys-btn" class="btn">Save All Answer Keys</button>
  </div>
  
  <!-- MODIFIED: Wrapped inputs in a container for better layout -->
  <div class="user-input-container">
      <input type="text" id="name-input" placeholder="Your Name (Required)" required />
      <input type="text" id="gcash-input" placeholder="G-Cash Number (Optional)" />
  </div>
  <button id="submit-btn" class="btn">Submit</button>

  <div id="results" class="container-box"></div>
  <div id="results-summary" class="container-box"></div>
  <div id="top-students-container" class="container-box"></div>
  <div id="my-score-container" class="container-box"></div>

  <!-- New Group Rating Filter Container -->
  <div id="group-rating-container" class="container-box">
      <h3>Group Performance by Subject</h3>
      <select id="subject-filter">
          <option value="">-- Select a Subject --</option>
      </select>
      <div id="group-rating-results"></div>
  </div>

  <div id="download-container" class="container-box" style="text-align: center; display: none;">
      <button id="download-excel-btn" class="btn">Download Results as Excel (CSV)</button>
  </div>


  <script>
    // --- UPDATED FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
      authDomain: "shamankingdata.firebaseapp.com",
      projectId: "shamankingdata",
      storageBucket: "shamankingdata.appspot.com",
      messagingSenderId: "757444066890",
      appId: "1:757444066890:web:e4f9d41e2905e588d930b3",
      measurementId: "G-DD8SFH6MYD"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();

    let isAdmin = false;
    let submissionsGloballyEnabled = false;
    let userHasSubmitted = false;

    // --- MESSAGE DISPLAY UTILITY ---
    function showMessage(message, type = 'error', duration = 3000) {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = message;
        messageBox.className = type; // 'success' or 'error'
        messageBox.style.display = 'block';

        setTimeout(() => {
            messageBox.style.opacity = '0';
            setTimeout(() => {
                messageBox.style.display = 'none';
                messageBox.style.opacity = '1';
            }, 500);
        }, duration);
    }

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }
    const userId = getUserId();
    
    // --- UTILITY FUNCTIONS ---
    function disableSubmit(text='Already Submitted'){
      const btn=document.getElementById('submit-btn');
      btn.disabled=true; btn.innerText=text;
    }
    function enableSubmit(){
      const btn=document.getElementById('submit-btn');
      btn.disabled=false; btn.innerText='Submit';
    }

    async function updateSubmitButtonState() {
      const userDoc = await db.collection('responses').doc(userId).get();
      userHasSubmitted = userDoc.exists;

      if (!submissionsGloballyEnabled) {
        disableSubmit('Submissions Disabled');
      } else if (userHasSubmitted) {
        disableSubmit('Already Submitted');
      } else {
        enableSubmit();
      }
    }

    // --- SURVEY LOGIC ---
    function renderSurveyItems(count) {
      const container = document.getElementById('survey-container');
      const submitBtn = document.getElementById('submit-btn');
      const saveAllKeysContainer = document.getElementById('save-all-keys-container');
      container.innerHTML = '';

      if (count > 0) {
        submitBtn.style.display = 'inline-block';
        saveAllKeysContainer.style.display = isAdmin ? 'block' : 'none';
      } else {
        submitBtn.style.display = 'none';
        saveAllKeysContainer.style.display = 'none';
      }

      for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'survey-item';
        div.dataset.item = i;
        const inputStyle = isAdmin ? 'flex' : 'none';
        div.innerHTML = `<div class="question-title">Question #${i}</div>
          <button class="btn" data-letter="A">A</button> <button class="btn" data-letter="B">B</button>
          <button class="btn" data-letter="C">C</button> <button class="btn" data-letter="D">D</button>
          <span class="admin-key-input-container" style="display: ${inputStyle};">
            <input type="text" class="answer-key-input" data-item="${i}" placeholder="Key" maxlength="1">
            <button class="btn save-key-btn" data-item="${i}">Save</button>
          </span>`;
        container.appendChild(div);
      }
      document.querySelectorAll('.survey-item .btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
          e.target.classList.add('selected');
        });
      });
      setupAnswerKeyListeners();
    }
    
    function setupAnswerKeyListeners() {
      if (isAdmin) {
        document.querySelectorAll('.save-key-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const item = 'item' + e.target.dataset.item;
            const input = document.querySelector(`.answer-key-input[data-item="${e.target.dataset.item}"]`);
            const value = input.value.trim().toUpperCase();
            if (!['A', 'B', 'C', 'D', ''].includes(value)) {
              showMessage(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
              return;
            }
            const docRef = db.collection('settings').doc('answerKey');
            await docRef.set({ [item]: value }, { merge: true });
            showMessage(`Answer key for Question #${e.target.dataset.item} saved!`, 'success');
          });
        });
      }
    }
    
    async function showAggregatedResults() {
        const settingsDoc = await db.collection('settings').doc('surveySettings').get();
        const visible = (settingsDoc.exists && settingsDoc.data().visibleItems !== undefined) ? settingsDoc.data().visibleItems : 5;
        const currentGroup = (settingsDoc.exists && settingsDoc.data().group) ? settingsDoc.data().group : null;
        const currentSubject = (settingsDoc.exists && settingsDoc.data().subject) ? settingsDoc.data().subject : null;
        
        const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
        const answerKeyData = answerKeyDoc.exists ? answerKeyDoc.data() : {};

        const snapshot = await db.collection('responses').get();

        // Filter the documents on the client based on the current group and subject settings
        const filteredDocs = snapshot.docs.filter(doc => {
            const data = doc.data();
            // --- FIX: Trim whitespace from data before comparing ---
            const groupMatch = currentGroup ? (data.group || '').trim() === currentGroup : true;
            const subjectMatch = currentSubject ? (data.subject || '').trim() === currentSubject : true;
            return groupMatch && subjectMatch;
        });

        const counts = {};
        for (let i = 1; i <= visible; i++) { counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 }; }
        
        // Use the filtered docs to calculate results
        filteredDocs.forEach(doc => {
            const ans = doc.data().answers;
            Object.entries(ans).forEach(([k, v]) => { if (counts[k]?.[v] !== undefined) counts[k][v]++; });
        });

        let max = 1;
        Object.values(counts).forEach(c => Object.values(c).forEach(v => max = Math.max(max, v)));
        let html = '<h3>Results:</h3><pre>';
        for (let i = 1; i <= visible; i++) {
            const itm = counts['item' + i];
            const m = Math.max(...Object.values(itm));
            const correctAnswer = answerKeyData['item' + i];
            html += `Item ${i}:\n`;
            Object.entries(itm).forEach(([ltr, cnt]) => {
            const bar = `<span class="bar">${'█'.repeat((cnt / max) * 20)}</span>`;
            let disp = ltr;
            let classes = [];

            if (cnt === m && cnt > 0) {
                classes.push('highlight');
            }
            if (ltr === correctAnswer) {
                classes.push('correct-answer');
            }
            
            if (classes.length > 0) {
                disp = `<span class="${classes.join(' ')}">${ltr}</span>`;
            }
            
            html += `  ${disp}: ${cnt} ${bar}\n`;
            });
            html += '</pre><div class="line"></div><pre>';
        }
        document.getElementById('results').innerHTML = html + '</pre>';

        const summaryData = [];
        for (let i = 1; i <= visible; i++) {
            const itemCounts = counts['item' + i];
            const correctAnswer = answerKeyData['item' + i];
            if (!correctAnswer) continue;

            const totalVotes = Object.values(itemCounts).reduce((sum, count) => sum + count, 0);
            const correctVotes = itemCounts[correctAnswer] || 0;
            const wrongVotes = totalVotes - correctVotes;
            
            summaryData.push({ questionNumber: i, wrongVotes: wrongVotes });
        }
        summaryData.sort((a, b) => b.wrongVotes - a.wrongVotes);

        let summaryHtml = '<h3>Ranking of Questions by Incorrect Answers:</h3>';
        if (summaryData.length === 0 || !answerKeyDoc.exists) {
            summaryHtml += '<p>An answer key must be set by an admin to see this summary.</p>';
        } else {
            summaryHtml += '<ol>';
            summaryData.forEach(item => {
            summaryHtml += `<li>Question #${item.questionNumber}: <strong>${item.wrongVotes}</strong> incorrect answer(s)</li>`;
            });
            summaryHtml += '</ol>';
        }
        document.getElementById('results-summary').innerHTML = summaryHtml;

        showTopStudentsResults(filteredDocs, answerKeyData);
        showMyScore(answerKeyData);
        calculateAndDisplayStatistics(filteredDocs, answerKeyData);
    }

    function calculateAndDisplayStatistics(docs, answerKey) {
        const groupScoreDisplayEl = document.getElementById('group-score-display');

        if (docs.length === 0 || !answerKey || Object.keys(answerKey).length === 0) {
            groupScoreDisplayEl.innerHTML = '<strong>GROUP SCORE:</strong> N/A';
            return;
        }

        const numQuestions = Object.keys(answerKey).length;
        const scores = docs.map(doc => {
            const userAnswers = doc.data().answers;
            let score = 0;
            for (let i = 1; i <= numQuestions; i++) {
                const itemKey = 'item' + i;
                if (userAnswers[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
                    score++;
                }
            }
            return score;
        });

        scores.sort((a, b) => a - b);

        const startIndex = Math.floor(10 / 100 * scores.length);
        const endIndex = Math.ceil(90 / 100 * scores.length);
        const bracketScores = scores.slice(startIndex, endIndex);

        let bracketAverageText = 'N/A';
        if (bracketScores.length > 0) {
            const bracketTotal = bracketScores.reduce((sum, s) => sum + s, 0);
            const bracketAverage = bracketTotal / bracketScores.length;
            const bracketAveragePercent = (bracketAverage / numQuestions) * 100;
            bracketAverageText = `${bracketAveragePercent.toFixed(2)}`;
        }
        
        groupScoreDisplayEl.innerHTML = `<strong>GROUP SCORE:</strong> ${bracketAverageText}`;
    }

    async function showTopStudentsResults(docs, answerKey) {
        const container = document.getElementById('top-students-container');
        if (!answerKey || Object.keys(answerKey).length === 0) {
            container.innerHTML = '<h3>Top Students</h3><p>An answer key must be set to display student scores.</p>';
            return;
        }

        const scores = [];
        docs.forEach(doc => {
            const userData = doc.data(); // Get all user data
            const userAnswers = userData.answers;
            let score = 0;
            const numQuestions = Object.keys(answerKey).length;
            for (let i = 1; i <= numQuestions; i++) {
                const itemKey = 'item' + i;
                if (userAnswers[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
                    score++;
                }
            }
            scores.push({ 
                name: userData.name, 
                score: score, 
                userId: doc.id,
                gcash: userData.gcash || ''
            });
        });

        scores.sort((a, b) => b.score - a.score);
        
        const topStudentsCountDoc = await db.collection('settings').doc('topStudentsCount').get();
        const topN = (topStudentsCountDoc.exists && topStudentsCountDoc.data().count) ? topStudentsCountDoc.data().count : 10;
        const topStudents = scores.slice(0, topN);

        let html = `<h3>Top ${topN} Students</h3><ul>`;
        topStudents.forEach((student, index) => {
            if (isAdmin) {
                const gcashDisplay = student.gcash ? ` <br><small>G-Cash: ${student.gcash}</small>` : '';
                html += `<li>Rank #${index + 1}: <input type="text" value="${student.name}" data-userid="${student.userId}"/> Score: ${student.score} <button data-userid="${student.userId}">Save</button>${gcashDisplay}</li>`;
            } else {
                html += `<li>Rank #${index + 1}: ${student.name} - Score: ${student.score}</li>`;
            }
        });
        html += '</ul>';
        container.innerHTML = html;

        if (isAdmin) {
          container.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const userId = e.target.dataset.userid;
              const newName = e.target.parentElement.querySelector('input').value;
              await db.collection('responses').doc(userId).update({ name: newName });
              showMessage('Name updated!', 'success');
            });
          });
        }
    }

    async function showMyScore(answerKey) {
        const container = document.getElementById('my-score-container');
        const userDoc = await db.collection('responses').doc(userId).get();
        if (!userDoc.exists) {
            container.innerHTML = '<h3>My Score</h3><p>Submit your answers to see your score.</p>';
            return;
        }
        
        const userAnswers = userDoc.data().answers;
        if (!answerKey || Object.keys(answerKey).length === 0) {
            container.innerHTML = '<h3>My Score</h3><p>An answer key must be set to calculate your score.</p>';
            return;
        }

        let score = 0;
        let summaryHtml = '<h3>My Score</h3>';
        let answerListHtml = '<ul>';
        
        const sortedKeys = Object.keys(answerKey).sort((a, b) => {
            const numA = parseInt(a.replace('item', ''), 10);
            const numB = parseInt(b.replace('item', ''), 10);
            return numA - numB;
        });

        sortedKeys.forEach((itemKey, index) => {
            const questionNumber = index + 1;
            const userAnswer = userAnswers[itemKey];
            const correctAnswer = answerKey[itemKey];
            let icon = '❌';
            let iconClass = 'incorrect-icon';

            if (userAnswer && userAnswer === correctAnswer) {
                score++;
                icon = '✅';
                iconClass = 'correct-icon';
            }
            answerListHtml += `<li>Question #${questionNumber}: Your answer was ${userAnswer || 'N/A'} <span class="${iconClass}">${icon}</span></li>`;
        });
        
        answerListHtml += '</ul>';
        summaryHtml += `<p>Your Final Score: <strong>${score}</strong></p>`;
        summaryHtml += `<h4>Answer Summary:</h4>`;
        summaryHtml += answerListHtml;
        container.innerHTML = summaryHtml;
    }

    async function generateTestUsers(numUsers) {
      if (!isAdmin) {
        return;
      }
      
      const settingsDoc = await db.collection('settings').doc('surveySettings').get();
      const settingsData = settingsDoc.exists ? settingsDoc.data() : {};
      const visibleItems = settingsData.visibleItems || 5;
      const currentGroup = settingsData.group || 'Test Group';
      const currentSubject = settingsData.subject || 'Test Subject';

      const letters = ['A', 'B', 'C', 'D'];
      const batches = [];

      for (let i = 0; i < numUsers; i++) {
        const userRef = db.collection('responses').doc('test_user_' + Date.now() + i);
        const userName = 'Test User ' + (i + 1);
        const answers = {};
        for (let j = 1; j <= visibleItems; j++) {
          answers['item' + j] = letters[Math.floor(Math.random() * letters.length)];
        }
        batches.push(userRef.set({ 
            name: userName, 
            answers, 
            group: currentGroup,
            subject: currentSubject,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() 
        }));
      }
      
      await Promise.all(batches);
      showMessage(`${numUsers} test users generated for group '${currentGroup}' and subject '${currentSubject}'.`, 'success');
    }
    
    async function saveAllAnswerKeys() {
        if (!isAdmin) {
            return;
        }

        const answerKey = {}; 
        const validLetters = ['A', 'B', 'C', 'D', '']; 
        let allValid = true;

        document.querySelectorAll('.answer-key-input').forEach(input => {
            const item = 'item' + input.dataset.item; 
            const value = input.value.trim().toUpperCase();

            if (!validLetters.includes(value)) {
                allValid = false;
                showMessage(`Invalid answer '${value}'. Please use only A, B, C, or D.`);
                input.focus();
            }
            answerKey[item] = value;
        });

        if (!allValid) {
            return;
        }

        try {
            await db.collection('settings').doc('answerKey').set(answerKey);
            showMessage('Answer key for all questions saved successfully!', 'success'); 
            showAggregatedResults();
        } catch (e) {
            console.error('Error saving answer key:', e); 
            showMessage('Failed to save answer key.');
        }
    }

    async function downloadResultsAsCSV() {
        if (!isAdmin) {
            showMessage('This feature is for admins only.');
            return;
        }

        try {
            const responsesSnap = await db.collection('responses').get();
            const answerKeyDoc = await db.collection('settings').doc('answerKey').get();
            const surveySettingsDoc = await db.collection('settings').doc('surveySettings').get();

            if (!answerKeyDoc.exists || Object.keys(answerKeyDoc.data()).length === 0) {
                showMessage('Cannot generate report. An answer key must be set first.');
                return;
            }
            
            const settingsData = surveySettingsDoc.exists ? surveySettingsDoc.data() : {};
            const currentGroup = settingsData.group || null;
            const currentSubject = settingsData.subject || null;
            const numQuestions = settingsData.visibleItems || Object.keys(answerKeyDoc.data()).length;
            const answerKey = answerKeyDoc.data();

            const filteredDocs = responsesSnap.docs.filter(doc => {
                const data = doc.data();
                const groupMatch = currentGroup ? data.group === currentGroup : true;
                const subjectMatch = currentSubject ? data.subject === currentSubject : true;
                return groupMatch && subjectMatch;
            });

            if (filteredDocs.length === 0) {
                showMessage('No data found for the current Group and Subject to download.');
                return;
            }

            let studentData = [];
            filteredDocs.forEach(doc => {
                const response = doc.data();
                const userAnswers = response.answers || {};
                let score = 0;

                for (let i = 1; i <= numQuestions; i++) {
                    const itemKey = 'item' + i;
                    if (answerKey[itemKey] && userAnswers[itemKey] === answerKey[itemKey]) {
                        score++;
                    }
                }
                studentData.push({
                    name: response.name,
                    score: score,
                    answers: userAnswers,
                    group: response.group,
                    subject: response.subject
                });
            });

            studentData.sort((a, b) => b.score - a.score);

            const headers = ["Rank", "Name", "Total Score", "Group", "Subject"];
            for (let i = 1; i <= numQuestions; i++) {
                headers.push(`Item ${i}`);
            }
            let csvRows = [headers.join(",")];

            studentData.forEach((student, index) => {
                const rank = index + 1;
                const name = `"${student.name.replace(/"/g, '""')}"`;
                const row = [rank, name, student.score, student.group, student.subject];

                for (let i = 1; i <= numQuestions; i++) {
                    const itemKey = 'item' + i;
                    const userAnswer = student.answers[itemKey] || "N/A";
                    const correctAnswer = answerKey[itemKey];
                    let cellValue = userAnswer;

                    if (userAnswer !== "N/A" && correctAnswer) {
                        const isCorrect = userAnswer === correctAnswer;
                        cellValue = `${userAnswer} (${isCorrect ? 'Correct' : 'Wrong'})`;
                    }
                    row.push(`"${cellValue}"`);
                }
                csvRows.push(row.join(","));
            });

            const csvString = csvRows.join("\r\n");
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const filename = `scores_${currentGroup || 'all'}_${currentSubject || 'all'}.csv`;
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error("Error downloading CSV:", error);
            showMessage("Failed to download results. See console for details.");
        }
    }
    
    // --- NEW: GROUP RATING FILTER LOGIC ---
    function setupGroupRatingFilter() {
        const subjectFilter = document.getElementById('subject-filter');
        const resultsContainer = document.getElementById('group-rating-results');
        let allRatings = []; // Cache for holding all rating data

        db.collection('groupRating').onSnapshot(snapshot => {
            allRatings = snapshot.docs.map(doc => doc.data());

            // Get unique subjects and populate the dropdown
            const subjects = [...new Set(allRatings.map(item => item.subject))];
            subjectFilter.innerHTML = '<option value="">-- Select a Subject --</option>'; // Reset
            subjects.forEach(subject => {
                if(subject) { // Ensure subject is not null or empty
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilter.appendChild(option);
                }
            });

            // Trigger change to display data for the initially selected item (if any)
            subjectFilter.dispatchEvent(new Event('change'));
        });

        subjectFilter.addEventListener('change', () => {
            const selectedSubject = subjectFilter.value;
            resultsContainer.innerHTML = ''; // Clear previous results

            if (!selectedSubject) {
                return; // Do nothing if no subject is selected
            }

            const filteredRatings = allRatings
                .filter(rating => rating.subject === selectedSubject)
                .sort((a, b) => b.groupScore - a.groupScore); // Sort by score descending

            if (filteredRatings.length === 0) {
                resultsContainer.innerHTML = '<p>No scores found for this subject.</p>';
                return;
            }

            const ul = document.createElement('ul');
            filteredRatings.forEach(rating => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${rating.group}</span>
                    <span class="score">${rating.groupScore.toFixed(2)}</span>
                `;
                ul.appendChild(li);
            });
            resultsContainer.appendChild(ul);
        });
    }


    // --- ADMIN UTILITIES ---
    async function resetData(collectionName, confirmationMsg) {
      // Using a simple check here since confirm() is not available.
      // A proper modal would be needed for a real confirmation.
      if (!isAdmin) return;
      console.warn(`Bypassing confirmation for: ${confirmationMsg}`);
      
      const snapshot = await db.collection(collectionName).get();
      if (snapshot.empty) {
        showMessage(`No data to delete in ${collectionName}.`, 'success');
        return;
      }
      const batch = db.batch(); snapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit(); 
      showMessage(`${collectionName} data deleted.`, 'success');
    }

    // --- EVENT LISTENERS ---
    document.getElementById('update-item-count').addEventListener('click', async () => {
      const count = parseInt(document.getElementById('item-count-input').value, 10);
      if (count < 0 || count > 100) return showMessage("Enter a number between 0 and 100.");
      await db.collection('settings').doc('surveySettings').set({ visibleItems: count }, { merge: true });
      showMessage(`Visible items updated to ${count}`, 'success');
    });
    
    document.getElementById('update-top-students-count').addEventListener('click', async () => {
      const count = parseInt(document.getElementById('top-students-count-input').value, 10);
      if (count < 1 || count > 50) return showMessage("Enter a number between 1 and 50.");
      await db.collection('settings').doc('topStudentsCount').set({ count: count }, { merge: true });
      showMessage(`Top students count updated to ${count}`, 'success');
    });
    
    document.getElementById('reset-keys-btn').addEventListener('click', async () => {
      if (!isAdmin) return;
      try {
        await db.collection('settings').doc('answerKey').delete();
        document.querySelectorAll('.answer-key-input').forEach(input => { input.value = ''; });
        showMessage('Answer key has been successfully reset.', 'success'); 
        showAggregatedResults();
      } catch (e) { console.error('Error resetting answer key:', e); showMessage('Failed to reset the answer key.'); }
    });
    
    document.getElementById('save-all-keys-btn').addEventListener('click', saveAllAnswerKeys);

    document.getElementById('save-group-btn').addEventListener('click', async () => {
      if (!isAdmin) return;
      const group = document.getElementById('group-input').value.trim(); // Trim whitespace
      await db.collection('settings').doc('surveySettings').set({ group: group }, { merge: true });
      showMessage('User Group saved!', 'success');
    });

    document.getElementById('save-subject-btn').addEventListener('click', async () => {
      if (!isAdmin) return;
      const subject = document.getElementById('subject-input').value.trim(); // Trim whitespace
      await db.collection('settings').doc('surveySettings').set({ subject: subject }, { merge: true });
      showMessage('Subject saved!', 'success');
    });

    document.getElementById('submit-group-score-btn').addEventListener('click', async () => {
        if (!isAdmin) return;
        const group = document.getElementById('display-group').textContent.trim();
        const subject = document.getElementById('display-subject').textContent.trim();
        const groupScoreText = document.getElementById('group-score-display').textContent;
        
        if (!group || group === 'N/A' || !subject || subject === 'N/A') {
            showMessage('Please set a Group and Subject before submitting the score.');
            return;
        }

        const scoreValue = groupScoreText.replace('GROUP SCORE:', '').trim();
        if (scoreValue === 'N/A') {
            showMessage('Group Score has not been calculated yet.');
            return;
        }

        try {
            const querySnapshot = await db.collection('groupRating')
                .where('group', '==', group)
                .where('subject', '==', subject)
                .get();

            const dataToSave = {
                group: group,
                subject: subject,
                groupScore: parseFloat(scoreValue),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (!querySnapshot.empty) {
                const docId = querySnapshot.docs[0].id;
                await db.collection('groupRating').doc(docId).update(dataToSave);
                showMessage('Group score updated successfully!', 'success');
            } else {
                await db.collection('groupRating').add(dataToSave);
                showMessage('Group score submitted successfully!', 'success');
            }
        } catch (error) {
            console.error("Error submitting/updating group score: ", error);
            showMessage('Failed to submit/update group score.');
        }
    });

    document.getElementById('global-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('submissionControl').set({ enabled: e.target.checked }); });
    document.getElementById('summary-toggle-container').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('summarySettings').set({ visible: e.target.checked }, { merge: true }); });
    document.getElementById('results-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('resultsSettings').set({ visible: e.target.checked }, { merge: true }); });
    document.getElementById('top-students-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('summarySettings').set({ topStudentsVisible: e.target.checked }, { merge: true }); });
    document.getElementById('my-score-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('summarySettings').set({ userScoreVisible: e.target.checked }, { merge: true }); });
    document.getElementById('generate-users-btn').addEventListener('click', async () => { await generateTestUsers(10); showAggregatedResults(); });
    document.getElementById('download-excel-btn').addEventListener('click', downloadResultsAsCSV);

    document.getElementById('reset-btn').addEventListener('click', () => resetData('responses', 'Delete all question data?'));

    document.getElementById('submit-btn').addEventListener('click', async () => {
      if (!submissionsGloballyEnabled) return showMessage("Submissions are currently disabled.");
      const doc = await db.collection('responses').doc(userId).get();
      if (doc.exists) return showMessage("You have already submitted.");
      const nameInput = document.getElementById('name-input'); const userName = nameInput.value.trim();
      if (!userName) { showMessage('Please enter your name before submitting.'); nameInput.focus(); return; }
      
      const gcashInput = document.getElementById('gcash-input');
      const gcashNumber = gcashInput.value.trim();

      const groupText = document.getElementById('display-group').textContent.trim();
      const subjectText = document.getElementById('display-subject').textContent.trim();
      
      const answers = {}; const items = document.querySelectorAll('.survey-item');
      items.forEach(item => {
        const sel = item.querySelector('.btn.selected');
        if (sel) answers['item' + item.dataset.item] = sel.dataset.letter;
      });
      await db.collection('responses').doc(userId).set({ 
          name: userName, 
          gcash: gcashNumber,
          answers,
          group: groupText,
          subject: subjectText,
          timestamp: firebase.firestore.FieldValue.serverTimestamp() 
      });
      showMessage("Thanks for your submission, " + userName + "!", 'success'); 
      showAggregatedResults();
    });

    // --- AUTH & INITIALIZATION ---
    auth.onAuthStateChanged(async user => {
      const adminPanel = document.getElementById('admin-panel'); let newIsAdmin = false;
      if (user) {
        document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (adminDoc.exists) { newIsAdmin = true; }
      } else { document.getElementById('login-message').innerText = ''; }
      isAdmin = newIsAdmin;
      adminPanel.style.display = isAdmin ? 'block' : 'none';
      document.getElementById('download-container').style.display = isAdmin ? 'block' : 'none';
      document.getElementById('login-btn').style.display = isAdmin ? 'none' : 'inline';
      document.getElementById('logout-btn').style.display = isAdmin ? 'inline' : 'none';
      document.querySelectorAll('.admin-key-input-container').forEach(input => { input.style.display = isAdmin ? 'flex' : 'none'; });
      document.getElementById('save-all-keys-container').style.display = isAdmin ? 'block' : 'none';

      if (isAdmin) {
        const keyDoc = await db.collection('settings').doc('answerKey').get();
        if (keyDoc.exists) {
          const keyData = keyDoc.data();
          document.querySelectorAll('.answer-key-input').forEach(input => {
            const itemKey = 'item' + input.dataset.item;
            if (document.activeElement !== input) { input.value = keyData[itemKey] || ''; }
          });
        }
      }
      setupAnswerKeyListeners();
    });
    document.getElementById('login-btn').addEventListener('click', () => {
        auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value)
            .catch(e => showMessage("Login failed: " + e.message))
    });
    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

    function setupRealtimeListeners() {
      db.collection('responses').onSnapshot(snapshot => {
        showAggregatedResults();
        const userDoc = snapshot.docs.find(doc => doc.id === userId);
        userHasSubmitted = !!userDoc;
        updateSubmitButtonState();
      });

      db.collection('settings').doc('submissionControl').onSnapshot(doc => {
        const isEnabled = doc.exists && doc.data().enabled === true;
        submissionsGloballyEnabled = isEnabled; 
        if (isAdmin) { document.getElementById('global-toggle').checked = isEnabled; }
        document.getElementById('global-status').innerText = isEnabled ? 'ON' : 'OFF';
      });

      db.collection('settings').doc('surveySettings').onSnapshot(doc => {
        const count = (doc.exists && doc.data().visibleItems !== undefined) ? doc.data().visibleItems : 5;
        const group = (doc.exists && doc.data().group) ? doc.data().group : '';
        const subject = (doc.exists && doc.data().subject) ? doc.data().subject : '';
        
        const infoDisplay = document.getElementById('info-display');
        const displayGroup = document.getElementById('display-group');
        const displaySubject = document.getElementById('display-subject');

        if(group || subject) {
            displayGroup.textContent = group || 'N/A';
            displaySubject.textContent = subject || 'N/A';
            infoDisplay.style.display = 'block';
        } else {
            infoDisplay.style.display = 'none';
        }

        renderSurveyItems(count);
        document.getElementById('questions-count-status').innerText = count;
        if (isAdmin) { 
          document.getElementById('item-count-input').value = count; 
          document.getElementById('group-input').value = group;
          document.getElementById('subject-input').value = subject;
          document.getElementById('group-status').innerText = group;
          document.getElementById('subject-status').innerText = subject;
        }
        setupAnswerKeyListeners();
        showAggregatedResults();
      });

      db.collection('settings').doc('summarySettings').onSnapshot(doc => {
        const isVisible = doc.exists && doc.data().visible === true;
        const topStudentsVisible = doc.exists && doc.data().topStudentsVisible === true;
        const userScoreVisible = doc.exists && doc.data().userScoreVisible === true;
        
        document.getElementById('results-summary').style.display = (isAdmin || isVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('summary-visibility-toggle').checked = isVisible; }
        document.getElementById('summary-status').innerText = isVisible ? 'ON' : 'OFF';
        
        document.getElementById('top-students-container').style.display = (isAdmin || topStudentsVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('top-students-visibility-toggle').checked = topStudentsVisible; }
        document.getElementById('top-students-status').innerText = topStudentsVisible ? 'ON' : 'OFF';

        document.getElementById('my-score-container').style.display = (isAdmin || userScoreVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('my-score-visibility-toggle').checked = userScoreVisible; }
        document.getElementById('my-score-status').innerText = userScoreVisible ? 'ON' : 'OFF';
      });
      
      db.collection('settings').doc('topStudentsCount').onSnapshot(doc => {
        const count = (doc.exists && doc.data().count) ? doc.data().count : 10;
        if (isAdmin) { document.getElementById('top-students-count-input').value = count; }
        document.getElementById('top-students-count-status').innerText = count;
        showAggregatedResults();
      });

      db.collection('settings').doc('resultsSettings').onSnapshot(doc => {
        const isVisible = doc.exists && doc.data().visible === true;
        document.getElementById('results').style.display = (isAdmin || isVisible) ? 'block' : 'none';
        if (isAdmin) { document.getElementById('results-visibility-toggle').checked = isVisible; }
        document.getElementById('results-status').innerText = isVisible ? 'ON' : 'OFF';
      });

      db.collection('settings').doc('answerKey').onSnapshot(doc => {
        if (isAdmin && doc.exists) {
          const answerKeyData = doc.data();
          document.querySelectorAll('.answer-key-input').forEach(input => {
            const itemKey = 'item' + input.dataset.item;
            if (document.activeElement !== input) { input.value = answerKeyData[itemKey] || ''; }
          });
        }
        showAggregatedResults();
      });
    }

    window.onload = () => {
      setupRealtimeListeners();
      setupGroupRatingFilter(); // Initialize the new filter feature
    };
  </script>
</body>
</html>
